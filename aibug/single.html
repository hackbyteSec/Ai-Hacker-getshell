<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <title>单站渗透扫描 - XHSecTeam</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../static/css/common.css">
    <script src="../static/css/common.js"></script>
    <script src="../static/js/layout.js"></script>
    <style>
        /* 单站渗透页面特有样式 */
        .single-layout {
            display: grid;
            grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
            gap: 20px;
            margin-top: 4px;
        }
        .single-card,
        .single-result-card {
            background: rgba(255, 255, 255, 0.78);
            border-radius: 16px;
            border: 1px solid rgba(148, 163, 184, 0.22);
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.04);
            padding: 18px 18px 16px;
        }
        .single-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 12px;
        }
        .single-card-header-right {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 0 0 auto;
        }
        .server-selector {
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .server-selector-btn {
            height: 24px;
            padding: 0 10px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.26);
            background: rgba(248, 250, 252, 0.8);
            color: #334155;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.04em;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }
        .server-selector-btn:hover {
            border-color: rgba(148, 163, 184, 0.34);
            background: rgba(248, 250, 252, 0.92);
        }
        .server-selector-btn .mini-dot {
            width: 6px;
            height: 6px;
            border-radius: 999px;
            background: rgba(16, 185, 129, 1);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.16);
        }
        .server-popover {
            position: absolute;
            top: 36px;
            left: 0;
            width: 320px;
            max-width: 72vw;
            border-radius: 14px;
            border: 1px solid rgba(148, 163, 184, 0.22);
            background: rgba(255, 255, 255, 0.92);
            box-shadow: 0 18px 54px rgba(15, 23, 42, 0.12);
            padding: 10px;
            display: none;
            z-index: 1200;
        }
        .server-popover.active { display: block; }
        .server-popover-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 10px;
        }
        .server-popover-title {
            font-size: 12px;
            font-weight: 700;
            color: #0f172a;
        }
        .server-popover-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .server-mini-btn {
            height: 26px;
            padding: 0 10px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.22);
            background: rgba(248, 250, 252, 0.9);
            color: #334155;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
        }
        .server-mini-btn:hover { border-color: rgba(148, 163, 184, 0.34); }
        .server-list {
            max-height: 240px;
            overflow-y: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .server-list::-webkit-scrollbar { display: none; }
        .server-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 8px 10px;
            border-radius: 12px;
            border: 1px solid rgba(226, 232, 240, 0.9);
            background: rgba(255, 255, 255, 0.86);
            margin-bottom: 8px;
        }
        .server-item-left {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 0;
        }
        .server-check {
            width: 16px;
            height: 16px;
            accent-color: var(--accent-green);
            cursor: pointer;
            flex: 0 0 auto;
        }
        .server-label {
            font-size: 12px;
            font-weight: 700;
            color: #0f172a;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .server-meta {
            font-size: 11px;
            color: var(--text-tertiary);
            flex: 0 0 auto;
        }

        .bottom-zone {
            margin-top: 18px;
            border-radius: 16px;
            border: 1px solid rgba(148, 163, 184, 0.22);
            background: rgba(255, 255, 255, 0.78);
            box-shadow: 0 14px 40px rgba(15, 23, 42, 0.08);
            overflow: hidden;
        }
        .bottom-zone-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 14px 18px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.20);
            background: linear-gradient(180deg, rgba(248, 250, 252, 0.92), rgba(255, 255, 255, 0.65));
        }
        .bottom-zone-title {
            font-size: 13px;
            font-weight: 700;
            color: #0f172a;
        }
        .bottom-zone-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .bottom-zone-btn {
            height: 30px;
            padding: 0 12px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.22);
            background: rgba(248, 250, 252, 0.9);
            color: #334155;
            font-size: 11px;
            font-weight: 800;
            cursor: pointer;
            letter-spacing: 0.04em;
        }
        .bottom-zone-btn:hover { border-color: rgba(148, 163, 184, 0.34); }
        .bottom-zone-body {
            display: grid;
            grid-template-columns: minmax(0, 0.6fr) minmax(0, 1.4fr);
            gap: 14px;
            padding: 14px;
        }
        .log-panel {
            border-radius: 16px;
            border: 1px solid rgba(148, 163, 184, 0.20);
            background: rgba(255, 255, 255, 0.86);
            box-shadow: 0 10px 26px rgba(15, 23, 42, 0.06);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 320px;
        }
        .log-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 12px 14px;
            border-bottom: 1px solid rgba(226, 232, 240, 0.9);
            background: rgba(248, 250, 252, 0.7);
            flex-shrink: 0;
        }
        .log-panel-title {
            font-size: 12px;
            font-weight: 800;
            color: #0f172a;
        }
        .log-panel-sub {
            font-size: 11px;
            color: var(--text-tertiary);
        }
        .log-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px 12px 6px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .log-list::-webkit-scrollbar { display: none; }
        .log-item {
            border-radius: 14px;
            border: 1px solid rgba(226, 232, 240, 0.9);
            background: rgba(255, 255, 255, 0.88);
            padding: 10px 10px;
            margin-bottom: 10px;
        }
        .log-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 6px;
        }
        .log-title {
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 0;
        }
        .log-dot {
            width: 8px;
            height: 8px;
            border-radius: 999px;
            flex: 0 0 auto;
        }
        .log-dot.ok { background: #22c55e; }
        .log-dot.fail { background: #ef4444; }
        .log-dot.run { background: #f59e0b; }
        .log-type {
            font-size: 12px;
            font-weight: 800;
            color: #0f172a;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .log-time {
            font-size: 11px;
            color: var(--text-tertiary);
            flex: 0 0 auto;
            white-space: nowrap;
        }
        .log-target {
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 700;
            margin-bottom: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .log-desc {
            font-size: 11px;
            color: var(--text-tertiary);
            line-height: 1.5;
        }
        .vuln-panels {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 12px;
            height: 320px;
        }
        .vuln-cat {
            border-radius: 16px;
            border: 1px solid rgba(148, 163, 184, 0.20);
            background: rgba(255, 255, 255, 0.86);
            box-shadow: 0 10px 26px rgba(15, 23, 42, 0.06);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-width: 0;
            height: 100%;
        }
        .vuln-cat-header {
            padding: 12px 14px;
            border-bottom: 1px solid rgba(226, 232, 240, 0.9);
            background: rgba(248, 250, 252, 0.7);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            flex-shrink: 0;
        }
        .vuln-cat-title {
            font-size: 12px;
            font-weight: 900;
            color: #0f172a;
        }
        .vuln-cat-badge {
            font-size: 10px;
            padding: 2px 10px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.18);
            background: rgba(248, 250, 252, 0.92);
            color: #334155;
            font-weight: 800;
            letter-spacing: 0.06em;
        }
        .vuln-cat-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px 12px 6px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .vuln-cat-list::-webkit-scrollbar { display: none; }
        .vuln-row {
            border-radius: 14px;
            border: 1px solid rgba(226, 232, 240, 0.9);
            background: rgba(255, 255, 255, 0.88);
            padding: 10px 10px;
            margin-bottom: 10px;
        }
        .vuln-row-name {
            font-size: 12px;
            font-weight: 900;
            color: #0f172a;
            margin-bottom: 6px;
        }
        .vuln-row-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            font-size: 11px;
            color: var(--text-tertiary);
            margin-bottom: 6px;
        }
        .vuln-chip {
            padding: 3px 10px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.20);
            background: rgba(248, 250, 252, 0.75);
            color: #334155;
            font-weight: 700;
        }
        .vuln-row-desc {
            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.55;
        }

        /* 已扫描目标板块 */
        .targets-zone {
            margin-top: 18px;
            border-radius: 16px;
            border: 1px solid rgba(148, 163, 184, 0.22);
            background: rgba(255, 255, 255, 0.78);
            box-shadow: 0 14px 40px rgba(15, 23, 42, 0.08);
            overflow: hidden;
        }
        .targets-zone-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 14px 18px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.20);
            background: linear-gradient(180deg, rgba(248, 250, 252, 0.92), rgba(255, 255, 255, 0.65));
        }
        .targets-zone-title {
            font-size: 13px;
            font-weight: 700;
            color: #0f172a;
        }
        .targets-zone-sub {
            font-size: 11px;
            color: var(--text-tertiary);
            margin-top: 2px;
        }
        .targets-zone-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .targets-list {
            padding: 14px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 600px;
            overflow-y: auto;
        }
        .targets-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-tertiary);
            font-size: 13px;
        }
        .target-card {
            border-radius: 14px;
            border: 1px solid rgba(148, 163, 184, 0.20);
            background: rgba(255, 255, 255, 0.9);
            overflow: hidden;
        }
        .target-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 12px 14px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .target-header:hover {
            background: rgba(248, 250, 252, 0.8);
        }
        .target-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 0;
            flex: 1;
        }
        .target-expand-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-tertiary);
            transition: transform 0.2s;
        }
        .target-expand-icon svg {
            width: 14px;
            height: 14px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
        }
        .target-card.expanded .target-expand-icon {
            transform: rotate(90deg);
        }
        .target-type-badge {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 999px;
            font-weight: 700;
            letter-spacing: 0.04em;
            flex-shrink: 0;
        }
        .target-type-badge.main {
            background: rgba(16, 185, 129, 0.12);
            color: #059669;
            border: 1px solid rgba(16, 185, 129, 0.25);
        }
        .target-type-badge.sub {
            background: rgba(59, 130, 246, 0.12);
            color: #2563eb;
            border: 1px solid rgba(59, 130, 246, 0.25);
        }
        .target-url {
            font-size: 13px;
            font-weight: 600;
            color: #0f172a;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .target-stats {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }
        .target-stat {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.18);
            background: rgba(248, 250, 252, 0.9);
        }
        .target-stat-dot {
            width: 6px;
            height: 6px;
            border-radius: 999px;
        }
        .target-stat-dot.high { background: #ef4444; }
        .target-stat-dot.medium { background: #f59e0b; }
        .target-stat-dot.info { background: #94a3b8; }
        .target-body {
            display: none;
            border-top: 1px solid rgba(148, 163, 184, 0.15);
            padding: 14px;
            background: rgba(248, 250, 252, 0.5);
        }
        .target-card.expanded .target-body {
            display: block;
        }
        .target-vuln-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .target-vuln-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(226, 232, 240, 0.9);
        }
        .target-vuln-severity {
            width: 6px;
            height: 6px;
            border-radius: 999px;
            flex-shrink: 0;
            margin-top: 5px;
        }
        .target-vuln-severity.high { background: #ef4444; }
        .target-vuln-severity.medium { background: #f59e0b; }
        .target-vuln-severity.info { background: #94a3b8; }
        .target-vuln-content {
            flex: 1;
            min-width: 0;
        }
        .target-vuln-name {
            font-size: 12px;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 2px;
        }
        .target-vuln-path {
            font-size: 11px;
            color: var(--accent-cyan);
            font-family: 'SF Mono', Monaco, Consolas, monospace;
            margin-bottom: 4px;
        }
        .target-vuln-desc {
            font-size: 11px;
            color: var(--text-tertiary);
            line-height: 1.4;
        }
        .target-more-link {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px;
            margin-top: 8px;
            border-radius: 10px;
            background: rgba(16, 185, 129, 0.08);
            color: var(--accent-green);
            font-size: 12px;
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            transition: background 0.2s;
        }
        .target-more-link:hover {
            background: rgba(16, 185, 129, 0.15);
        }
        .target-summary {
            display: flex;
            gap: 16px;
            padding: 10px 12px;
            margin-bottom: 10px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(226, 232, 240, 0.9);
        }
        .target-summary-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .target-summary-label {
            font-size: 10px;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .target-summary-value {
            font-size: 14px;
            font-weight: 800;
            color: #0f172a;
        }

        @media (max-width: 1100px) {
            .bottom-zone-body {
                grid-template-columns: 1fr;
            }
            .vuln-panels {
                grid-template-columns: 1fr;
            }
        }
        @media (max-width: 520px) {
            .server-popover {
                width: 92vw;
            }
        }

        .single-card-title {
            font-size: 16px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .single-card-title-pill {
            font-size: 11px;
            padding: 3px 10px;
            border-radius: 999px;
            border: 1px solid rgba(59, 130, 246, 0.7);
            background: #eff6ff;
            color: #1d4ed8;
            letter-spacing: 0.08em;
        }
        .single-card-sub {
            font-size: 12px;
            color: var(--text-tertiary);
        }
        .single-form-row {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .single-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }
        .single-input,
        .single-select {
            width: 100%;
            padding: 9px 12px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background: #ffffff;
            color: var(--text-primary);
            font-size: 13px;
            outline: none;
        }
        .single-input::placeholder {
            color: var(--text-tertiary);
        }
        .single-input:focus,
        .single-select:focus {
            border-color: var(--accent-green);
            box-shadow: 0 0 0 1px rgba(16, 185, 129, 0.25);
        }
        .single-hint {
            font-size: 11px;
            color: var(--text-tertiary);
            margin-top: 4px;
        }
        .single-checkbox-row {
            margin-top: 14px;
            margin-bottom: 4px;
        }
        .single-checkbox-label {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            user-select: none;
        }
        .single-checkbox {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 2px solid rgba(148, 163, 184, 0.4);
            background: transparent;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .single-checkbox:hover {
            border-color: rgba(16, 185, 129, 0.5);
        }
        .single-checkbox:checked {
            border-color: #10b981;
            background: linear-gradient(135deg, #22c55e, #10b981);
            box-shadow: 0 2px 6px rgba(16, 185, 129, 0.4);
        }
        .single-checkbox-text {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        .single-actions {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }
        .single-btn {
            min-width: 96px;
            height: 32px;
            border-radius: 999px;
            border: 1px solid transparent;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0 14px;
        }
        .single-btn-primary {
            background: var(--accent-green);
            border-color: var(--accent-green);
            color: #ffffff;
            box-shadow: 0 10px 24px rgba(16, 185, 129, 0.25);
        }
        .single-btn-primary:disabled {
            opacity: 0.6;
            cursor: default;
            box-shadow: none;
        }
        .single-btn-secondary {
            background: #f9fafb;
            border-color: var(--border-color);
            color: var(--text-secondary);
        }
        .single-status-pill {
            font-size: 11px;
            padding: 3px 10px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.26);
            background: rgba(248, 250, 252, 0.8);
            color: #334155;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .single-status-dot {
            width: 6px;
            height: 6px;
            border-radius: 999px;
            background: #22c55e;
        }
        .single-status-dot.offline {
            background: #ef4444;
        }
        .single-result-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
        }
        .single-result-body {
            font-size: 12px;
            color: var(--text-secondary);
            border-radius: 12px;
            border: 1px solid rgba(226, 232, 240, 0.8);
            background: #f9fafb;
            padding: 12px 14px;
        }
        .single-result-line {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .single-result-status {
            width: 6px;
            height: 6px;
            border-radius: 999px;
            flex-shrink: 0;
        }
        .single-result-status.loading {
            background: #f97316;
        }
        .single-result-status.success {
            background: #22c55e;
        }
        .single-result-status.error {
            background: #ef4444;
        }
        .single-result-url {
            flex: 1;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .single-result-tag {
            font-size: 11px;
            padding: 2px 10px;
            border-radius: 999px;
            border: 1px solid transparent;
            flex-shrink: 0;
        }
        .single-result-tag.success {
            background: #f0fdf4;
            color: #15803d;
            border-color: rgba(34, 197, 94, 0.5);
        }
        .single-result-tag.error {
            background: #fef2f2;
            color: #b91c1c;
            border-color: rgba(248, 113, 113, 0.6);
        }
        .single-meta-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 8px;
            margin-top: 8px;
        }
        .single-meta-item {
            font-size: 11px;
            color: var(--text-tertiary);
        }
        .single-meta-label {
            color: var(--text-secondary);
        }
        .single-meta-value {
            color: var(--text-primary);
        }
        .single-log {
            margin-top: 10px;
            padding-top: 8px;
            border-top: 1px dashed rgba(203, 213, 225, 0.9);
            font-size: 11px;
            color: var(--text-tertiary);
            max-height: 120px;
            overflow-y: auto;
        }

        .scan-stats-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 12px;
        }
        .scan-stats-sub {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-top: 4px;
        }
        .scan-stats-pill {
            flex: 0 0 auto;
            font-size: 10px;
            padding: 4px 10px;
            border-radius: 999px;
            font-weight: 700;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            border: 1px solid rgba(148, 163, 184, 0.26);
            background: rgba(248, 250, 252, 0.8);
            color: #334155;
            height: fit-content;
        }
        .scan-stats-body {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }
        .scan-stats-left {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .scan-stats-right {
            width: 220px;
            flex: 0 0 220px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: center;
            padding: 12px;
            border-radius: 16px;
            border: 1px solid rgba(148, 163, 184, 0.18);
            background: rgba(248, 250, 252, 0.6);
        }
        .scan-kpis {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .scan-kpi {
            border-radius: 14px;
            border: 1px solid rgba(148, 163, 184, 0.22);
            background: rgba(255, 255, 255, 0.72);
            padding: 12px 12px 10px;
            box-shadow: 0 8px 22px rgba(15, 23, 42, 0.06);
        }
        .scan-kpi-value {
            font-size: 18px;
            font-weight: 800;
            color: #0f172a;
            letter-spacing: -0.02em;
            line-height: 1.1;
        }
        .scan-kpi-label {
            font-size: 12px;
            font-weight: 400;
            color: var(--text-secondary);
            margin-top: 6px;
        }
        .scan-progress {
            height: 10px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.06);
            overflow: hidden;
            border: 1px solid rgba(148, 163, 184, 0.18);
        }
        .scan-progress-fill {
            height: 100%;
            width: 0%;
            border-radius: 999px;
            background: linear-gradient(90deg, rgba(6, 182, 212, 0.92), rgba(16, 185, 129, 0.92), rgba(245, 158, 11, 0.92));
            transition: width 0.35s ease;
        }
        .scan-severity-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px;
        }
        .sev-card {
            border-radius: 14px;
            border: 1px solid rgba(148, 163, 184, 0.22);
            background: rgba(255, 255, 255, 0.86);
            padding: 12px 12px 10px;
            cursor: pointer;
            transition: border-color 0.2s, box-shadow 0.2s, transform 0.2s;
            display: flex;
            flex-direction: column;
            gap: 6px;
            text-align: left;
        }
        .sev-card:hover {
            border-color: rgba(148, 163, 184, 0.34);
            box-shadow: 0 14px 34px rgba(15, 23, 42, 0.08);
            transform: translateY(-1px);
        }
        .sev-card.active {
            border-color: rgba(15, 23, 42, 0.16);
            box-shadow: 0 16px 40px rgba(15, 23, 42, 0.10);
        }
        .sev-card-label {
            font-size: 14px;
            font-weight: 400;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .sev-dot {
            width: 8px;
            height: 8px;
            border-radius: 999px;
            flex-shrink: 0;
        }
        .sev-dot.high { background: #ef4444; }
        .sev-dot.medium { background: #f59e0b; }
        .sev-dot.low { background: #3b82f6; }
        .sev-dot.info { background: #94a3b8; }
        .sev-card-value {
            font-size: 24px;
            font-weight: 800;
            line-height: 1.1;
            letter-spacing: -0.02em;
            color: #0f172a;
        }
        .scan-details {
            border-radius: 14px;
            border: 1px solid rgba(148, 163, 184, 0.22);
            background: rgba(248, 250, 252, 0.65);
            padding: 10px 10px 8px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-height: 132px;
            max-height: 132px;
            overflow: hidden;
        }
        .scan-details-title {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }
        .scan-details-list {
            flex: 1;
            overflow-y: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .scan-details-list::-webkit-scrollbar { display: none; }
        .scan-detail-item {
            padding: 8px 10px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.88);
            border: 1px solid rgba(226, 232, 240, 0.9);
            margin-bottom: 8px;
        }
        .scan-detail-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 6px;
        }
        .scan-detail-name {
            font-size: 12px;
            font-weight: 700;
            color: #0f172a;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .scan-detail-tag {
            font-size: 10px;
            padding: 2px 10px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.22);
            background: rgba(248, 250, 252, 0.9);
            color: #334155;
            flex-shrink: 0;
            font-weight: 700;
            letter-spacing: 0.06em;
        }
        .scan-detail-tag.high { background: rgba(254, 242, 242, 0.92); color: rgba(220, 38, 38, 1); border-color: rgba(239, 68, 68, 0.22); }
        .scan-detail-tag.medium { background: rgba(255, 251, 235, 0.92); color: rgba(217, 119, 6, 1); border-color: rgba(245, 158, 11, 0.22); }
        .scan-detail-tag.low { background: rgba(239, 246, 255, 0.92); color: rgba(37, 99, 235, 1); border-color: rgba(59, 130, 246, 0.22); }
        .scan-detail-tag.info { background: rgba(241, 245, 249, 0.92); color: rgba(100, 116, 139, 1); border-color: rgba(148, 163, 184, 0.22); }
        .scan-detail-meta {
            font-size: 11px;
            color: var(--text-tertiary);
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .pie-wrap {
            width: 180px;
            height: 180px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .pie-center {
            position: absolute;
            width: 72px;
            height: 72px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.92);
            border: 1px solid rgba(148, 163, 184, 0.18);
            box-shadow: 0 8px 20px rgba(15, 23, 42, 0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 8px;
            font-size: 11px;
            font-weight: 700;
            color: #0f172a;
            line-height: 1.2;
            pointer-events: none;
        }
        .pie-legend {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .status-indicators {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding-top: 4px;
        }
        .status-indicator-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 0;
        }
        .status-indicator-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .status-indicator-icon svg {
            width: 18px;
            height: 18px;
        }
        .status-indicator-item.ready .status-indicator-icon svg,
        .status-indicator-item.online .status-indicator-icon svg {
            animation: pulseGlow 2s ease-in-out infinite;
        }
        .status-indicator-item.online .status-indicator-icon svg {
            animation-delay: 0.5s;
        }
        .status-indicator-item.offline .status-indicator-icon svg circle {
            stroke: #ef4444;
            fill: #ef4444;
        }
        @keyframes pulseGlow {
            0%, 100% { opacity: 0.6; filter: drop-shadow(0 0 2px rgba(34, 197, 94, 0.4)); }
            50% { opacity: 1; filter: drop-shadow(0 0 8px rgba(34, 197, 94, 0.7)); }
        }
        .status-indicator-text {
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 0;
        }
        .status-indicator-label {
            font-size: 12px;
            font-weight: 500;
            color: #64748b;
        }
        .status-indicator-value {
            font-size: 12px;
            font-weight: 600;
            color: #1e293b;
        }
        .legend-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            width: 100%;
            border-radius: 10px;
            border: 1px solid rgba(148, 163, 184, 0.15);
            background: rgba(255, 255, 255, 0.8);
            padding: 6px 10px;
            cursor: pointer;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .legend-item:hover {
            border-color: rgba(148, 163, 184, 0.3);
            box-shadow: 0 6px 16px rgba(15, 23, 42, 0.05);
        }
        .legend-item.active {
            border-color: rgba(15, 23, 42, 0.16);
        }
        .legend-left {
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 0;
        }
        .legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 999px;
            flex-shrink: 0;
        }
        .legend-label {
            font-size: 11px;
            font-weight: 600;
            color: #334155;
        }
        .legend-value {
            font-size: 11px;
            color: var(--text-tertiary);
            font-weight: 700;
        }
        .pie-tooltip {
            position: fixed;
            z-index: 2000;
            pointer-events: none;
            padding: 8px 10px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.92);
            border: 1px solid rgba(148, 163, 184, 0.24);
            box-shadow: 0 14px 40px rgba(15, 23, 42, 0.10);
            font-size: 12px;
            color: #0f172a;
            display: none;
            max-width: 240px;
        }

        @media (max-width: 860px) {
            .single-layout {
                grid-template-columns: 1fr;
            }
            .scan-stats-right {
                width: 100%;
                flex: 0 0 auto;
                padding: 14px;
            }
            .scan-stats-body {
                flex-direction: column;
            }
            .pie-wrap {
                width: 160px;
                height: 160px;
                margin: 0 auto;
            }
        }
        @media (max-width: 520px) {
            .scan-kpis {
                grid-template-columns: 1fr;
            }
            .scan-severity-grid {
                grid-template-columns: 1fr;
            }
            .pie-center {
                width: 64px;
                height: 64px;
            }
        }

        /* AI 面板收起/展开样式 */
        .ai-panel {
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.35s ease;
        }
        .ai-panel.collapsed {
            transform: translateX(100%);
            opacity: 0;
            pointer-events: none;
        }
        .ai-toggle-btn {
            position: fixed;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 32px;
            height: 80px;
            background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(248,250,252,0.92));
            border: 1px solid rgba(148, 163, 184, 0.22);
            border-right: none;
            border-radius: 12px 0 0 12px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            box-shadow: -4px 0 20px rgba(15, 23, 42, 0.08);
            z-index: 101;
            transition: all 0.3s ease;
        }
        .ai-toggle-btn:hover {
            background: linear-gradient(180deg, #fff, rgba(248,250,252,1));
            box-shadow: -6px 0 24px rgba(15, 23, 42, 0.12);
        }
        .ai-toggle-btn .toggle-icon {
            width: 16px;
            height: 16px;
            color: var(--accent-green);
            transition: transform 0.3s ease;
        }
        .ai-toggle-btn.expanded .toggle-icon {
            transform: rotate(180deg);
        }
        .ai-toggle-btn .toggle-text {
            writing-mode: vertical-rl;
            font-size: 11px;
            font-weight: 700;
            color: #334155;
            letter-spacing: 0.05em;
        }
        .ai-panel.collapsed + .ai-toggle-btn {
            right: 0;
        }
        .ai-panel:not(.collapsed) + .ai-toggle-btn {
            right: 380px;
        }
        /* 收起时调整 main-layout */
        .main-layout.ai-collapsed {
            margin-right: 0;
        }
    </style>
</head>
<body>
    <!-- 导航栏占位符，由 layout.js 加载 -->
    <nav class="navbar" id="navbar"></nav>

    <div class="main-layout">
        <main class="content">
            <!-- 浮动导航占位符，由 layout.js 加载 -->
            <div class="floating-nav" id="floatingNav"></div>

            <div class="single-layout">
                <div class="single-card">
                    <div class="single-card-header">
                        <div>
                            <div class="single-card-title">
                                单站渗透扫描
                                <span class="single-card-title-pill">TARGET MODE</span>
                            </div>
                            <div class="single-card-sub">针对单个目标站点进行快速指纹验证与风险探测</div>
                        </div>
                        <div class="single-card-header-right">
                            <div class="server-selector" id="serverSelector">
                                <button class="server-selector-btn" type="button" id="serverSelectorBtn">
                                    <span class="mini-dot"></span>
                                    <span id="serverSelectorText">目标 0</span>
                                </button>
                                <div class="server-popover" id="serverPopover">
                                    <div class="server-popover-header">
                                        <div class="server-popover-title">选择服务器实例</div>
                                        <div class="server-popover-actions">
                                            <button class="server-mini-btn" type="button" id="selectAllBtn">全选</button>
                                            <button class="server-mini-btn" type="button" id="invertBtn">反选</button>
                                        </div>
                                    </div>
                                    <div class="server-list" id="serverList"></div>
                                </div>
                            </div>
                            <div class="single-status-pill" id="serverStatusPill">
                                <span class="single-status-dot" id="serverDot"></span>
                                <span id="serverText">检测中...</span>
                            </div>
                        </div>
                    </div>

                <div class="single-form-row">
                    <div>
                        <div class="single-label">目标 URL</div>
                        <input id="singleUrl" class="single-input" placeholder="例如 https://example.com 或 http://192.168.1.1:8080">
                        <div class="single-hint">支持 HTTP/HTTPS 协议，可以是域名或 IP:端口 格式</div>
                    </div>

                </div>

                    <div class="single-checkbox-row">
                        <label class="single-checkbox-label">
                            <input type="checkbox" id="collectAssets" class="single-checkbox">
                            <span class="single-checkbox-text">收集资产进行扫描</span>
                        </label>
                    </div>

                    <div class="single-actions">
                        <button class="single-btn single-btn-primary" id="singleBtn" onclick="startSingleScan()">开始扫描</button>
                        <button class="single-btn single-btn-secondary" onclick="clearSingleResult()">清除结果</button>
                    </div>
                </div>

                <div class="single-result-card">
                    <div class="scan-stats-header">
                        <div>
                            <div class="single-result-title">扫描统计面板</div>
                            <div class="scan-stats-sub" id="scanStatsSub">等待开始扫描</div>
                        </div>
                        <div class="scan-stats-pill" id="scanStatsPill">READY</div>
                    </div>

                    <div class="scan-stats-body">
                        <div class="scan-stats-left">
                            <div class="scan-kpis">
                                <div class="scan-kpi">
                                    <div class="scan-kpi-value" id="pocDoneText">0/0</div>
                                    <div class="scan-kpi-label">已完成 POC 扫描</div>
                                </div>
                                <div class="scan-kpi">
                                    <div class="scan-kpi-value" id="pocPercentText">0%</div>
                                    <div class="scan-kpi-label">进度</div>
                                </div>
                            </div>

                            <div class="scan-progress"><div class="scan-progress-fill" id="scanProgressFill"></div></div>

                            <div class="scan-severity-grid">
                                <button class="sev-card" type="button" data-sev="high" id="sevHighBtn">
                                    <div class="sev-card-label"><span class="sev-dot high"></span>高危漏洞</div>
                                    <div class="sev-card-value" id="sevHighValue">0</div>
                                </button>
                                <button class="sev-card" type="button" data-sev="medium" id="sevMediumBtn">
                                    <div class="sev-card-label"><span class="sev-dot medium"></span>中危漏洞</div>
                                    <div class="sev-card-value" id="sevMediumValue">0</div>
                                </button>
                                <button class="sev-card" type="button" data-sev="low" id="sevLowBtn">
                                    <div class="sev-card-label"><span class="sev-dot low"></span>低危漏洞</div>
                                    <div class="sev-card-value" id="sevLowValue">0</div>
                                </button>
                                <button class="sev-card" type="button" data-sev="info" id="sevInfoBtn">
                                    <div class="sev-card-label"><span class="sev-dot info"></span>信息类</div>
                                    <div class="sev-card-value" id="sevInfoValue">0</div>
                                </button>
                            </div>
                        </div>

                        <div class="scan-stats-right">
                            <div class="pie-wrap">
                                <svg id="vulnPie" width="168" height="168" viewBox="0 0 168 168"></svg>
                                <div class="pie-center" id="pieCenter">全部</div>
                            </div>
                            <div class="status-indicators">
                                <div class="status-indicator-item ready" id="aiStatusItem">
                                    <div class="status-indicator-icon">
                                        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="6" fill="url(#greenGradient)"/></svg>
                                    </div>
                                    <div class="status-indicator-text">
                                        <span class="status-indicator-label">AI 自动扫描</span>
                                        <span class="status-indicator-value" id="aiStatusText">准备就绪</span>
                                    </div>
                                </div>
                                <div class="status-indicator-item online" id="apiStatusItem">
                                    <div class="status-indicator-icon">
                                        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="6" fill="url(#greenGradient)"/></svg>
                                    </div>
                                    <div class="status-indicator-text">
                                        <span class="status-indicator-label">API 对接状态</span>
                                        <span class="status-indicator-value" id="apiStatusText">连接正常</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bottom-zone" id="bottomZone">
                <div class="bottom-zone-header">
                    <div>
                        <div class="bottom-zone-title">扫描日志与漏洞分类</div>
                    </div>
                    <div class="bottom-zone-actions">
                        <button class="bottom-zone-btn" type="button" id="refreshDemoBtn">刷新数据</button>
                        <button class="bottom-zone-btn" type="button" id="exportBtn">导出</button>
                    </div>
                </div>
                <div class="bottom-zone-body">
                    <div class="log-panel">
                        <div class="log-panel-header">
                            <div>
                                <div class="log-panel-title">扫描日志</div>
                                <div class="log-panel-sub" id="logSub">预览演示数据</div>
                            </div>
                        </div>
                        <div class="log-list" id="logList"></div>
                    </div>
                    <div class="vuln-panels" id="vulnPanels">
                        <div class="vuln-cat" id="vulnPanelMedium">
                            <div class="vuln-cat-header">
                                <div class="vuln-cat-title">中危漏洞</div>
                                <div class="vuln-cat-badge" id="mediumDemoBadge">0</div>
                            </div>
                            <div class="vuln-cat-list" id="mediumVulnList"></div>
                        </div>
                        <div class="vuln-cat" id="vulnPanelInfo">
                            <div class="vuln-cat-header">
                                <div class="vuln-cat-title">疑似信息披露</div>
                                <div class="vuln-cat-badge" id="infoDemoBadge">0</div>
                            </div>
                            <div class="vuln-cat-list" id="infoVulnList"></div>
                        </div>
                        <div class="vuln-cat" id="vulnPanelHigh">
                            <div class="vuln-cat-header">
                                <div class="vuln-cat-title">高危漏洞</div>
                                <div class="vuln-cat-badge" id="highDemoBadge">0</div>
                            </div>
                            <div class="vuln-cat-list" id="highVulnList"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 已扫描目标板块 -->
            <div class="targets-zone" id="targetsZone">
                <div class="targets-zone-header">
                    <div>
                        <div class="targets-zone-title">已扫描目标</div>
                        <div class="targets-zone-sub" id="targetsSub">共 0 个目标</div>
                    </div>
                    <div class="targets-zone-actions">
                        <button class="bottom-zone-btn" type="button" onclick="expandAllTargets()">全部展开</button>
                        <button class="bottom-zone-btn" type="button" onclick="collapseAllTargets()">全部收起</button>
                    </div>
                </div>
                <div class="targets-list" id="targetsList">
                    <div class="targets-empty">暂无扫描目标，请先开始扫描</div>
                </div>
            </div>
        </main>
    </div>

    <div class="ai-panel collapsed" id="aiPanel">
        <div class="ai-header">
            <div class="ai-title">AI 安全助手</div>
        </div>
        <div class="ai-shortcuts">
            <button class="ai-shortcut" onclick="aiQuick('single')">解释当前站点风险</button>
            <button class="ai-shortcut" onclick="aiQuick('hardening')">给出加固建议</button>
            <button class="ai-shortcut" onclick="aiQuick('report')">生成简要报告</button>
        </div>
        <div class="ai-body" id="aiMessages">
            <div class="ai-message assistant">
                你好，这里是单站渗透模式的 AI 安全助手。<br>
                输入目标 URL 完成检测后，我可以帮你分析：<br>
                • 指纹识别结果与可能的风险<br>
                • 优先需要验证的攻击面<br>
                • 简要加固建议
            </div>
        </div>
        <div class="ai-footer">
            <div class="ai-tools">
                <button class="tool-btn" onclick="goToBulk()">
                    <svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
                    <span>批量扫描</span>
                </button>
                <button class="tool-btn" onclick="checkServer()">
                    <svg viewBox="0 0 24 24"><path d="M4 4h16v4H4zM4 10h16v4H4zM4 16h16v4H4z"/></svg>
                    <span>引擎状态</span>
                </button>
            </div>
            <div class="ai-input-wrap">
                <textarea id="aiInput" class="ai-input" rows="1" placeholder="向 AI 询问与当前站点相关的安全问题..."></textarea>
                <button class="ai-send" onclick="sendAiMessage()">
                    <svg viewBox="0 0 24 24"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
                </button>
            </div>
        </div>
    </div>

    <!-- AI面板切换按钮 -->
    <button class="ai-toggle-btn" id="aiToggleBtn" onclick="toggleAiPanel()">
        <svg class="toggle-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M15 18l-6-6 6-6"/>
        </svg>
        <span class="toggle-text">AI助手</span>
    </button>

    <div class="pie-tooltip" id="pieTooltip"></div>

    <!-- SVG渐变定义 -->
    <svg width="0" height="0" style="position:absolute">
        <defs>
            <linearGradient id="greenGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" stop-color="#22c55e"/>
                <stop offset="100%" stop-color="#10b981"/>
            </linearGradient>
            <linearGradient id="blueGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" stop-color="#3b82f6"/>
                <stop offset="100%" stop-color="#06b6d4"/>
            </linearGradient>
        </defs>
    </svg>

    <script>
        /* 单站渗透页面特有 JavaScript */
        /* 通用函数已在 common.js 中定义：API_BASE, escapeHtml, checkServer 等 */

        // 演示数据
        const demoVulns = {
            high: [
                { name: 'SQL注入漏洞', path: '/api/user?id=1', desc: '参数id存在SQL注入风险，可获取数据库敏感信息' },
                { name: '远程代码执行', path: '/admin/template.php', desc: '模板编辑功能存在RCE漏洞，可执行任意系统命令' }
            ],
            medium: [
                { name: 'XSS跨站脚本', path: '/search?q=test', desc: '搜索参数未过滤，存在反射型XSS' },
                { name: '敏感信息泄露', path: '/api/config', desc: '配置接口暴露数据库连接信息' },
                { name: 'CSRF漏洞', path: '/user/update', desc: '用户信息修改接口缺少CSRF Token验证' }
            ],
            info: [
                { name: '目录遍历', path: '/static/', desc: '静态资源目录开启了目录列表' },
                { name: '版本信息泄露', path: '/readme.txt', desc: 'CMS版本文件可访问' },
                { name: '调试信息', path: '/phpinfo.php', desc: 'PHP信息页面可访问' },
                { name: '备份文件', path: '/backup.sql', desc: '发现数据库备份文件' }
            ]
        };

        async function startSingleScan() {
            const urlInput = document.getElementById('singleUrl');
            const btn = document.getElementById('singleBtn');
            const url = urlInput.value.trim() || 'https://demo.example.com';
            const collectAssets = document.getElementById('collectAssets').checked;

            btn.disabled = true;
            btn.textContent = '扫描中...';

            // 更新状态
            document.getElementById('scanStatsPill').textContent = '扫描中';
            document.getElementById('scanStatsPill').style.background = 'rgba(245, 158, 11, 0.15)';
            document.getElementById('scanStatsPill').style.color = '#f59e0b';
            document.getElementById('scanStatsSub').textContent = '正在扫描 ' + url;

            // 模拟扫描进度
            const totalPocs = 24;
            let currentPoc = 0;
            const progressFill = document.getElementById('scanProgressFill');
            
            const scanInterval = setInterval(() => {
                currentPoc++;
                const percent = Math.round((currentPoc / totalPocs) * 100);
                progressFill.style.width = percent + '%';
                document.getElementById('pocDoneText').textContent = currentPoc + '/' + totalPocs;
                document.getElementById('pocPercentText').textContent = percent + '%';
                
                if (currentPoc >= totalPocs) {
                    clearInterval(scanInterval);
                    finishScan(url, collectAssets);
                }
            }, 80);
        }

        function finishScan(url, collectAssets) {
            const btn = document.getElementById('singleBtn');
            btn.disabled = false;
            btn.textContent = '开始扫描';

            // 更新状态为完成
            document.getElementById('scanStatsPill').textContent = '扫描完成';
            document.getElementById('scanStatsPill').style.background = 'rgba(16, 185, 129, 0.15)';
            document.getElementById('scanStatsPill').style.color = '#10b981';
            document.getElementById('scanStatsSub').textContent = '扫描完成 - ' + new Date().toLocaleTimeString();

            // 更新漏洞统计
            document.getElementById('sevHighValue').textContent = '2';
            document.getElementById('sevMediumValue').textContent = '3';
            document.getElementById('sevLowValue').textContent = '0';
            document.getElementById('sevInfoValue').textContent = '4';

            // 渲染饼图
            renderPieChart();

            // 渲染扫描日志
            renderLogs(url);

            // 渲染漏洞分类面板
            renderVulnPanels();

            // 渲染已扫描目标
            renderScannedTargets(url);
        }

        function renderPieChart() {
            const data = [
                { label: '高危', value: 2, color: '#ef4444' },
                { label: '中危', value: 3, color: '#f59e0b' },
                { label: '低危', value: 0, color: '#3b82f6' },
                { label: '信息', value: 4, color: '#94a3b8' }
            ];
            const total = data.reduce((s, d) => s + d.value, 0);
            const svg = document.getElementById('vulnPie');
            const cx = 84, cy = 84, r = 66, ir = 42;
            let cumulative = 0;
            let paths = '';

            data.forEach(d => {
                if (d.value === 0) return;
                const startAngle = (cumulative / total) * 2 * Math.PI - Math.PI / 2;
                cumulative += d.value;
                const endAngle = (cumulative / total) * 2 * Math.PI - Math.PI / 2;
                const largeArc = (endAngle - startAngle) > Math.PI ? 1 : 0;
                const x1 = cx + r * Math.cos(startAngle);
                const y1 = cy + r * Math.sin(startAngle);
                const x2 = cx + r * Math.cos(endAngle);
                const y2 = cy + r * Math.sin(endAngle);
                const ix1 = cx + ir * Math.cos(startAngle);
                const iy1 = cy + ir * Math.sin(startAngle);
                const ix2 = cx + ir * Math.cos(endAngle);
                const iy2 = cy + ir * Math.sin(endAngle);
                paths += `<path d="M${x1},${y1} A${r},${r} 0 ${largeArc},1 ${x2},${y2} L${ix2},${iy2} A${ir},${ir} 0 ${largeArc},0 ${ix1},${iy1} Z" fill="${d.color}" opacity="0.85"/>`;
            });
            svg.innerHTML = paths;

            document.getElementById('pieCenter').innerHTML = `${total}<br><span style="font-size:9px;color:#64748b">漏洞总数</span>`;
        }

        function renderLogs(url) {
            const logs = [
                { type: '指纹识别', status: 'ok', target: url, desc: '检测到苹果CMS V10，ThinkPHP框架', time: '0.2s' },
                { type: 'SQL注入检测', status: 'ok', target: url + '/api/user?id=1', desc: '发现SQL注入漏洞', time: '0.8s' },
                { type: 'RCE检测', status: 'ok', target: url + '/admin/template.php', desc: '发现远程代码执行漏洞', time: '1.2s' },
                { type: 'XSS检测', status: 'ok', target: url + '/search', desc: '发现反射型XSS', time: '0.5s' },
                { type: '敏感文件扫描', status: 'ok', target: url + '/backup.sql', desc: '发现数据库备份文件', time: '0.3s' },
                { type: '目录扫描', status: 'ok', target: url + '/static/', desc: '目录列表已开启', time: '0.4s' }
            ];
            const logList = document.getElementById('logList');
            logList.innerHTML = logs.map(log => `
                <div class="log-item">
                    <div class="log-top">
                        <div class="log-title">
                            <span class="log-dot ${log.status}"></span>
                            <span class="log-type">${log.type}</span>
                        </div>
                        <span class="log-time">${log.time}</span>
                    </div>
                    <div class="log-target">${log.target}</div>
                    <div class="log-desc">${log.desc}</div>
                </div>
            `).join('');
            document.getElementById('logSub').textContent = `共 ${logs.length} 条记录`;
        }

        function renderVulnPanels() {
            // 高危漏洞
            const highList = document.getElementById('highVulnList');
            highList.innerHTML = demoVulns.high.map(v => `
                <div class="vuln-row">
                    <div class="vuln-row-name">${v.name}</div>
                    <div class="vuln-row-meta"><span class="vuln-chip">${v.path}</span></div>
                    <div class="vuln-row-desc">${v.desc}</div>
                </div>
            `).join('');
            document.getElementById('highDemoBadge').textContent = demoVulns.high.length;

            // 中危漏洞
            const mediumList = document.getElementById('mediumVulnList');
            mediumList.innerHTML = demoVulns.medium.map(v => `
                <div class="vuln-row">
                    <div class="vuln-row-name">${v.name}</div>
                    <div class="vuln-row-meta"><span class="vuln-chip">${v.path}</span></div>
                    <div class="vuln-row-desc">${v.desc}</div>
                </div>
            `).join('');
            document.getElementById('mediumDemoBadge').textContent = demoVulns.medium.length;

            // 信息泄露
            const infoList = document.getElementById('infoVulnList');
            infoList.innerHTML = demoVulns.info.map(v => `
                <div class="vuln-row">
                    <div class="vuln-row-name">${v.name}</div>
                    <div class="vuln-row-meta"><span class="vuln-chip">${v.path}</span></div>
                    <div class="vuln-row-desc">${v.desc}</div>
                </div>
            `).join('');
            document.getElementById('infoDemoBadge').textContent = demoVulns.info.length;
        }

        // 演示目标数据
        const demoTargets = [
            {
                url: 'https://demo.example.com',
                type: 'main',
                vulns: {
                    high: [
                        { name: 'SQL注入漏洞', path: '/api/user?id=1', desc: '参数id存在SQL注入风险' },
                        { name: '远程代码执行', path: '/admin/template.php', desc: '模板编辑存在RCE漏洞' }
                    ],
                    medium: [
                        { name: 'XSS跨站脚本', path: '/search?q=test', desc: '搜索参数未过滤' },
                        { name: 'CSRF漏洞', path: '/user/update', desc: '缺少Token验证' }
                    ],
                    info: [
                        { name: '目录遍历', path: '/static/', desc: '目录列表已开启' },
                        { name: '版本泄露', path: '/readme.txt', desc: 'CMS版本可访问' }
                    ]
                }
            },
            {
                url: 'https://api.demo.example.com',
                type: 'sub',
                vulns: {
                    high: [
                        { name: 'JWT密钥泄露', path: '/api/auth', desc: 'JWT使用弱密钥签名' }
                    ],
                    medium: [
                        { name: '接口未授权', path: '/api/admin/users', desc: '管理接口无鉴权' },
                        { name: '速率限制缺失', path: '/api/login', desc: '登录接口可爆破' },
                        { name: '敏感数据明文', path: '/api/user/info', desc: '密码明文传输' },
                        { name: 'CORS配置错误', path: '/api/*', desc: '允许任意源访问' }
                    ],
                    info: []
                }
            },
            {
                url: 'https://admin.demo.example.com',
                type: 'sub',
                vulns: {
                    high: [],
                    medium: [
                        { name: '弱密码策略', path: '/admin/login', desc: '允许简单密码' }
                    ],
                    info: [
                        { name: '登录页面暴露', path: '/admin/login', desc: '后台入口可访问' },
                        { name: 'Server头泄露', path: '/', desc: '服务器版本信息暴露' }
                    ]
                }
            },
            {
                url: 'https://static.demo.example.com',
                type: 'sub',
                vulns: {
                    high: [],
                    medium: [],
                    info: [
                        { name: 'CDN缓存配置', path: '/', desc: '缓存策略可优化' }
                    ]
                }
            }
        ];

        function renderScannedTargets(mainUrl) {
            const targetsList = document.getElementById('targetsList');
            const targets = demoTargets.map(t => ({
                ...t,
                url: t.type === 'main' ? mainUrl : t.url.replace('demo.example.com', new URL(mainUrl).hostname || 'demo.example.com')
            }));

            targetsList.innerHTML = targets.map((target, idx) => {
                const highCount = target.vulns.high.length;
                const mediumCount = target.vulns.medium.length;
                const infoCount = target.vulns.info.length;
                const totalVulns = highCount + mediumCount + infoCount;
                const allVulns = [
                    ...target.vulns.high.map(v => ({ ...v, severity: 'high' })),
                    ...target.vulns.medium.map(v => ({ ...v, severity: 'medium' })),
                    ...target.vulns.info.map(v => ({ ...v, severity: 'info' }))
                ];
                const showVulns = allVulns.slice(0, 3);
                const hasMore = allVulns.length > 3;

                return `
                    <div class="target-card" id="target-${idx}">
                        <div class="target-header" onclick="toggleTarget(${idx})">
                            <div class="target-header-left">
                                <div class="target-expand-icon">
                                    <svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6"/></svg>
                                </div>
                                <span class="target-type-badge ${target.type}">${target.type === 'main' ? '主站' : '子站'}</span>
                                <span class="target-url">${escapeHtml(target.url)}</span>
                            </div>
                            <div class="target-stats">
                                ${highCount > 0 ? `<div class="target-stat"><span class="target-stat-dot high"></span>${highCount}</div>` : ''}
                                ${mediumCount > 0 ? `<div class="target-stat"><span class="target-stat-dot medium"></span>${mediumCount}</div>` : ''}
                                ${infoCount > 0 ? `<div class="target-stat"><span class="target-stat-dot info"></span>${infoCount}</div>` : ''}
                                ${totalVulns === 0 ? '<div class="target-stat" style="color:#22c55e">安全</div>' : ''}
                            </div>
                        </div>
                        <div class="target-body">
                            <div class="target-summary">
                                <div class="target-summary-item">
                                    <span class="target-summary-label">高危</span>
                                    <span class="target-summary-value" style="color:#ef4444">${highCount}</span>
                                </div>
                                <div class="target-summary-item">
                                    <span class="target-summary-label">中危</span>
                                    <span class="target-summary-value" style="color:#f59e0b">${mediumCount}</span>
                                </div>
                                <div class="target-summary-item">
                                    <span class="target-summary-label">信息</span>
                                    <span class="target-summary-value" style="color:#94a3b8">${infoCount}</span>
                                </div>
                                <div class="target-summary-item">
                                    <span class="target-summary-label">总计</span>
                                    <span class="target-summary-value">${totalVulns}</span>
                                </div>
                            </div>
                            ${totalVulns > 0 ? `
                                <div class="target-vuln-list">
                                    ${showVulns.map(v => `
                                        <div class="target-vuln-item">
                                            <span class="target-vuln-severity ${v.severity}"></span>
                                            <div class="target-vuln-content">
                                                <div class="target-vuln-name">${v.name}</div>
                                                <div class="target-vuln-path">${v.path}</div>
                                                <div class="target-vuln-desc">${v.desc}</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                ${hasMore ? `
                                    <a class="target-more-link" href="vuln-detail.html?target=${encodeURIComponent(target.url)}">
                                        查看全部 ${totalVulns} 个漏洞详情 →
                                    </a>
                                ` : ''}
                            ` : '<div style="text-align:center;color:var(--text-tertiary);padding:20px;font-size:12px">未发现漏洞</div>'}
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('targetsSub').textContent = `共 ${targets.length} 个目标，${targets.filter(t => t.type === 'main').length} 个主站，${targets.filter(t => t.type === 'sub').length} 个子站`;
        }

        function toggleTarget(idx) {
            const card = document.getElementById(`target-${idx}`);
            if (card) {
                card.classList.toggle('expanded');
            }
        }

        function expandAllTargets() {
            document.querySelectorAll('.target-card').forEach(card => card.classList.add('expanded'));
        }

        function collapseAllTargets() {
            document.querySelectorAll('.target-card').forEach(card => card.classList.remove('expanded'));
        }

        function clearSingleResult() {
            // 重置KPI
            document.getElementById('pocDoneText').textContent = '0/0';
            document.getElementById('pocPercentText').textContent = '0%';
            document.getElementById('scanProgressFill').style.width = '0%';
            
            // 重置漏洞统计
            document.getElementById('sevHighValue').textContent = '0';
            document.getElementById('sevMediumValue').textContent = '0';
            document.getElementById('sevLowValue').textContent = '0';
            document.getElementById('sevInfoValue').textContent = '0';
            
            // 重置状态
            document.getElementById('scanStatsPill').textContent = '准备就绪';
            document.getElementById('scanStatsPill').style.background = '';
            document.getElementById('scanStatsPill').style.color = '';
            document.getElementById('scanStatsSub').textContent = '等待开始扫描';
            
            // 清空饼图
            document.getElementById('vulnPie').innerHTML = '';
            document.getElementById('pieCenter').innerHTML = '全部';
            
            // 清空日志
            document.getElementById('logList').innerHTML = '';
            document.getElementById('logSub').textContent = '等待扫描';
            
            // 清空漏洞面板
            document.getElementById('highVulnList').innerHTML = '';
            document.getElementById('mediumVulnList').innerHTML = '';
            document.getElementById('infoVulnList').innerHTML = '';
            document.getElementById('highDemoBadge').textContent = '0';
            document.getElementById('mediumDemoBadge').textContent = '0';
            document.getElementById('infoDemoBadge').textContent = '0';
            
            // 清空目标列表
            document.getElementById('targetsList').innerHTML = '<div class="targets-empty">暂无扫描目标，请先开始扫描</div>';
            document.getElementById('targetsSub').textContent = '共 0 个目标';
        }

        function goToBulk() {
            window.location.href = 'index.html';
        }

        // focusAi 函数已在 common.js 中定义

        function aiQuick(type) {
            const messagesDiv = document.getElementById('aiMessages');
            if (!messagesDiv) return;
            const msg = document.createElement('div');
            msg.className = 'ai-message assistant';
            if (type === 'single') {
                msg.textContent = '根据当前单站的扫描结果，我建议重点关注暴露的入口、版本信息以及指纹中暴露的静态资源路径，可结合历史漏洞库进一步验证。';
            } else if (type === 'hardening') {
                msg.textContent = '常规加固建议：限制后台访问来源、及时更新 CMS 版本、关闭不必要模块、对上传和模板等敏感功能进行严格权限与文件校验。';
            } else if (type === 'report') {
                msg.textContent = '你可以在这里补充扫描结果，我会帮助你整理为一份可读性较强的渗透测试小结。';
            }
            messagesDiv.appendChild(msg);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // 重写 sendAiMessage 使用页面特定回复
        function sendAiMessage() {
            const input = document.getElementById('aiInput');
            const messagesDiv = document.getElementById('aiMessages');
            if (!input || !messagesDiv) return;
            const text = input.value.trim();
            if (!text) return;
            
            const user = document.createElement('div');
            user.className = 'ai-message user';
            user.textContent = text;
            messagesDiv.appendChild(user);

            const ai = document.createElement('div');
            ai.className = 'ai-message assistant';
            ai.textContent = '我已收到你的问题，可以结合当前单站扫描结果，给出更细致的分析建议。';
            messagesDiv.appendChild(ai);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            input.value = '';
        }

        // AI面板切换函数
        function toggleAiPanel() {
            const panel = document.getElementById('aiPanel');
            const btn = document.getElementById('aiToggleBtn');
            const mainLayout = document.querySelector('.main-layout');
            
            if (panel.classList.contains('collapsed')) {
                // 展开
                panel.classList.remove('collapsed');
                btn.classList.add('expanded');
                mainLayout.classList.remove('ai-collapsed');
            } else {
                // 收起
                panel.classList.add('collapsed');
                btn.classList.remove('expanded');
                mainLayout.classList.add('ai-collapsed');
            }
        }

        // 页面初始化（common.js 已处理通用初始化，此处仅处理页面特有逻辑）
        document.addEventListener('DOMContentLoaded', async () => {
            // 加载导航栏组件（子目录页面需要 basePath）
            await XHLayout.loadNavbar({
                activeTab: 'single',
                basePath: '../'
            });
            
            // 加载浮动导航组件
            await XHLayout.loadFloatingNav({
                title: '单站渗透仪表盘',
                activePage: 'single',
                basePath: '../'
            });
            
            // 加载底部版权
            XHLayout.loadFooter();
            
            // 初始化 AI 面板状态（默认收起）
            document.querySelector('.main-layout').classList.add('ai-collapsed');
            
            clearSingleResult();
        });
    </script>
</body>
</html>
