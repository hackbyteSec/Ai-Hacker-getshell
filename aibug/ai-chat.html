<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI 对话助手 - XHSecTeam</title>

    <link rel="stylesheet" href="../static/css/common.css" />
    <script src="../static/css/common.js"></script>
    <script src="../static/js/layout.js"></script>

    <style>
        /* =========================
           页面结构：继承 aibug/index.html 配色与玻璃拟态风格
           ========================= */
        :root { --right-panel-width: clamp(320px, 22vw, 520px); }
        .main-layout { margin-right: var(--right-panel-width) !important; }

        /* =========================
           左侧固定侧边栏：显示折叠按钮（common.css 默认隐藏）
           ========================= */
        .nav-toggle {
            position: absolute;
            right: -10px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 101;
        }
        .nav-toggle:hover {
            background: var(--accent-green);
            border-color: var(--accent-green);
            color: #fff;
        }
        .nav-toggle svg {
            width: 14px;
            height: 14px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
            transition: transform 0.3s ease;
        }
        .navbar.collapsed .nav-toggle svg { transform: rotate(180deg); }

        /* =========================
           主内容：AI 对话框界面
           ========================= */
        .ai-chat-page {
            width: 100%;
            max-width: 100%;
            margin: 0;
            padding: 18px 20px 28px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            min-height: calc(100vh - 40px);
        }

        .page-hero {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            gap: 12px;
            padding: 6px 2px;
        }
        .hero-left { min-width: 0; }
        .hero-title {
            font-size: 22px;
            font-weight: 850;
            letter-spacing: 0.02em;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        .hero-sub {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-top: 6px;
        }

        .hero-status {
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid rgba(148, 163, 184, 0.22);
            background: rgba(255, 255, 255, 0.8);
            padding: 10px 12px;
            border-radius: 14px;
            box-shadow: 0 10px 26px rgba(15, 23, 42, 0.06);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            flex-shrink: 0;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 999px;
            background: var(--accent-green);
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.35);
        }
        .status-dot.offline {
            background: var(--accent-red);
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.28);
        }
        .status-text {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 600;
            white-space: nowrap;
        }

        .chat-shell {
            flex: 1 1 auto;
            display: flex;
            flex-direction: column;
            border-radius: 20px;
            border: 1px solid rgba(148, 163, 184, 0.26);
            background: rgba(255, 255, 255, 0.88);
            box-shadow: 0 12px 32px rgba(15, 23, 42, 0.08);
            overflow: hidden;
            position: relative;
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            max-height: 800px;
            min-height: 200px;
        }
        .chat-shell::before {
            content: "";
            position: absolute;
            inset: -1px;
            border-radius: 20px;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.22), rgba(6, 182, 212, 0.18));
            opacity: 0.7;
            pointer-events: none;
            mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
            -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
            padding: 1px;
            -webkit-mask-composite: xor;
            mask-composite: exclude;
        }

        .chat-header {
            position: relative;
            z-index: 1;
            padding: 14px 18px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.18);
            background: linear-gradient(180deg, rgba(248, 250, 252, 0.92), rgba(255, 255, 255, 0.68));
        }
        .chat-title {
            font-size: 13px;
            font-weight: 800;
            color: #0f172a;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .chat-title::before {
            content: "";
            width: 3px;
            height: 14px;
            border-radius: 2px;
            background: linear-gradient(180deg, #3b82f6, #06b6d4);
        }
        .chat-hint {
            font-size: 11px;
            color: var(--text-tertiary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 56vw;
        }
        .chat-header-right {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }
        .chat-chip {
            font-size: 10px;
            padding: 5px 10px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.22);
            background: rgba(248, 250, 252, 0.86);
            color: #334155;
            font-weight: 800;
            letter-spacing: 0.06em;
        }

        .chat-messages {
            position: relative;
            z-index: 1;
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px 20px 14px;
            display: flex;
            flex-direction: column;
            gap: 14px;
            scrollbar-width: none;
            -ms-overflow-style: none;
            background:
                radial-gradient(circle at 0 0, rgba(16, 185, 129, 0.06), transparent 55%),
                radial-gradient(circle at 100% 0, rgba(6, 182, 212, 0.06), transparent 55%),
                linear-gradient(180deg, rgba(248, 250, 252, 0.96), rgba(255, 255, 255, 0.96));
        }
        .chat-messages::-webkit-scrollbar { width: 0; height: 0; display: none; }

        .chat-message {
            max-width: 720px;
            animation: chatMsgIn 0.24s ease-out;
        }
        @keyframes chatMsgIn {
            from { opacity: 0; transform: translateY(8px) scale(0.985); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .chat-message.user { align-self: flex-end; }
        .chat-message.assistant { align-self: flex-start; }

        .chat-bubble {
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 14px;
            line-height: 1.7;
            word-break: break-word;
            position: relative;
        }
        .chat-bubble .chat-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        .chat-bubble .chat-action-btn {
            height: 32px;
            padding: 0 12px;
            border-radius: 12px;
            border: none;
            background: rgba(15, 23, 42, 0.06);
            color: rgba(15, 23, 42, 0.86);
            font-size: 12px;
            font-weight: 800;
            cursor: pointer;
            transition: transform 0.16s ease-out, box-shadow 0.18s ease-out;
        }
        .chat-bubble .chat-action-btn:hover { box-shadow: 0 10px 24px rgba(15, 23, 42, 0.10); transform: translateY(-1px); }
        .chat-bubble .chat-action-btn:active { transform: translateY(0) scale(0.99); }
        .chat-bubble .chat-action-btn.primary { background: rgba(33, 150, 243, 0.10); color: rgba(33, 150, 243, 1); }
        .chat-bubble .chat-action-btn.danger { background: rgba(244, 67, 54, 0.10); color: rgba(244, 67, 54, 1); }
        .chat-message.assistant .chat-bubble {
            background: rgba(241, 245, 249, 0.95);
            color: var(--text-primary);
            border: 1px solid rgba(148, 163, 184, 0.32);
            border-bottom-left-radius: 6px;
            box-shadow: 0 10px 26px rgba(15, 23, 42, 0.05);
        }
        .chat-message.user .chat-bubble {
            background: linear-gradient(135deg, var(--accent-green), var(--accent-cyan));
            color: #ffffff;
            border-bottom-right-radius: 6px;
            box-shadow: 0 10px 26px rgba(16, 185, 129, 0.35);
        }
        .chat-meta {
            font-size: 11px;
            color: var(--text-tertiary);
            margin-top: 4px;
            padding: 0 4px;
        }
        .chat-message.user .chat-meta { text-align: right; }

        .chat-composer {
            position: relative;
            z-index: 1;
            padding: 14px 16px 16px;
            border-top: 1px solid rgba(148, 163, 184, 0.18);
            background: linear-gradient(180deg, rgba(248, 250, 252, 0.96), rgba(255, 255, 255, 0.98));
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .selected-tools {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            min-height: 22px;
            align-items: center;
        }
        .tool-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.22);
            background: rgba(255, 255, 255, 0.92);
            color: #334155;
            font-size: 11px;
            font-weight: 700;
            user-select: none;
        }
        .tool-tag .remove {
            width: 18px;
            height: 18px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 999px;
            background: rgba(148, 163, 184, 0.14);
            color: rgba(51, 65, 85, 0.92);
            cursor: pointer;
            transition: all 0.16s ease-out;
        }
        .tool-tag .remove:hover { background: rgba(239, 68, 68, 0.14); color: rgba(220, 38, 38, 1); }
        .tool-tag .remove:active { transform: scale(0.95); }

        .composer-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        .chat-input {
            flex: 1;
            min-height: 44px;
            max-height: 160px;
            border-radius: 16px;
            border: 1px solid rgba(148, 163, 184, 0.22);
            padding: 12px 14px;
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.92);
            resize: none;
            outline: none;
            transition: border-color 0.18s ease, box-shadow 0.18s ease;
            overflow-y: auto;
            overflow-x: hidden;
            word-wrap: break-word;
            white-space: pre-wrap;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .chat-input::-webkit-scrollbar { width: 0; height: 0; display: none; }
        .chat-input:focus {
            border-color: rgba(16, 185, 129, 0.45);
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.12);
        }
        .chat-send {
            width: 44px;
            height: 44px;
            border-radius: 16px;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: var(--accent-green);
            color: #ffffff;
            transition: transform 0.16s ease-out, background 0.18s ease-out, box-shadow 0.18s ease-out;
            box-shadow: 0 10px 24px rgba(16, 185, 129, 0.28);
            flex-shrink: 0;
        }
        .chat-send:hover { background: #059669; }
        .chat-send:active { transform: scale(0.96); }
        .chat-send svg { width: 18px; height: 18px; stroke: currentColor; fill: none; stroke-width: 2; }

        .quick-hints {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }
        .quick-hint {
            font-size: 11px;
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.20);
            background: rgba(255, 255, 255, 0.92);
            color: rgba(51, 65, 85, 0.92);
            cursor: pointer;
            transition: all 0.18s ease-out;
            user-select: none;
        }
        .quick-hint:hover { border-color: rgba(16, 185, 129, 0.35); color: rgba(5, 150, 105, 1); }
        .quick-hint:active { transform: scale(0.98); }

        .mcp-log-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: var(--right-panel-width);
            height: 100vh;
            background: #FFFFFF;
            border-left: none;
            display: flex;
            flex-direction: column;
            z-index: 100;
            box-shadow: -18px 0 54px rgba(15, 23, 42, 0.08);
        }

        .mcp-log-shell {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        .mcp-log-header {
            position: relative;
            z-index: 1;
            padding: 14px 14px 12px;
            border-bottom: none;
            background: #FFFFFF;
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 10px;
        }
        .mcp-log-title {
            font-size: 13px;
            font-weight: 850;
            color: #0f172a;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            line-height: 1.2;
        }
        .mcp-log-title::before {
            content: "";
            width: 3px;
            height: 14px;
            border-radius: 2px;
            background: linear-gradient(180deg, rgba(245, 158, 11, 1), rgba(239, 68, 68, 1));
        }
        .mcp-log-sub {
            font-size: 11px;
            color: var(--text-tertiary);
            margin-top: 6px;
        }
        .mcp-log-actions {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
            flex-shrink: 0;
        }
        .mcp-log-actions-row {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 8px;
        }
        .mcp-log-toggle {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 650;
            user-select: none;
            white-space: nowrap;
        }
        .mcp-log-toggle input { accent-color: var(--accent-green); }
        .mcp-log-btn {
            height: 32px;
            padding: 0 10px;
            border-radius: 12px;
            border: none;
            background: rgba(15, 23, 42, 0.06);
            cursor: pointer;
            transition: all 0.18s ease-out;
            font-size: 11px;
            font-weight: 800;
            color: rgba(51, 65, 85, 0.92);
            user-select: none;
        }
        .mcp-log-btn:hover {
            box-shadow: 0 10px 24px rgba(15, 23, 42, 0.10);
            transform: translateY(-1px);
        }
        .mcp-log-btn:active { transform: translateY(0) scale(0.99); }
        .mcp-log-btn.danger:hover { border-color: rgba(239, 68, 68, 0.35); color: rgba(220, 38, 38, 1); }

        .mcp-log-filters {
            position: relative;
            z-index: 1;
            padding: 10px 14px 12px;
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px;
            border-bottom: none;
            background: rgba(245, 250, 255, 0.9);
        }
        .mcp-log-field { display: flex; flex-direction: column; gap: 6px; min-width: 0; }
        .mcp-log-label { font-size: 10px; color: var(--text-tertiary); font-weight: 800; letter-spacing: 0.08em; }
        .mcp-log-input, .mcp-log-select {
            height: 34px;
            border-radius: 12px;
            border: none;
            background: rgba(15, 23, 42, 0.05);
            padding: 0 10px;
            font-size: 12px;
            color: var(--text-primary);
            outline: none;
            transition: border-color 0.18s ease, box-shadow 0.18s ease;
            width: 100%;
        }
        .mcp-log-input:focus, .mcp-log-select:focus {
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.12);
        }

        .mcp-log-body {
            position: relative;
            z-index: 1;
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 10px 12px 12px;
            background: #FFFFFF;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
        }
        .mcp-log-body::-webkit-scrollbar { width: 6px; }
        .mcp-log-body::-webkit-scrollbar-track { background: rgba(241, 245, 249, 0.5); }
        .mcp-log-body::-webkit-scrollbar-thumb { background: rgba(148, 163, 184, 0.4); border-radius: 3px; }
        .mcp-log-body::-webkit-scrollbar-thumb:hover { background: rgba(148, 163, 184, 0.6); }

        .mcp-log-list { display: flex; flex-direction: column; gap: 0; margin-top: auto; }

        .mcp-log-entry {
            border: none;
            background: #FFFFFF;
            border-radius: 0;
            overflow: hidden;
            animation: logFadeIn 0.22s ease-out;
            transition: background 0.18s ease-out;
            padding: 0;
        }
        .mcp-log-entry:hover {
            background: #FFFFFF;
        }
        @keyframes logFadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .mcp-log-line {
            display: flex;
            align-items: flex-start;
            justify-content: flex-start;
            gap: 8px;
            padding: 6px 12px;
            flex-direction: row;
            border-bottom: none;
        }
        .mcp-log-entry:last-child .mcp-log-line {
            border-bottom: none;
        }
        .mcp-log-line code {
            flex: 1;
            min-width: 0;
            font-family: 'SF Mono', Monaco, Consolas, 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.6;
            color: rgba(15, 23, 42, 0.92);
            white-space: pre-wrap;
            word-break: break-word;
            text-align: left;
        }
        .log-ts { color: rgba(100, 116, 139, 0.75); font-size: 11px; }
        .log-ts-ms { color: rgba(148, 163, 184, 0.65); font-size: 10px; }
        .log-lv { font-weight: 900; letter-spacing: 0.04em; }
        .log-lv.info { color: #4CAF50; }
        .log-lv.warning { color: #FF9800; }
        .log-lv.error { color: #F44336; }
        .log-path { color: #2196F3; text-decoration: none; }
        .log-path:hover { text-decoration: underline; }
        .log-msg { color: rgba(15, 23, 42, 0.92); }
        .log-http { font-weight: 900; letter-spacing: 0.04em; }
        .log-http.ok { color: #4CAF50; }
        .log-http.warn { color: #FF9800; }
        .log-http.err { color: #F44336; }
        .log-url { color: #2196F3; word-break: break-all; }
        .log-url:hover { text-decoration: underline; cursor: pointer; }
        .log-svc { color: rgba(15, 23, 42, 0.70); font-weight: 800; }
        .log-status { color: rgba(15, 23, 42, 0.62); font-weight: 900; letter-spacing: 0.04em; }

        /* 语法高亮 - JSON */
        .log-json-punct { color: rgba(15, 23, 42, 0.70); }
        .log-json-key { color: #2196F3; font-weight: 700; }
        .log-json-string { color: #4CAF50; }
        .log-json-number { color: #FF9800; }
        .log-json-boolean { color: #9C27B0; font-weight: 700; }
        .log-json-null { color: #607D8B; font-weight: 700; }
        /* 语法高亮 - 代码 */
        .log-code-keyword { color: #9C27B0; font-weight: 700; }
        .log-code-string { color: #4CAF50; }
        .log-code-number { color: #FF9800; }
        .log-code-comment { color: #607D8B; font-style: italic; }
        .log-code-function { color: #2196F3; }
        .log-code-variable { color: #E91E63; }
        .log-code-operator { color: #00BCD4; }
        .log-code-tag { color: #F44336; }
        .log-code-attr { color: #FF9800; }
        .log-code-value { color: #4CAF50; }

        .mcp-log-line-actions {
            display: none;
        }
        .mcp-log-mini {
            width: 30px;
            height: 30px;
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.20);
            background: rgba(248, 250, 252, 0.88);
            cursor: pointer;
            transition: all 0.16s ease-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: rgba(51, 65, 85, 0.92);
            user-select: none;
        }
        .mcp-log-mini:hover { border-color: rgba(148, 163, 184, 0.34); transform: translateY(-1px); }
        .mcp-log-mini:active { transform: translateY(0) scale(0.98); }
        .mcp-log-mini svg { width: 16px; height: 16px; stroke: currentColor; fill: none; stroke-width: 1.8; }

        .mcp-log-stack {
            display: block;
            padding: 8px 12px 10px;
            border-top: none;
            background: rgba(248, 250, 252, 0.95);
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: max-height 0.22s ease-out, opacity 0.18s ease-out;
            margin-left: 24px;
        }
        .mcp-log-entry.expanded .mcp-log-stack {
            max-height: 520px;
            opacity: 1;
        }
        .mcp-log-stack pre {
            margin: 0;
            font-family: 'SF Mono', Monaco, Consolas, 'Courier New', monospace;
            font-size: 11px;
            line-height: 1.6;
            color: rgba(15, 23, 42, 0.86);
            white-space: pre-wrap;
            word-break: break-word;
            text-align: left;
            background: transparent;
        }

        .mcp-log-footer {
            position: relative;
            z-index: 1;
            padding: 10px 14px 12px;
            border-top: none;
            background: #FFFFFF;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }
        .mcp-log-stats {
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 700;
            white-space: nowrap;
        }
        .mcp-log-stats code {
            font-family: 'SF Mono', Monaco, Consolas, monospace;
            font-size: 11px;
            color: rgba(15, 23, 42, 0.86);
        }

        /* =========================
           多功能选择区：按照 mcp/modules 分类排列操作按钮
           ========================= */
        .mcp-actions {
            border-radius: 20px;
            border: 1px solid rgba(148, 163, 184, 0.22);
            background: rgba(255, 255, 255, 0.82);
            box-shadow: 0 12px 34px rgba(15, 23, 42, 0.08);
            overflow: hidden;
            backdrop-filter: blur(14px);
            -webkit-backdrop-filter: blur(14px);
        }
        .mcp-actions-header {
            padding: 14px 18px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.18);
            background: linear-gradient(180deg, rgba(248, 250, 252, 0.92), rgba(255, 255, 255, 0.68));
        }
        .mcp-actions-title {
            font-size: 13px;
            font-weight: 800;
            color: #0f172a;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .mcp-actions-title::before {
            content: "";
            width: 3px;
            height: 14px;
            border-radius: 2px;
            background: linear-gradient(180deg, rgba(16, 185, 129, 1), rgba(6, 182, 212, 1));
        }
        .mcp-actions-sub {
            font-size: 11px;
            color: var(--text-tertiary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .mcp-actions-body { padding: 14px 16px 18px; }

        .mcp-tools-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 0 2px 12px;
        }
        .mcp-tools-toolbar-left {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 0;
            flex: 1;
        }
        .mcp-tools-search {
            flex: 1;
            min-width: 0;
            height: 36px;
            border-radius: 14px;
            border: 1px solid rgba(148, 163, 184, 0.22);
            background: rgba(255, 255, 255, 0.92);
            padding: 0 12px;
            font-size: 12px;
            color: var(--text-primary);
            outline: none;
            transition: border-color 0.18s ease, box-shadow 0.18s ease;
        }
        .mcp-tools-search:focus {
            border-color: rgba(16, 185, 129, 0.45);
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.12);
        }
        .mcp-tools-toolbar-right {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }
        .mcp-chip {
            font-size: 10px;
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.22);
            background: rgba(248, 250, 252, 0.86);
            color: #334155;
            font-weight: 900;
            letter-spacing: 0.06em;
        }

        .action-groups {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        /* 常用工具快捷入口 */
        .quick-tools-section {
            background: linear-gradient(135deg, rgba(16,185,129,0.08), rgba(6,182,212,0.06));
            border: 1px solid rgba(16,185,129,0.2);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .quick-tools-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        .quick-tools-title {
            font-size: 13px;
            font-weight: 800;
            color: #059669;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .quick-tools-badge {
            font-size: 10px;
            padding: 3px 8px;
            background: rgba(16,185,129,0.15);
            color: #059669;
            border-radius: 6px;
            font-weight: 700;
        }
        .quick-tools-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        .quick-tool-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 12px 8px;
            border-radius: 12px;
            border: 1px solid rgba(16,185,129,0.15);
            background: rgba(255,255,255,0.9);
            cursor: pointer;
            transition: all 0.2s;
        }
        .quick-tool-btn:hover {
            background: #fff;
            border-color: rgba(16,185,129,0.4);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16,185,129,0.15);
        }
        .quick-tool-btn.selected {
            background: linear-gradient(135deg, rgba(16,185,129,0.15), rgba(6,182,212,0.12));
            border-color: rgba(16,185,129,0.5);
        }
        .quick-tool-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        .quick-tool-name {
            font-size: 11px;
            font-weight: 700;
            color: #334155;
            text-align: center;
        }

        /* 分类颜色标识 */
        .action-group[data-category="recon"] .action-group-header { border-left: 3px solid #3b82f6; }
        .action-group[data-category="vuln_scan"] .action-group-header { border-left: 3px solid #f59e0b; }
        .action-group[data-category="web_attack"] .action-group-header { border-left: 3px solid #ef4444; }
        .action-group[data-category="network"] .action-group-header { border-left: 3px solid #8b5cf6; }
        .action-group[data-category="exploit"] .action-group-header { border-left: 3px solid #ec4899; }
        .action-group[data-category="post_exploit"] .action-group-header { border-left: 3px solid #14b8a6; }
        .action-group[data-category="cloud"] .action-group-header { border-left: 3px solid #06b6d4; }
        .action-group[data-category="ai"] .action-group-header { border-left: 3px solid #10b981; }

        /* 分类标签 */
        .category-tag {
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 700;
            letter-spacing: 0.03em;
        }
        .category-tag.recon { background: rgba(59,130,246,0.12); color: #2563eb; }
        .category-tag.vuln { background: rgba(245,158,11,0.12); color: #d97706; }
        .category-tag.attack { background: rgba(239,68,68,0.12); color: #dc2626; }
        .category-tag.network { background: rgba(139,92,246,0.12); color: #7c3aed; }
        .category-tag.exploit { background: rgba(236,72,153,0.12); color: #db2777; }
        .category-tag.post { background: rgba(20,184,166,0.12); color: #0d9488; }
        .category-tag.ai { background: rgba(16,185,129,0.12); color: #059669; }

        /* 工具计数徽章 */
        .tool-count-badge {
            font-size: 10px;
            padding: 2px 8px;
            background: rgba(148,163,184,0.12);
            color: #64748b;
            border-radius: 10px;
            font-weight: 700;
        }

        /* 折叠分类 */
        .action-group.collapsed .action-grid {
            display: none;
        }
        .action-group-toggle {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            border: none;
            background: rgba(148,163,184,0.1);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .action-group-toggle:hover {
            background: rgba(148,163,184,0.2);
        }
        .action-group-toggle svg {
            width: 14px;
            height: 14px;
            stroke: #64748b;
            transition: transform 0.3s;
        }
        .action-group.collapsed .action-group-toggle svg {
            transform: rotate(-90deg);
        }

        /* 全部工具区域不需要特殊布局 */
        #mcpGroupAllTools {
            display: none; /* 默认隐藏，当有工具加载时再显示 */
        }
        #mcpGroupAllTools.has-tools {
            display: block;
        }
        .action-group {
            border: 1px solid rgba(148, 163, 184, 0.20);
            border-radius: 18px;
            background: rgba(255, 255, 255, 0.92);
            overflow: hidden;
            position: relative;
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out, border-color 0.2s ease-out;
        }
        .action-group:hover {
            transform: translateY(-1px);
            border-color: rgba(148, 163, 184, 0.34);
            box-shadow: 0 14px 38px rgba(15, 23, 42, 0.10);
        }
        .action-group-header {
            padding: 12px 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.16);
            background: rgba(248, 250, 252, 0.72);
        }
        .action-group-title {
            font-size: 12px;
            font-weight: 850;
            color: #0f172a;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .action-group-title svg { width: 16px; height: 16px; stroke: currentColor; fill: none; stroke-width: 1.8; }
        .action-group-meta { font-size: 10px; color: var(--text-tertiary); font-weight: 650; letter-spacing: 0.06em; }

        .action-grid {
            padding: 12px 12px 14px;
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px;
        }

        .action-btn {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 10px;
            text-align: left;
            padding: 12px 12px;
            border-radius: 14px;
            border: 1px solid rgba(148, 163, 184, 0.20);
            background: rgba(255, 255, 255, 0.94);
            cursor: pointer;
            transition: transform 0.16s ease-out, box-shadow 0.18s ease-out, border-color 0.18s ease-out, background 0.18s ease-out;
            user-select: none;
            min-height: 52px;
        }
        .action-btn:hover {
            border-color: rgba(16, 185, 129, 0.38);
            box-shadow: 0 12px 28px rgba(15, 23, 42, 0.10);
            transform: translateY(-1px);
        }
        .action-btn:active { transform: translateY(0) scale(0.99); }
        .action-btn.selected {
            border-color: rgba(16, 185, 129, 0.55);
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.12), rgba(6, 182, 212, 0.10));
            box-shadow: 0 14px 34px rgba(16, 185, 129, 0.16);
        }
        .action-icon {
            width: 34px;
            height: 34px;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: rgba(16, 185, 129, 1);
            background: rgba(16, 185, 129, 0.10);
            flex-shrink: 0;
        }
        .action-btn.selected .action-icon {
            background: rgba(16, 185, 129, 0.14);
            color: rgba(5, 150, 105, 1);
        }
        .action-icon svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
            fill: none;
            stroke-width: 1.8;
        }
        .action-text { min-width: 0; display: flex; flex-direction: column; gap: 2px; }
        .action-title { font-size: 12px; font-weight: 800; color: #0f172a; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .action-desc { font-size: 10px; font-weight: 650; color: var(--text-tertiary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* =========================
           可视化结果展示样式
           ========================= */
        
        /* 扫描结果卡片 */
        .scan-result-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(248,250,252,0.9));
            border: 1px solid rgba(148,163,184,0.2);
            border-radius: 16px;
            padding: 20px;
            margin: 12px 0;
            box-shadow: 0 4px 20px rgba(15,23,42,0.06);
            backdrop-filter: blur(10px);
        }
        
        /* 目标标题 */
        .scan-target-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            padding-bottom: 14px;
            border-bottom: 1px solid rgba(148,163,184,0.15);
        }
        .scan-target-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
        }
        .scan-target-info { flex: 1; min-width: 0; }
        .scan-target-name {
            font-size: 15px;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 4px;
        }
        .scan-target-type {
            font-size: 11px;
            color: var(--text-tertiary);
        }
        
        /* 安全状态徽章 */
        .security-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
        }
        .security-badge.risk-high {
            background: linear-gradient(135deg, rgba(239,68,68,0.15), rgba(220,38,38,0.1));
            color: #dc2626;
            border: 1px solid rgba(239,68,68,0.3);
        }
        .security-badge.risk-medium {
            background: linear-gradient(135deg, rgba(245,158,11,0.15), rgba(217,119,6,0.1));
            color: #d97706;
            border: 1px solid rgba(245,158,11,0.3);
        }
        .security-badge.risk-low {
            background: linear-gradient(135deg, rgba(16,185,129,0.15), rgba(5,150,105,0.1));
            color: #059669;
            border: 1px solid rgba(16,185,129,0.3);
        }
        
        /* 状态摘要 */
        .scan-summary {
            background: rgba(241,245,249,0.6);
            border-radius: 12px;
            padding: 14px 16px;
            margin: 14px 0;
            font-size: 13px;
            color: #334155;
            line-height: 1.6;
        }
        .scan-summary strong { color: #0f172a; }
        
        /* 端口/服务列表 */
        .port-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 14px 0;
        }
        .port-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
            background: rgba(255,255,255,0.8);
            border: 1px solid rgba(148,163,184,0.15);
            border-radius: 10px;
            transition: all 0.2s;
        }
        .port-item:hover {
            background: #fff;
            box-shadow: 0 4px 12px rgba(15,23,42,0.08);
            transform: translateX(4px);
        }
        .port-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .port-dot.safe { background: #10b981; box-shadow: 0 0 8px rgba(16,185,129,0.4); }
        .port-dot.warning { background: #f59e0b; box-shadow: 0 0 8px rgba(245,158,11,0.4); }
        .port-dot.danger { background: #ef4444; box-shadow: 0 0 8px rgba(239,68,68,0.4); }
        .port-dot.info { background: #3b82f6; box-shadow: 0 0 8px rgba(59,130,246,0.4); }
        
        .port-info { flex: 1; min-width: 0; }
        .port-number {
            font-size: 13px;
            font-weight: 700;
            color: #0f172a;
        }
        .port-service {
            font-size: 11px;
            color: var(--text-tertiary);
            margin-top: 2px;
        }
        .port-tag {
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 6px;
            background: rgba(148,163,184,0.12);
            color: #64748b;
        }
        
        /* 建议操作区 */
        .suggestion-section {
            margin-top: 18px;
            padding-top: 16px;
            border-top: 1px dashed rgba(148,163,184,0.25);
        }
        .suggestion-title {
            font-size: 12px;
            font-weight: 700;
            color: #475569;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .suggestion-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .suggestion-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            font-size: 12px;
            color: #334155;
            line-height: 1.5;
        }
        .suggestion-num {
            width: 20px;
            height: 20px;
            border-radius: 6px;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-cyan));
            color: #fff;
            font-size: 10px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        /* 操作按钮组 */
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 16px;
        }
        .action-btn-viz {
            padding: 10px 18px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border: none;
        }
        .action-btn-viz.primary {
            background: linear-gradient(135deg, var(--accent-green), var(--accent-cyan));
            color: #fff;
            box-shadow: 0 4px 14px rgba(16,185,129,0.3);
        }
        .action-btn-viz.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16,185,129,0.4);
        }
        .action-btn-viz.secondary {
            background: rgba(148,163,184,0.1);
            color: #475569;
            border: 1px solid rgba(148,163,184,0.2);
        }
        .action-btn-viz.secondary:hover {
            background: rgba(148,163,184,0.18);
        }
        .action-btn-viz.danger {
            background: rgba(239,68,68,0.1);
            color: #dc2626;
            border: 1px solid rgba(239,68,68,0.2);
        }
        .action-btn-viz.danger:hover {
            background: rgba(239,68,68,0.18);
        }
        
        /* 术语解释悬浮框 */
        .term-tooltip {
            position: relative;
            border-bottom: 1px dashed #94a3b8;
            cursor: help;
        }
        .term-tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1e293b;
            color: #fff;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 11px;
            white-space: nowrap;
            max-width: 260px;
            white-space: normal;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
            z-index: 100;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            pointer-events: none;
        }
        .term-tooltip:hover::after {
            opacity: 1;
            visibility: visible;
            bottom: calc(100% + 6px);
        }
        
        /* 进度指示器 */
        .scan-progress {
            margin: 16px 0;
        }
        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .progress-label {
            font-size: 12px;
            color: #475569;
            font-weight: 600;
        }
        .progress-value {
            font-size: 11px;
            color: var(--text-tertiary);
        }
        .progress-bar {
            height: 8px;
            background: rgba(148,163,184,0.15);
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        .progress-fill.success { background: linear-gradient(90deg, #10b981, #34d399); }
        .progress-fill.warning { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
        .progress-fill.danger { background: linear-gradient(90deg, #ef4444, #f87171); }
        
        /* 分步骤引导 */
        .step-guide {
            display: flex;
            align-items: center;
            gap: 0;
            margin: 16px 0;
            padding: 0 10px;
        }
        .step-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            position: relative;
        }
        .step-item:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 16px;
            left: calc(50% + 20px);
            width: calc(100% - 40px);
            height: 2px;
            background: rgba(148,163,184,0.2);
        }
        .step-item.active:not(:last-child)::after,
        .step-item.done:not(:last-child)::after {
            background: linear-gradient(90deg, var(--accent-green), var(--accent-cyan));
        }
        .step-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            background: rgba(148,163,184,0.15);
            color: #64748b;
            position: relative;
            z-index: 1;
            transition: all 0.3s;
        }
        .step-item.active .step-circle,
        .step-item.done .step-circle {
            background: linear-gradient(135deg, var(--accent-green), var(--accent-cyan));
            color: #fff;
            box-shadow: 0 4px 14px rgba(16,185,129,0.35);
        }
        .step-label {
            font-size: 10px;
            color: var(--text-tertiary);
            margin-top: 8px;
            text-align: center;
        }
        .step-item.active .step-label,
        .step-item.done .step-label {
            color: var(--accent-green);
            font-weight: 600;
        }
        
        /* 饼图容器 */
        .chart-container {
            display: flex;
            align-items: center;
            gap: 20px;
            margin: 16px 0;
            padding: 16px;
            background: rgba(241,245,249,0.5);
            border-radius: 12px;
        }
        .pie-chart {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .chart-legend {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            color: #475569;
        }
        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 3px;
        }
        
        /* 解释按钮 */
        .explain-btn {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: rgba(59,130,246,0.1);
            color: #3b82f6;
            border: 1px solid rgba(59,130,246,0.2);
            border-radius: 6px;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .explain-btn:hover {
            background: rgba(59,130,246,0.18);
        }
        
        /* 技术详情折叠 */
        .tech-details {
            margin-top: 14px;
        }
        .tech-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: rgba(148,163,184,0.08);
            border: 1px solid rgba(148,163,184,0.15);
            border-radius: 8px;
            font-size: 11px;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }
        .tech-toggle:hover {
            background: rgba(148,163,184,0.15);
        }
        .tech-toggle svg {
            width: 14px;
            height: 14px;
            transition: transform 0.3s;
        }
        .tech-toggle.expanded svg {
            transform: rotate(180deg);
        }
        .tech-content {
            display: none;
            margin-top: 10px;
            padding: 12px;
            background: rgba(15,23,42,0.03);
            border-radius: 8px;
            font-size: 11px;
            font-family: 'JetBrains Mono', monospace;
            overflow-x: auto;
        }
        .tech-content.show {
            display: block;
        }

        /* =========================
           响应式
           ========================= */
        @media (max-width: 980px) {
            .chat-hint { max-width: 46vw; }
        }
        @media (max-width: 768px) {
            .ai-chat-page { padding: 14px 14px 22px; }
            .hero-status { display: none; }
            .action-grid { grid-template-columns: 1fr; }
            .chat-hint { display: none; }
            .mcp-log-filters { grid-template-columns: 1fr; }
            .quick-tools-grid { grid-template-columns: repeat(4, 1fr); gap: 8px; }
            .quick-tool-btn { padding: 10px 6px; }
            .quick-tool-icon { width: 30px; height: 30px; font-size: 16px; }
            .quick-tool-name { font-size: 10px; }
        }

        @media (max-width: 1024px) {
            .main-layout { margin-right: 0 !important; }
            .mcp-log-panel {
                position: relative;
                top: auto;
                right: auto;
                width: 100%;
                height: auto;
                border-left: none;
                border-top: 1px solid var(--border-color);
            }
            .mcp-log-shell { height: 560px; }
        }
    </style>
</head>
<body>
    <!-- =========================
         左侧固定侧边栏（由 layout.js 动态加载 navbar 组件）
         必须保持固定宽度 + 可折叠
         ========================= -->
    <nav class="navbar" id="navbar" aria-label="主导航"></nav>

    <div class="main-layout">
        <main class="content" role="main">
            <!-- =========================
                 AI 对话主界面
                 ========================= -->
            <section class="ai-chat-page" id="aiChatPage">
                <!-- 顶部标题区 -->
                <header class="page-hero" aria-label="页面标题与状态">
                    <div class="hero-left">
                        <div class="hero-title">
                            <span>AI 对话助手</span>
                        </div>
                        <div class="hero-sub">对接 MCP 模块：消息输入 + 工具选择 + 后续自动化执行接口预留</div>
                    </div>

                    <div class="hero-status" id="mcpServerStatusBar" aria-label="MCP 服务状态">
                        <span class="status-dot" id="mcpStatusDot"></span>
                        <span class="status-text" id="mcpStatusText">MCP 服务器：检测中…</span>
                    </div>
                </header>

                <!-- 对话框区域 -->
                <section class="chat-shell" aria-label="AI 对话框">
                    <!-- 对话头部 -->
                    <header class="chat-header">
                        <div style="min-width:0;">
                            <div class="chat-title">对话</div>
                            <div class="chat-hint" id="chatHint">提示：先在下方选择 MCP 工具，再描述目标与任务</div>
                        </div>
                        <div class="chat-header-right">
                            <span class="chat-chip" id="selectedToolsCountChip">TOOLS 0</span>
                            <span class="chat-chip" id="chatSessionChip">SESSION -</span>
                        </div>
                    </header>

                    <!-- 消息显示区（区分用户消息 / AI 回复） -->
                    <div class="chat-messages" id="chatMessages" role="log" aria-live="polite" aria-relevant="additions">
                        <div class="chat-message assistant" data-role="assistant">
                            <div class="chat-bubble">
                                你好，我是 AI 安全助手。<br />
                                你可以：选择下方 MCP 工具 → 输入目标与任务 → 发送给 MCP 服务进行处理。
                            </div>
                            <div class="chat-meta">assistant · <span data-time></span></div>
                        </div>
                    </div>

                    <!-- 输入与发送 -->
                    <footer class="chat-composer" aria-label="消息输入区">
                        <!-- 已选工具展示（用于后续功能对接） -->
                        <div class="selected-tools" id="selectedTools"></div>

                        <div class="composer-row">
                            <textarea
                                class="chat-input"
                                id="chatInput"
                                rows="1"
                                placeholder="输入问题或指令，例如：对 example.com 进行子域名枚举并扫描常见 Web 漏洞…"
                                aria-label="消息输入框"
                            ></textarea>
                            <button class="chat-send" id="chatSendBtn" type="button" aria-label="发送">
                                <svg viewBox="0 0 24 24"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" stroke-linejoin="round" stroke-linecap="round"/></svg>
                            </button>
                        </div>

                        <!-- 快捷提示（可用于后续 prompt/指令模板对接） -->
                        <div class="quick-hints" id="quickHints" aria-label="快捷指令">
                            <span class="quick-hint" data-quick="快速端口扫描目标">快速端口扫描</span>
                            <span class="quick-hint" data-quick="枚举目标子域名并探测存活">子域名+探测</span>
                            <span class="quick-hint" data-quick="进行 Web 漏洞扫描并输出摘要">Web 漏洞扫描</span>
                            <span class="quick-hint" data-quick="生成渗透测试攻击链与执行步骤">生成攻击链</span>
                        </div>
                    </footer>
                </section>

                <!-- =========================
                     多功能选择区（mcp/modules 功能分类按钮）
                     ========================= -->
                <section class="mcp-actions" id="mcpActions" aria-label="MCP 功能选择区">
                    <header class="mcp-actions-header">
                        <div style="min-width:0;">
                            <div class="mcp-actions-title">MCP 工具选择</div>
                            <div class="mcp-actions-sub">按 mcp/modules 分类展示；按钮预留 data-mcp-* 接口用于后续联动</div>
                        </div>
                    </header>

                    <div class="mcp-actions-body">
                        <div class="mcp-tools-toolbar" aria-label="工具搜索与状态">
                            <div class="mcp-tools-toolbar-left">
                                <input class="mcp-tools-search" id="mcpToolSearch" placeholder="搜索工具（名称/描述/类别）…" />
                            </div>
                            <div class="mcp-tools-toolbar-right">
                                <span class="mcp-chip" id="mcpToolsTotalChip">TOOLS -</span>
                                <button class="mcp-log-btn" id="refreshToolsBtn" type="button">刷新</button>
                            </div>
                        </div>
                        
                        <!-- 常用工具快捷入口 -->
                        <div class="quick-tools-section" id="quickToolsSection">
                            <div class="quick-tools-header">
                                <div class="quick-tools-title">
                                    ⚡ 常用工具
                                </div>
                                <span class="quick-tools-badge">快速开始</span>
                            </div>
                            <div class="quick-tools-grid" id="quickToolsGrid">
                                <button class="quick-tool-btn" type="button" data-mcp-tool="nmap_quick" title="快速扫描目标端口">
                                    <div class="quick-tool-icon" style="background:linear-gradient(135deg,rgba(59,130,246,0.15),rgba(99,102,241,0.1));">🔍</div>
                                    <div class="quick-tool-name">端口扫描</div>
                                </button>
                                <button class="quick-tool-btn" type="button" data-mcp-tool="subfinder" title="枚举目标子域名">
                                    <div class="quick-tool-icon" style="background:linear-gradient(135deg,rgba(16,185,129,0.15),rgba(6,182,212,0.1));">🌐</div>
                                    <div class="quick-tool-name">子域名</div>
                                </button>
                                <button class="quick-tool-btn" type="button" data-mcp-tool="nuclei_scan" title="Nuclei 漏洞扫描">
                                    <div class="quick-tool-icon" style="background:linear-gradient(135deg,rgba(245,158,11,0.15),rgba(234,88,12,0.1));">🛡️</div>
                                    <div class="quick-tool-name">漏洞扫描</div>
                                </button>
                                <button class="quick-tool-btn" type="button" data-mcp-tool="httpx_probe" title="HTTP 服务探测">
                                    <div class="quick-tool-icon" style="background:linear-gradient(135deg,rgba(139,92,246,0.15),rgba(168,85,247,0.1));">📡</div>
                                    <div class="quick-tool-name">HTTP 探测</div>
                                </button>
                                <button class="quick-tool-btn" type="button" data-mcp-tool="gobuster" title="目录/文件扫描">
                                    <div class="quick-tool-icon" style="background:linear-gradient(135deg,rgba(239,68,68,0.15),rgba(220,38,38,0.1));">📂</div>
                                    <div class="quick-tool-name">目录扫描</div>
                                </button>
                                <button class="quick-tool-btn" type="button" data-mcp-tool="whatweb" title="识别网站技术栈">
                                    <div class="quick-tool-icon" style="background:linear-gradient(135deg,rgba(236,72,153,0.15),rgba(219,39,119,0.1));">📊</div>
                                    <div class="quick-tool-name">技术栈</div>
                                </button>
                                <button class="quick-tool-btn" type="button" data-mcp-tool="sqlmap" title="SQL 注入检测">
                                    <div class="quick-tool-icon" style="background:linear-gradient(135deg,rgba(234,88,12,0.15),rgba(194,65,12,0.1));">🗄️</div>
                                    <div class="quick-tool-name">SQL注入</div>
                                </button>
                                <button class="quick-tool-btn" type="button" data-mcp-tool="ai_attack_plan" title="AI 智能攻击规划">
                                    <div class="quick-tool-icon" style="background:linear-gradient(135deg,rgba(16,185,129,0.15),rgba(5,150,105,0.1));">🤖</div>
                                    <div class="quick-tool-name">AI规划</div>
                                </button>
                            </div>
                        </div>
                        
                        <div class="action-groups" id="mcpActionGroups">
                            <section class="action-group" id="mcpGroupAllTools" data-mcp-category="all" aria-label="全部工具">
                                <header class="action-group-header">
                                    <div class="action-group-title">
                                        <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="7"/><path d="M21 21l-4.35-4.35"/></svg>
                                        <span>全部工具</span>
                                    </div>
                                    <div class="action-group-meta" id="allToolsMeta">加载中…</div>
                                </header>
                                <div class="action-grid" id="allToolsGrid"></div>
                            </section>
                            <!-- recon -->
                            <section class="action-group" id="mcpGroupRecon" data-mcp-category="recon" data-category="recon" aria-label="信息收集 Recon">
                                <header class="action-group-header">
                                    <div class="action-group-title">
                                        <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="7"/><path d="M21 21l-4.35-4.35"/></svg>
                                        <span>信息收集</span>
                                        <span class="category-tag recon">RECON</span>
                                    </div>
                                    <div style="display:flex;align-items:center;gap:8px;">
                                        <span class="tool-count-badge">4 工具</span>
                                        <button class="action-group-toggle" type="button" onclick="toggleActionGroup(this)" title="展开/收起">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                                        </button>
                                    </div>
                                </header>
                                <div class="action-grid">
                                    <button class="action-btn" type="button" data-mcp-tool="subfinder" data-mcp-category="recon" data-mcp-label="子域名枚举">
                                        <span class="action-icon"><svg viewBox="0 0 24 24"><path d="M4 7h16M7 4v6M17 4v6M7 14h10M9 20h6"/></svg></span>
                                        <span class="action-text"><span class="action-title">子域名枚举</span><span class="action-desc">subfinder</span></span>
                                    </button>
                                    <button class="action-btn" type="button" data-mcp-tool="nmap_quick" data-mcp-category="recon" data-mcp-label="快速端口扫描">
                                        <span class="action-icon"><svg viewBox="0 0 24 24"><path d="M12 3v10"/><path d="M7 8l5 5 5-5"/><path d="M5 21h14"/></svg></span>
                                        <span class="action-text"><span class="action-title">快速端口扫描</span><span class="action-desc">nmap_quick</span></span>
                                    </button>
                                    <button class="action-btn" type="button" data-mcp-tool="httpx_probe" data-mcp-category="recon" data-mcp-label="HTTP 探测">
                                        <span class="action-icon"><svg viewBox="0 0 24 24"><path d="M4 12h16"/><path d="M12 4v16"/><path d="M7 7l10 10"/></svg></span>
                                        <span class="action-text"><span class="action-title">HTTP 探测</span><span class="action-desc">httpx_probe</span></span>
                                    </button>
                                    <button class="action-btn" type="button" data-mcp-tool="whatweb" data-mcp-category="recon" data-mcp-label="技术栈识别">
                                        <span class="action-icon"><svg viewBox="0 0 24 24"><path d="M4 6h16"/><path d="M4 12h10"/><path d="M4 18h16"/><path d="M16 10l4 2-4 2"/></svg></span>
                                        <span class="action-text"><span class="action-title">技术栈识别</span><span class="action-desc">whatweb</span></span>
                                    </button>
                                </div>
                            </section>

                            <!-- vuln_scan -->
                            <section class="action-group" id="mcpGroupVulnScan" data-mcp-category="vuln_scan" data-category="vuln_scan" aria-label="漏洞扫描 Vuln Scan">
                                <header class="action-group-header">
                                    <div class="action-group-title">
                                        <svg viewBox="0 0 24 24"><path d="M12 2l8 4v6c0 5-3.5 9.4-8 10-4.5-.6-8-5-8-10V6l8-4z"/><path d="M9 12l2 2 4-4"/></svg>
                                        <span>漏洞扫描</span>
                                        <span class="category-tag vuln">VULN</span>
                                    </div>
                                    <div style="display:flex;align-items:center;gap:8px;">
                                        <span class="tool-count-badge">4 工具</span>
                                        <button class="action-group-toggle" type="button" onclick="toggleActionGroup(this)" title="展开/收起">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                                        </button>
                                    </div>
                                </header>
                                <div class="action-grid">
                                    <button class="action-btn" type="button" data-mcp-tool="nuclei_scan" data-mcp-category="vuln_scan" data-mcp-label="Nuclei 扫描">
                                        <span class="action-icon"><svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V6l-8-4-8 4v6c0 6 8 10 8 10z"/></svg></span>
                                        <span class="action-text"><span class="action-title">Nuclei 扫描</span><span class="action-desc">nuclei_scan</span></span>
                                    </button>
                                    <button class="action-btn" type="button" data-mcp-tool="nikto_scan" data-mcp-category="vuln_scan" data-mcp-label="Nikto 扫描">
                                        <span class="action-icon"><svg viewBox="0 0 24 24"><path d="M4 4h16v12H4z"/><path d="M8 20h8"/><path d="M12 16v4"/></svg></span>
                                        <span class="action-text"><span class="action-title">Nikto 扫描</span><span class="action-desc">nikto_scan</span></span>
                                    </button>
                                    <button class="action-btn" type="button" data-mcp-tool="sslscan" data-mcp-category="vuln_scan" data-mcp-label="SSL 扫描">
                                        <span class="action-icon"><svg viewBox="0 0 24 24"><rect x="5" y="11" width="14" height="10" rx="2"/><path d="M8 11V8a4 4 0 0 1 8 0v3"/></svg></span>
                                        <span class="action-text"><span class="action-title">SSL 扫描</span><span class="action-desc">sslscan</span></span>
                                    </button>
                                    <button class="action-btn" type="button" data-mcp-tool="cve_search" data-mcp-category="vuln_scan" data-mcp-label="CVE 搜索">
                                        <span class="action-icon"><svg viewBox="0 0 24 24"><path d="M4 4h16v16H4z"/><path d="M8 8h8"/><path d="M8 12h8"/><path d="M8 16h5"/></svg></span>
                                        <span class="action-text"><span class="action-title">CVE 搜索</span><span class="action-desc">cve_search</span></span>
                                    </button>
                                </div>
                            </section>

                            <!-- web_attack -->
                            <section class="action-group" id="mcpGroupWebAttack" data-mcp-category="web_attack" data-category="web_attack" aria-label="Web 攻击 Web Attack">
                                <header class="action-group-header">
                                    <div class="action-group-title">
                                        <svg viewBox="0 0 24 24"><path d="M3 12s3-7 9-7 9 7 9 7-3 7-9 7-9-7-9-7z"/><circle cx="12" cy="12" r="2"/></svg>
                                        <span>Web 攻击</span>
                                        <span class="category-tag attack">ATTACK</span>
                                    </div>
                                    <div style="display:flex;align-items:center;gap:8px;">
                                        <span class="tool-count-badge">4 工具</span>
                                        <button class="action-group-toggle" type="button" onclick="toggleActionGroup(this)" title="展开/收起">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                                        </button>
                                    </div>
                                </header>
                                <div class="action-grid">
                                    <button class="action-btn" type="button" data-mcp-tool="gobuster" data-mcp-category="web_attack" data-mcp-label="目录扫描">
                                        <span class="action-icon"><svg viewBox="0 0 24 24"><path d="M3 7h18"/><path d="M6 7V5a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v2"/><path d="M6 7v14a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V7"/></svg></span>
                                        <span class="action-text"><span class="action-title">目录扫描</span><span class="action-desc">gobuster</span></span>
                                    </button>
                                    <button class="action-btn" type="button" data-mcp-tool="ffuf" data-mcp-category="web_attack" data-mcp-label="Fuzz 测试">
                                        <span class="action-icon"><svg viewBox="0 0 24 24"><path d="M12 2v4"/><path d="M12 18v4"/><path d="M4.93 4.93l2.83 2.83"/><path d="M16.24 16.24l2.83 2.83"/><path d="M2 12h4"/><path d="M18 12h4"/><path d="M4.93 19.07l2.83-2.83"/><path d="M16.24 7.76l2.83-2.83"/></svg></span>
                                        <span class="action-text"><span class="action-title">Fuzz 测试</span><span class="action-desc">ffuf</span></span>
                                    </button>
                                    <button class="action-btn" type="button" data-mcp-tool="sqlmap" data-mcp-category="web_attack" data-mcp-label="SQL 注入">
                                        <span class="action-icon"><svg viewBox="0 0 24 24"><path d="M5 6h14"/><path d="M7 6v12"/><path d="M17 6v12"/><path d="M5 18h14"/><path d="M9 10h6"/><path d="M9 14h6"/></svg></span>
                                        <span class="action-text"><span class="action-title">SQL 注入</span><span class="action-desc">sqlmap</span></span>
                                    </button>
                                    <button class="action-btn" type="button" data-mcp-tool="dalfox" data-mcp-category="web_attack" data-mcp-label="XSS 扫描">
                                        <span class="action-icon"><svg viewBox="0 0 24 24"><path d="M4 4l16 16"/><path d="M6 18l4-4"/><path d="M14 10l4-4"/><path d="M10 6l-4 4"/></svg></span>
                                        <span class="action-text"><span class="action-title">XSS 扫描</span><span class="action-desc">dalfox</span></span>
                                    </button>
                                </div>
                            </section>

                            <!-- network -->
                            <section class="action-group" id="mcpGroupNetwork" data-mcp-category="network" data-category="network" aria-label="网络攻击 Network">
                                <header class="action-group-header">
                                    <div class="action-group-title">
                                        <svg viewBox="0 0 24 24"><path d="M7 7h10v10H7z"/><path d="M3 12h4"/><path d="M17 12h4"/><path d="M12 3v4"/><path d="M12 17v4"/></svg>
                                        <span>网络攻击</span>
                                        <span class="category-tag network">NETWORK</span>
                                    </div>
                                    <div style="display:flex;align-items:center;gap:8px;">
                                        <span class="tool-count-badge">4 工具</span>
                                        <button class="action-group-toggle" type="button" onclick="toggleActionGroup(this)" title="展开/收起">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                                        </button>
                                    </div>
                                </header>
                                <div class="action-grid">
                                    <button class="action-btn" type="button" data-mcp-tool="hydra" data-mcp-category="network" data-mcp-label="密码爆破">
                                        <span class="action-icon"><svg viewBox="0 0 24 24"><path d="M12 11a4 4 0 1 0-4-4"/><path d="M8 21h8"/><path d="M10 21v-4a2 2 0 0 1 4 0v4"/><path d="M18 8h3"/></svg></span>
                                        <span class="action-text"><span class="action-title">密码爆破</span><span class="action-desc">hydra</span></span>
                                    </button>
                                    <button class="action-btn" type="button" data-mcp-tool="ssh_audit" data-mcp-category="network" data-mcp-label="SSH 审计">
                                        <span class="action-icon"><svg viewBox="0 0 24 24"><path d="M6 10V8a6 6 0 0 1 12 0v2"/><rect x="5" y="10" width="14" height="10" rx="2"/><path d="M12 14v2"/></svg></span>
                                        <span class="action-text"><span class="action-title">SSH 审计</span><span class="action-desc">ssh_audit</span></span>
                                    </button>
                                    <button class="action-btn" type="button" data-mcp-tool="enum4linux" data-mcp-category="network" data-mcp-label="SMB 枚举">
                                        <span class="action-icon"><svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="14" rx="2"/><path d="M7 21h10"/><path d="M12 18v3"/></svg></span>
                                        <span class="action-text"><span class="action-title">SMB 枚举</span><span class="action-desc">enum4linux</span></span>
                                    </button>
                                    <button class="action-btn" type="button" data-mcp-tool="crackmapexec" data-mcp-category="network" data-mcp-label="横向测试">
                                        <span class="action-icon"><svg viewBox="0 0 24 24"><path d="M10 14l2-2 2 2"/><path d="M12 12v8"/><path d="M4 6h16"/><path d="M6 6v12"/></svg></span>
                                        <span class="action-text"><span class="action-title">横向测试</span><span class="action-desc">crackmapexec</span></span>
                                    </button>
                                </div>
                            </section>

                            <!-- exploit -->
                            <section class="action-group" id="mcpGroupExploit" data-mcp-category="exploit" data-category="exploit" aria-label="漏洞利用 Exploit">
                                <header class="action-group-header">
                                    <div class="action-group-title">
                                        <svg viewBox="0 0 24 24"><path d="M12 2l3 7 7 3-7 3-3 7-3-7-7-3 7-3 3-7z"/></svg>
                                        <span>漏洞利用</span>
                                        <span class="category-tag exploit">EXPLOIT</span>
                                    </div>
                                    <div style="display:flex;align-items:center;gap:8px;">
                                        <span class="tool-count-badge">4 工具</span>
                                        <button class="action-group-toggle" type="button" onclick="toggleActionGroup(this)" title="展开/收起">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                                        </button>
                                    </div>
                                </header>
                                <div class="action-grid">
                                    <button class="action-btn" type="button" data-mcp-tool="metasploit" data-mcp-category="exploit" data-mcp-label="Metasploit">
                                        <span class="action-icon"><svg viewBox="0 0 24 24"><path d="M12 2v20"/><path d="M2 12h20"/><path d="M7 7l10 10"/><path d="M17 7L7 17"/></svg></span>
                                        <span class="action-text"><span class="action-title">Metasploit</span><span class="action-desc">metasploit</span></span>
                                    </button>
                                    <button class="action-btn" type="button" data-mcp-tool="msfvenom" data-mcp-category="exploit" data-mcp-label="Payload 生成">
                                        <span class="action-icon"><svg viewBox="0 0 24 24"><path d="M8 5h8"/><path d="M9 3h6"/><path d="M7 5l-2 4 7 13 7-13-2-4"/><path d="M10 12h4"/></svg></span>
                                        <span class="action-text"><span class="action-title">Payload 生成</span><span class="action-desc">msfvenom</span></span>
                                    </button>
                                    <button class="action-btn" type="button" data-mcp-tool="reverse_shell" data-mcp-category="exploit" data-mcp-label="反弹 Shell">
                                        <span class="action-icon"><svg viewBox="0 0 24 24"><path d="M7 9l3 3-3 3"/><path d="M12 15h5"/><path d="M4 4h16v16H4z"/></svg></span>
                                        <span class="action-text"><span class="action-title">反弹 Shell</span><span class="action-desc">reverse_shell</span></span>
                                    </button>
                                    <button class="action-btn" type="button" data-mcp-tool="msf_search" data-mcp-category="exploit" data-mcp-label="模块搜索">
                                        <span class="action-icon"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="7"/><path d="M21 21l-4.35-4.35"/></svg></span>
                                        <span class="action-text"><span class="action-title">模块搜索</span><span class="action-desc">msf_search</span></span>
                                    </button>
                                </div>
                            </section>

                            <!-- post_exploit -->
                            <section class="action-group" id="mcpGroupPostExploit" data-mcp-category="post_exploit" data-category="post_exploit" aria-label="后渗透 Post Exploit">
                                <header class="action-group-header">
                                    <div class="action-group-title">
                                        <svg viewBox="0 0 24 24"><path d="M12 2l9 4v6c0 5-4 9.5-9 10-5-.5-9-5-9-10V6l9-4z"/><path d="M9 12h6"/><path d="M12 9v6"/></svg>
                                        <span>后渗透</span>
                                        <span class="category-tag post">POST</span>
                                    </div>
                                    <div style="display:flex;align-items:center;gap:8px;">
                                        <span class="tool-count-badge">4 工具</span>
                                        <button class="action-group-toggle" type="button" onclick="toggleActionGroup(this)" title="展开/收起">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                                        </button>
                                    </div>
                                </header>
                                <div class="action-grid">
                                    <button class="action-btn" type="button" data-mcp-tool="linenum" data-mcp-category="post_exploit" data-mcp-label="Linux 枚举">
                                        <span class="action-icon"><svg viewBox="0 0 24 24"><path d="M4 5h16v10H4z"/><path d="M8 19h8"/><path d="M12 15v4"/></svg></span>
                                        <span class="action-text"><span class="action-title">Linux 枚举</span><span class="action-desc">linenum</span></span>
                                    </button>
                                    <button class="action-btn" type="button" data-mcp-tool="linpeas" data-mcp-category="post_exploit" data-mcp-label="提权检查">
                                        <span class="action-icon"><svg viewBox="0 0 24 24"><path d="M12 2l3 7 7 3-7 3-3 7-3-7-7-3 7-3 3-7z"/></svg></span>
                                        <span class="action-text"><span class="action-title">提权检查</span><span class="action-desc">linpeas</span></span>
                                    </button>
                                    <button class="action-btn" type="button" data-mcp-tool="winpeas" data-mcp-category="post_exploit" data-mcp-label="Windows 提权">
                                        <span class="action-icon"><svg viewBox="0 0 24 24"><path d="M3 4l8-1v9H3z"/><path d="M13 3l8-1v10h-8z"/><path d="M3 13h8v9l-8-1z"/><path d="M13 13h8v10l-8-1z"/></svg></span>
                                        <span class="action-text"><span class="action-title">Windows 提权</span><span class="action-desc">winpeas</span></span>
                                    </button>
                                    <button class="action-btn" type="button" data-mcp-tool="linux_exploit_suggester" data-mcp-category="post_exploit" data-mcp-label="漏洞建议">
                                        <span class="action-icon"><svg viewBox="0 0 24 24"><path d="M12 3v10"/><path d="M9 13l3 3 3-3"/><path d="M5 21h14"/></svg></span>
                                        <span class="action-text"><span class="action-title">漏洞建议</span><span class="action-desc">linux_exploit_suggester</span></span>
                                    </button>
                                </div>
                            </section>

                        </div>
                    </div>
                </section>
            </section>
        </main>
    </div>

    <!-- 右侧 MCP 日志面板（布局对齐 getshell.html 的右侧 AI 面板） -->
    <aside class="mcp-log-panel" id="mcpLogPanel" aria-label="MCP 日志面板">
        <section class="mcp-log-shell" id="mcpLogShell" aria-label="MCP 服务调用日志">
            <header class="mcp-log-header">
                <div style="min-width:0;">
                    <div class="mcp-log-title">MCP 服务调用日志</div>
                    <div class="mcp-log-sub">保留最近 <strong>1000</strong> 条 · 支持筛选/复制/展开堆栈</div>
                </div>
                <div class="mcp-log-actions" aria-label="日志操作">
                    <div class="mcp-log-actions-row">
                        <label class="mcp-log-toggle" title="暂停/恢复自动刷新日志">
                            <input type="checkbox" id="logAutoScroll" checked />
                            <span>自动刷新</span>
                        </label>
                        <button class="mcp-log-btn danger" id="logClearBtn" type="button">清除</button>
                    </div>
                    <div class="mcp-log-actions-row">
                        <button class="mcp-log-btn" id="logCopyFilteredBtn" type="button">复制筛选</button>
                        <button class="mcp-log-btn" id="logCopyAllBtn" type="button">复制全部</button>
                        <button class="mcp-log-btn" id="logExportFilteredBtn" type="button">导出</button>
                    </div>
                </div>
            </header>

            <div class="mcp-log-filters" aria-label="日志筛选">
                <div class="mcp-log-field">
                    <div class="mcp-log-label">SERVICE</div>
                    <select class="mcp-log-select" id="logFilterService">
                        <option value="">全部</option>
                    </select>
                </div>
                <div class="mcp-log-field">
                    <div class="mcp-log-label">STATUS</div>
                    <select class="mcp-log-select" id="logFilterStatus">
                        <option value="">全部</option>
                        <option value="RUNNING">RUNNING</option>
                        <option value="SUCCESS">SUCCESS</option>
                        <option value="ERROR">ERROR</option>
                        <option value="WARNING">WARNING</option>
                        <option value="INFO">INFO</option>
                    </select>
                </div>
                <div class="mcp-log-field">
                    <div class="mcp-log-label">SEARCH</div>
                    <input class="mcp-log-input" id="logFilterSearch" placeholder="关键词（路径/参数/错误）…" />
                </div>
                <div class="mcp-log-field">
                    <div class="mcp-log-label">FROM</div>
                    <input class="mcp-log-input" id="logFilterFrom" type="datetime-local" />
                </div>
                <div class="mcp-log-field">
                    <div class="mcp-log-label">TO</div>
                    <input class="mcp-log-input" id="logFilterTo" type="datetime-local" />
                </div>
            </div>

            <div class="mcp-log-body" id="mcpLogBody" aria-label="日志内容">
                <div class="mcp-log-list" id="mcpLogList" role="log" aria-live="polite" aria-relevant="additions"></div>
            </div>

            <footer class="mcp-log-footer">
                <div class="mcp-log-stats" id="mcpLogStats">
                    条目: <code>0</code> · 可见: <code>0</code> · 丢弃: <code>0</code>
                </div>
                <div class="mcp-log-stats">
                    缓存上限: <code>1000</code> · 高频模式: <code>100/s</code>
                </div>
            </footer>
        </section>
    </aside>

    <script>
        /* =========================
           基础 JS 结构（用于后续 MCP 对接）
           ========================= */
        const MCP_ENDPOINTS = {
            baseUrl: 'http://api.hackapt.com:5000',
            health: '/health',
            chat: '/chat',
            tools: '/tools',
            execute: '/execute',
            events: '/events',
            aiAnalyze: '/ai/analyze',
            aiPlan: '/ai/plan',
            workflowAuto: '/workflow/auto',
            chainCreate: '/chain/create',
            reportGenerate: '/report/generate'
        };

        const MCPUIState = {
            sessionId: null,
            selectedTools: new Set(),
            lastMessageId: 0
        };

        const MCPLogState = {
            maxEntries: 1000,
            entries: [],
            dropped: 0,
            nextId: 0,
            services: new Set(),
            filters: {
                service: '',
                status: '',
                keyword: '',
                fromMs: null,
                toMs: null
            },
            autoScroll: true,
            pending: [],
            flushScheduled: false,
            rendered: new Map(),
            renderedOrder: []
        };

        const MCPLogDom = {
            list: null,
            body: null,
            stats: null,
            autoScroll: null,
            clearBtn: null,
            copyFilteredBtn: null,
            copyAllBtn: null,
            exportFilteredBtn: null,
            filterService: null,
            filterStatus: null,
            filterSearch: null,
            filterFrom: null,
            filterTo: null
        };

        const MCPToolState = {
            tools: [],
            toolsByName: new Map(),
            loaded: false
        };

        const MCPActionState = {
            nextId: 0,
            handlers: new Map()
        };

        function pad2(n) { return String(n).padStart(2, '0'); }

        function formatLogTimestamp(tsMs) {
            const d = new Date(tsMs);
            const yyyy = d.getFullYear();
            const MM = pad2(d.getMonth() + 1);
            const dd = pad2(d.getDate());
            const hh = pad2(d.getHours());
            const mm = pad2(d.getMinutes());
            const ss = pad2(d.getSeconds());
            const ms = String(d.getMilliseconds()).padStart(3, '0');
            return `${hh}:${mm}:${ss}.${ms}`;
        }

        function formatLogTimestampFull(tsMs) {
            const d = new Date(tsMs);
            const yyyy = d.getFullYear();
            const MM = pad2(d.getMonth() + 1);
            const dd = pad2(d.getDate());
            const hh = pad2(d.getHours());
            const mm = pad2(d.getMinutes());
            const ss = pad2(d.getSeconds());
            const ms = String(d.getMilliseconds()).padStart(3, '0');
            return `[${yyyy}-${MM}-${dd} ${hh}:${mm}:${ss}.${ms}]`;
        }

        function getHttpStatusClass(status) {
            const code = parseInt(status, 10);
            if (isNaN(code)) return '';
            if (code >= 200 && code < 300) return 'ok';
            if (code === 404) return 'warn';
            if (code >= 400) return 'err';
            return '';
        }

        // 代码语法高亮 - JSON
        function highlightJson(str) {
            if (!str || typeof str !== 'string') return str;
            try {
                // 验证是否为有效JSON
                JSON.parse(str);
            } catch (_) {
                return escapeHtml(str);
            }
            return str
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/("[^"]*")\s*:/g, '<span class="log-json-key">$1</span>:')
                .replace(/:([\s]*)("[^"]*")/g, ':$1<span class="log-json-string">$2</span>')
                .replace(/:([\s]*)(-?\d+\.?\d*)/g, ':$1<span class="log-json-number">$2</span>')
                .replace(/:([\s]*)(true|false)/g, ':$1<span class="log-json-boolean">$2</span>')
                .replace(/:([\s]*)(null)/g, ':$1<span class="log-json-null">$2</span>')
                .replace(/([{}\[\],])/g, '<span class="log-json-punct">$1</span>');
        }

        function escapeHtml(str) {
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;');
        }

        /* =========================
           可视化结果格式化函数
           ========================= */
        
        // 端口风险等级判断
        const PORT_RISK_MAP = {
            // 安全端口（常见服务）
            safe: [80, 443, 22, 21, 25, 53, 110, 143, 993, 995],
            // 警告端口（需检查）
            warning: [8080, 8443, 3000, 5000, 8000, 8888, 9000, 9090, 4443],
            // 危险端口（高风险）
            danger: [23, 445, 3389, 1433, 3306, 5432, 6379, 27017, 11211, 9200, 2375]
        };
        
        // 服务名称映射
        const SERVICE_NAMES = {
            'http': '网页服务',
            'https': '加密网页服务',
            'ssh': '远程登录服务',
            'ftp': '文件传输服务',
            'smtp': '邮件发送服务',
            'dns': '域名解析服务',
            'mysql': '数据库服务',
            'redis': '缓存服务',
            'mongodb': '文档数据库',
            'telnet': '远程终端服务',
            'rdp': '远程桌面服务',
            'smb': '文件共享服务',
            'pop3': '邮件接收服务',
            'imap': '邮件访问服务',
            'postgresql': '数据库服务'
        };
        
        // 术语解释
        const TERM_TOOLTIPS = {
            'HTTP': '超文本传输协议，用于网页浏览，未加密',
            'HTTPS': '加密的HTTP协议，数据传输更安全',
            'SSH': '安全外壳协议，用于加密远程登录',
            'FTP': '文件传输协议，明文传输数据',
            'MySQL': '开源关系型数据库，暴露可能导致数据泄露',
            'Redis': '内存数据库，未授权访问可能导致数据泄露',
            'Telnet': '明文远程登录，不安全，建议禁用',
            'RDP': '远程桌面协议，暴露互联网有风险',
            'SMB': '文件共享协议，可能存在永恒之蓝等漏洞',
            'CVE': '通用漏洞披露，已知安全漏洞的编号',
            'PoC': '漏洞验证代码，用于证明漏洞存在',
            'Payload': '攻击载荷，用于利用漏洞的代码'
        };
        
        // 获取端口风险等级
        function getPortRiskLevel(port) {
            const p = parseInt(port);
            if (PORT_RISK_MAP.danger.includes(p)) return 'danger';
            if (PORT_RISK_MAP.warning.includes(p)) return 'warning';
            if (PORT_RISK_MAP.safe.includes(p)) return 'safe';
            // 高端口默认警告
            if (p > 1024) return 'warning';
            return 'info';
        }
        
        // 获取服务中文名
        function getServiceName(service, port) {
            if (SERVICE_NAMES[service?.toLowerCase()]) {
                return SERVICE_NAMES[service.toLowerCase()];
            }
            // 根据端口推断
            const portServiceMap = {
                80: '网页服务 (HTTP)',
                443: '加密网页服务 (HTTPS)',
                22: '远程登录服务 (SSH)',
                21: '文件传输服务 (FTP)',
                3306: '数据库服务 (MySQL)',
                6379: '缓存服务 (Redis)',
                8080: '备用网页服务',
                8443: '备用加密服务',
                3389: '远程桌面 (RDP)',
                23: '远程终端 (Telnet)',
                445: '文件共享 (SMB)'
            };
            return portServiceMap[port] || service || '未知服务';
        }
        
        // 计算整体风险等级
        function calculateRiskLevel(data) {
            const ports = data.open_ports || [];
            let dangerCount = 0, warningCount = 0;
            
            ports.forEach(p => {
                const risk = getPortRiskLevel(p);
                if (risk === 'danger') dangerCount++;
                else if (risk === 'warning') warningCount++;
            });
            
            if (dangerCount > 0) return { level: 'high', text: '高风险', icon: '🔴' };
            if (warningCount > 2 || ports.length > 6) return { level: 'medium', text: '中等风险', icon: '⚠️' };
            if (warningCount > 0) return { level: 'medium', text: '中等风险', icon: '⚠️' };
            return { level: 'low', text: '低风险', icon: '✅' };
        }
        
        // 生成安全建议
        function generateSuggestions(data) {
            const suggestions = [];
            const ports = data.open_ports || [];
            
            // 检查危险端口
            const dangerPorts = ports.filter(p => PORT_RISK_MAP.danger.includes(p));
            if (dangerPorts.length > 0) {
                suggestions.push(`立即关闭或限制访问高危端口：${dangerPorts.join('/')}，这些端口常被攻击者利用`);
            }
            
            // 检查警告端口
            const warningPorts = ports.filter(p => PORT_RISK_MAP.warning.includes(p));
            if (warningPorts.length > 0) {
                suggestions.push(`检查备用端口（${warningPorts.join('/')}）是否必要，如非必需建议关闭`);
            }
            
            // HTTP -> HTTPS
            if (ports.includes(80) && !ports.includes(443)) {
                suggestions.push('为 HTTP 服务添加 HTTPS 重定向，提升数据传输安全性');
            }
            
            // 默认建议
            if (suggestions.length === 0) {
                suggestions.push('当前配置相对安全，建议定期进行安全审计');
            }
            
            suggestions.push('点击查看详细技术报告，了解更多安全信息');
            
            return suggestions;
        }
        
        // 生成饼图 SVG
        function generatePieChartSVG(data) {
            const ports = data.open_ports || [];
            let safe = 0, warning = 0, danger = 0;
            
            ports.forEach(p => {
                const risk = getPortRiskLevel(p);
                if (risk === 'danger') danger++;
                else if (risk === 'warning') warning++;
                else safe++;
            });
            
            const total = safe + warning + danger;
            if (total === 0) return '';
            
            // 计算百分比
            const safeP = (safe / total) * 100;
            const warningP = (warning / total) * 100;
            const dangerP = (danger / total) * 100;
            
            // 生成圆锥渐变
            let gradient = '';
            let offset = 0;
            if (safe > 0) {
                gradient += `#10b981 ${offset}% ${offset + safeP}%`;
                offset += safeP;
            }
            if (warning > 0) {
                if (gradient) gradient += ', ';
                gradient += `#f59e0b ${offset}% ${offset + warningP}%`;
                offset += warningP;
            }
            if (danger > 0) {
                if (gradient) gradient += ', ';
                gradient += `#ef4444 ${offset}% ${offset + dangerP}%`;
            }
            
            return `
                <div class="chart-container">
                    <div class="pie-chart" style="background: conic-gradient(${gradient});"></div>
                    <div class="chart-legend">
                        ${safe > 0 ? `<div class="legend-item"><div class="legend-dot" style="background:#10b981;"></div>安全: ${safe} 个</div>` : ''}
                        ${warning > 0 ? `<div class="legend-item"><div class="legend-dot" style="background:#f59e0b;"></div>需检查: ${warning} 个</div>` : ''}
                        ${danger > 0 ? `<div class="legend-item"><div class="legend-dot" style="background:#ef4444;"></div>高风险: ${danger} 个</div>` : ''}
                    </div>
                </div>
            `;
        }
        
        // 主格式化函数 - 将技术数据转换为可视化卡片
        function formatScanResultViz(toolName, result, rawData) {
            // 检测结果类型
            const data = typeof result === 'object' ? result : {};
            
            // 如果有 open_ports 或 ports，走端口扫描模板
            if (data.open_ports || data.ports || (Array.isArray(data.services) && data.services.length > 0)) {
                return formatPortScanResult(toolName, data, rawData);
            }
            
            // 如果有 vulnerabilities 或 vulns，走漏洞扫描模板
            if (data.vulnerabilities || data.vulns || data.findings) {
                return formatVulnScanResult(toolName, data, rawData);
            }
            
            // 如果有 subdomains，走子域名模板
            if (data.subdomains || data.domains) {
                return formatSubdomainResult(toolName, data, rawData);
            }
            
            // 通用结果展示
            return formatGenericResult(toolName, data, rawData);
        }
        
        // 端口扫描结果格式化
        function formatPortScanResult(toolName, data, rawData) {
            const target = data.target || data.host || '未知目标';
            const ports = data.open_ports || data.ports || [];
            const services = data.services || [];
            const risk = calculateRiskLevel(data);
            const suggestions = generateSuggestions(data);
            
            // 构建端口列表
            let portListHtml = '<div class="port-list">';
            
            // 合并 ports 和 services 信息
            const portInfoMap = {};
            services.forEach(s => {
                portInfoMap[s.port] = s;
            });
            
            ports.forEach(port => {
                const info = portInfoMap[port] || {};
                const riskLevel = getPortRiskLevel(port);
                const serviceName = getServiceName(info.service, port);
                const protocol = info.protocol || 'tcp';
                
                const riskIcon = riskLevel === 'danger' ? '🔴' : 
                                 riskLevel === 'warning' ? '🟡' : 
                                 riskLevel === 'safe' ? '🟢' : '🔵';
                
                portListHtml += `
                    <div class="port-item">
                        <div class="port-dot ${riskLevel}"></div>
                        <div class="port-info">
                            <div class="port-number">${riskIcon} ${port}端口 - ${serviceName}</div>
                            <div class="port-service">协议: ${protocol.toUpperCase()} ${info.version ? '· 版本: ' + info.version : ''}</div>
                        </div>
                        <span class="port-tag">${riskLevel === 'danger' ? '高危' : riskLevel === 'warning' ? '需检查' : '正常'}</span>
                    </div>
                `;
            });
            portListHtml += '</div>';
            
            // 构建建议列表
            let suggestionsHtml = '<div class="suggestion-section"><div class="suggestion-title">💡 建议操作</div><div class="suggestion-list">';
            suggestions.forEach((s, i) => {
                suggestionsHtml += `
                    <div class="suggestion-item">
                        <span class="suggestion-num">${i + 1}</span>
                        <span>${s}</span>
                    </div>
                `;
            });
            suggestionsHtml += '</div></div>';
            
            // 操作按钮
            const actionBtns = `
                <div class="action-buttons">
                    <button class="action-btn-viz primary" onclick="exportScanReport('${escapeHtml(target)}')">
                        💾 导出报告
                    </button>
                    <button class="action-btn-viz secondary" onclick="toggleTechDetails(this)">
                        🔍 查看技术详情
                    </button>
                    <button class="action-btn-viz secondary explain-trigger" onclick="showExplanation('port-scan')">
                        ❓ 这是什么意思？
                    </button>
                </div>
            `;
            
            // 技术详情折叠
            const techDetails = `
                <div class="tech-details">
                    <button class="tech-toggle" onclick="toggleTechContent(this)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                        原始技术数据
                    </button>
                    <pre class="tech-content">${escapeHtml(JSON.stringify(rawData || data, null, 2))}</pre>
                </div>
            `;
            
            return `
                <div class="scan-result-card">
                    <div class="scan-target-header">
                        <div class="scan-target-icon" style="background:linear-gradient(135deg,rgba(59,130,246,0.15),rgba(6,182,212,0.15));">🎯</div>
                        <div class="scan-target-info">
                            <div class="scan-target-name">【目标网站】${escapeHtml(target)}</div>
                            <div class="scan-target-type">端口扫描 by ${toolName}</div>
                        </div>
                        <div class="security-badge risk-${risk.level}">
                            ${risk.icon} ${risk.text}
                        </div>
                    </div>
                    
                    <div class="scan-summary">
                        ${risk.icon} <strong>安全状态：${risk.text}</strong>（检测到 <strong>${ports.length}</strong> 个开放端口${risk.level !== 'low' ? '，其中部分可能存在风险' : ''}）
                    </div>
                    
                    ${generatePieChartSVG(data)}
                    
                    <div style="font-size:12px;font-weight:700;color:#475569;margin:14px 0 8px;">🔌 开放端口情况</div>
                    ${portListHtml}
                    
                    ${suggestionsHtml}
                    ${actionBtns}
                    ${techDetails}
                </div>
            `;
        }
        
        // 漏洞扫描结果格式化
        function formatVulnScanResult(toolName, data, rawData) {
            const target = data.target || data.host || '未知目标';
            const vulns = data.vulnerabilities || data.vulns || data.findings || [];
            
            const critical = vulns.filter(v => v.severity === 'critical' || v.severity === 'CRITICAL').length;
            const high = vulns.filter(v => v.severity === 'high' || v.severity === 'HIGH').length;
            const medium = vulns.filter(v => v.severity === 'medium' || v.severity === 'MEDIUM').length;
            const low = vulns.filter(v => v.severity === 'low' || v.severity === 'LOW' || v.severity === 'info').length;
            
            const riskLevel = critical > 0 ? 'high' : high > 0 ? 'high' : medium > 0 ? 'medium' : 'low';
            const riskText = critical > 0 ? '严重风险' : high > 0 ? '高风险' : medium > 0 ? '中等风险' : '低风险';
            const riskIcon = critical > 0 ? '🔴' : high > 0 ? '🟠' : medium > 0 ? '⚠️' : '✅';
            
            let vulnListHtml = '<div class="port-list">';
            vulns.slice(0, 10).forEach(v => {
                const sevClass = (v.severity === 'critical' || v.severity === 'high' || v.severity === 'CRITICAL' || v.severity === 'HIGH') ? 'danger' : 
                                 (v.severity === 'medium' || v.severity === 'MEDIUM') ? 'warning' : 'safe';
                vulnListHtml += `
                    <div class="port-item">
                        <div class="port-dot ${sevClass}"></div>
                        <div class="port-info">
                            <div class="port-number">${escapeHtml(v.name || v.id || '未命名漏洞')}</div>
                            <div class="port-service">${escapeHtml(v.description || v.matched_at || '')}</div>
                        </div>
                        <span class="port-tag">${v.severity || 'info'}</span>
                    </div>
                `;
            });
            if (vulns.length > 10) {
                vulnListHtml += `<div style="text-align:center;font-size:11px;color:var(--text-tertiary);padding:8px;">还有 ${vulns.length - 10} 个漏洞，点击查看完整报告</div>`;
            }
            vulnListHtml += '</div>';
            
            return `
                <div class="scan-result-card">
                    <div class="scan-target-header">
                        <div class="scan-target-icon" style="background:linear-gradient(135deg,rgba(239,68,68,0.15),rgba(245,158,11,0.15));">🛡️</div>
                        <div class="scan-target-info">
                            <div class="scan-target-name">【目标网站】${escapeHtml(target)}</div>
                            <div class="scan-target-type">漏洞扫描 by ${toolName}</div>
                        </div>
                        <div class="security-badge risk-${riskLevel}">
                            ${riskIcon} ${riskText}
                        </div>
                    </div>
                    
                    <div class="scan-summary">
                        ${riskIcon} <strong>安全状态：${riskText}</strong>（发现 <strong>${vulns.length}</strong> 个安全问题：
                        ${critical > 0 ? `<span style="color:#dc2626;">严重 ${critical}</span> ` : ''}
                        ${high > 0 ? `<span style="color:#ea580c;">高危 ${high}</span> ` : ''}
                        ${medium > 0 ? `<span style="color:#d97706;">中危 ${medium}</span> ` : ''}
                        ${low > 0 ? `<span style="color:#65a30d;">低危 ${low}</span>` : ''}
                        ）
                    </div>
                    
                    <div style="font-size:12px;font-weight:700;color:#475569;margin:14px 0 8px;">🔍 发现的安全问题</div>
                    ${vulnListHtml}
                    
                    <div class="action-buttons">
                        <button class="action-btn-viz danger">⚡ 立即修复</button>
                        <button class="action-btn-viz secondary" onclick="toggleTechDetails(this)">📝 查看详情</button>
                        <button class="action-btn-viz secondary">📤 导出报告</button>
                    </div>
                    
                    <div class="tech-details">
                        <button class="tech-toggle" onclick="toggleTechContent(this)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                            原始技术数据
                        </button>
                        <pre class="tech-content">${escapeHtml(JSON.stringify(rawData || data, null, 2))}</pre>
                    </div>
                </div>
            `;
        }
        
        // 子域名结果格式化
        function formatSubdomainResult(toolName, data, rawData) {
            const target = data.target || data.domain || '未知目标';
            const subdomains = data.subdomains || data.domains || [];
            
            let listHtml = '<div class="port-list">';
            subdomains.slice(0, 15).forEach(sub => {
                const domain = typeof sub === 'string' ? sub : sub.domain || sub.host;
                listHtml += `
                    <div class="port-item">
                        <div class="port-dot info"></div>
                        <div class="port-info">
                            <div class="port-number">${escapeHtml(domain)}</div>
                        </div>
                    </div>
                `;
            });
            if (subdomains.length > 15) {
                listHtml += `<div style="text-align:center;font-size:11px;color:var(--text-tertiary);padding:8px;">还有 ${subdomains.length - 15} 个子域名...</div>`;
            }
            listHtml += '</div>';
            
            return `
                <div class="scan-result-card">
                    <div class="scan-target-header">
                        <div class="scan-target-icon" style="background:linear-gradient(135deg,rgba(16,185,129,0.15),rgba(6,182,212,0.15));">🌐</div>
                        <div class="scan-target-info">
                            <div class="scan-target-name">【目标域名】${escapeHtml(target)}</div>
                            <div class="scan-target-type">子域名枚举 by ${toolName}</div>
                        </div>
                        <div class="security-badge risk-low">
                            ✅ 发现 ${subdomains.length} 个
                        </div>
                    </div>
                    
                    <div class="scan-summary">
                        🔍 <strong>扫描完成</strong>：共发现 <strong>${subdomains.length}</strong> 个子域名，建议进一步探测存活状态
                    </div>
                    
                    <div style="font-size:12px;font-weight:700;color:#475569;margin:14px 0 8px;">📍 发现的子域名</div>
                    ${listHtml}
                    
                    <div class="action-buttons">
                        <button class="action-btn-viz primary">🚀 探测存活</button>
                        <button class="action-btn-viz secondary">💾 导出列表</button>
                    </div>
                    
                    <div class="tech-details">
                        <button class="tech-toggle" onclick="toggleTechContent(this)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                            原始技术数据
                        </button>
                        <pre class="tech-content">${escapeHtml(JSON.stringify(rawData || data, null, 2))}</pre>
                    </div>
                </div>
            `;
        }
        
        // 通用结果格式化
        function formatGenericResult(toolName, data, rawData) {
            const target = data.target || data.host || data.url || '未知目标';
            const status = data.success !== false ? 'success' : 'error';
            
            return `
                <div class="scan-result-card">
                    <div class="scan-target-header">
                        <div class="scan-target-icon" style="background:linear-gradient(135deg,rgba(99,102,241,0.15),rgba(139,92,246,0.15));">📊</div>
                        <div class="scan-target-info">
                            <div class="scan-target-name">【目标】${escapeHtml(target)}</div>
                            <div class="scan-target-type">执行 by ${toolName}</div>
                        </div>
                        <div class="security-badge risk-low">
                            ${status === 'success' ? '✅ 完成' : '❌ 失败'}
                        </div>
                    </div>
                    
                    <div class="scan-summary">
                        ${status === 'success' ? '✅' : '❌'} <strong>执行${status === 'success' ? '成功' : '失败'}</strong>
                    </div>
                    
                    <div class="tech-details" style="margin-top:10px;">
                        <button class="tech-toggle expanded" onclick="toggleTechContent(this)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                            执行结果
                        </button>
                        <pre class="tech-content show">${escapeHtml(JSON.stringify(rawData || data, null, 2))}</pre>
                    </div>
                </div>
            `;
        }
        
        // 切换技术详情展示
        function toggleTechContent(btn) {
            btn.classList.toggle('expanded');
            const content = btn.nextElementSibling;
            if (content) content.classList.toggle('show');
        }
        
        // 导出扫描报告
        function exportScanReport(target) {
            const logs = MCPUIState.logs || [];
            const reportData = {
                target: target,
                timestamp: new Date().toISOString(),
                logs: logs.slice(-20)
            };
            const blob = new Blob([JSON.stringify(reportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `scan-report-${target.replace(/[^a-zA-Z0-9]/g, '_')}-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // 显示解释弹窗
        function showExplanation(type) {
            const explanations = {
                'port-scan': {
                    title: '🔌 什么是端口扫描？',
                    content: `
                        <p><strong>端口</strong>就像房屋的门，每个门提供不同的服务。</p>
                        <ul style="margin:10px 0;padding-left:20px;">
                            <li><strong>80端口</strong>：网页服务（就像商店大门）</li>
                            <li><strong>443端口</strong>：加密网页（带锁的门）</li>
                            <li><strong>其他端口</strong>：可能是后门，需要检查</li>
                        </ul>
                        <p>ℹ️ 开放的端口越多，潜在风险越大。建议只开放必要的端口。</p>
                    `
                },
                'vuln-scan': {
                    title: '🛡️ 什么是漏洞扫描？',
                    content: `
                        <p><strong>漏洞</strong>就像房屋的缺陷，黑客可能利用它侵入。</p>
                        <ul style="margin:10px 0;padding-left:20px;">
                            <li><strong>严重漏洞</strong>：屋顶大窟窆，必须立即修复</li>
                            <li><strong>高危漏洞</strong>：门锁坏了，尽快修复</li>
                            <li><strong>中低漏洞</strong>：小问题，有空处理</li>
                        </ul>
                    `
                }
            };
            
            const exp = explanations[type];
            if (!exp) return;
            
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;';
            modal.innerHTML = `
                <div style="background:#fff;border-radius:16px;padding:24px;max-width:400px;margin:20px;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
                    <div style="font-size:18px;font-weight:700;margin-bottom:16px;">${exp.title}</div>
                    <div style="font-size:13px;line-height:1.7;color:#334155;">${exp.content}</div>
                    <button onclick="this.closest('div[style*=fixed]').remove()" style="margin-top:16px;padding:10px 24px;background:linear-gradient(135deg,#10b981,#06b6d4);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600;">我知道了</button>
                </div>
            `;
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            document.body.appendChild(modal);
        }

        // 高亮URL链接
        function highlightUrls(str) {
            if (!str) return str;
            const urlRegex = /(https?:\/\/[^\s"'<>]+)/g;
            return str.replace(urlRegex, '<span class="log-url" onclick="window.open(\'$1\', \'_blank\')" title="$1">$1</span>');
        }

        function highlightCode(str) {
            const raw = String(str || '');
            if (!raw) return '';

            const trimmed = raw.trim();
            if (trimmed.startsWith('{') || trimmed.startsWith('[')) {
                return highlightJson(raw);
            }

            let html = escapeHtml(raw);

            const looksHtml = /<\/?[a-z][\s\S]*>/i.test(trimmed);
            const looksJs = /\b(function|const|let|var|return|async|await|import|export)\b/.test(trimmed);
            const looksPy = /\b(def|class|import|from|return|elif|except|lambda)\b/.test(trimmed);
            const looksSh = /\b(sudo|apt|yum|curl|wget|chmod|chown|grep|awk|sed)\b/.test(trimmed) || /^\s*\$/.test(trimmed);

            if (looksHtml) {
                html = html
                    .replace(/(&lt;\/?)([a-zA-Z0-9:-]+)([^&]*?)(\/?&gt;)/g, '$1<span class="log-code-tag">$2</span>$3$4')
                    .replace(/([a-zA-Z0-9:-]+)=(&quot;[^&]*?&quot;)/g, '<span class="log-code-attr">$1</span>=<span class="log-code-value">$2</span>');
                return html;
            }

            if (looksJs || looksPy || looksSh) {
                html = html
                    .replace(/(&quot;.*?&quot;|'.*?')/g, '<span class="log-code-string">$1</span>')
                    .replace(/\b(\d+(\.\d+)?)\b/g, '<span class="log-code-number">$1</span>')
                    .replace(/(\bfunction\b|\bconst\b|\blet\b|\bvar\b|\breturn\b|\basync\b|\bawait\b|\bimport\b|\bexport\b|\bdef\b|\bclass\b|\bfrom\b|\belif\b|\bexcept\b|\blambda\b|\btry\b|\bcatch\b|\bfinally\b)/g, '<span class="log-code-keyword">$1</span>')
                    .replace(/(\b[A-Za-z_][A-Za-z0-9_]*)(?=\s*\()/g, '<span class="log-code-function">$1</span>')
                    .replace(/(#.*$|\/\/.*$)/gm, '<span class="log-code-comment">$1</span>');
                return html;
            }

            return html;
        }

        function buildFailureHints(entry) {
            const stack = String(entry?.stack || '');
            const response = entry?.response;
            const errText = stack || String(response?.error || '');

            if (!errText) return null;

            if (errText.includes('未生成XML输出文件')) {
                return {
                    error: '扫描失败：未生成XML输出文件',
                    causes: [
                        '目标不可达（DNS/网络/防火墙导致无法探测）',
                        '需要管理员权限运行 nmap（原始套接字/特权扫描）',
                        '后端未安装 nmap（命令未执行，XML为空）'
                    ],
                    solutions: [
                        '检查目标是否可解析/可达（ping/nslookup/HTTP探测）',
                        '以管理员身份启动后端服务或改用非特权扫描模式',
                        '在后端环境安装 nmap 并确保 PATH 可用'
                    ]
                };
            }

            if (errText.includes('工具未找到: nmap') || errText.includes('tool not found: nmap') || errText.includes('nmap') && errText.includes('not found')) {
                return {
                    error: '扫描失败：后端未安装 nmap',
                    causes: [
                        '后端运行环境缺少 nmap 可执行文件',
                        'nmap 未加入 PATH 或服务进程环境变量未生效'
                    ],
                    solutions: [
                        '在后端机器安装 nmap，并确认命令行可直接运行 nmap',
                        '重启后端服务，使 PATH 生效'
                    ]
                };
            }

            const missing = errText.match(/缺少必需参数:\s*([a-zA-Z0-9_,-]+)/);
            if (missing) {
                return {
                    error: `参数错误：缺少必需参数: ${missing[1]}`,
                    causes: [
                        '请求体 params 中缺少必填字段',
                        '消息中未识别到目标，且未手动传入参数'
                    ],
                    solutions: [
                        '补充 target/URL 等必需字段后重试',
                        '或在消息末尾附加 tool_params JSON 指定参数'
                    ]
                };
            }

            if (/HTTP\s+4\d\d|400|404/.test(errText)) {
                return {
                    error: '请求失败：客户端参数错误或接口不存在',
                    causes: [
                        '接口路径错误或服务未启动',
                        '参数格式错误导致后端拒绝'
                    ],
                    solutions: [
                        '检查 MCP 服务地址/端口与接口路径',
                        '查看 RESPONSE 中的 error 字段并修正参数'
                    ]
                };
            }

            return null;
        }

        function normalizeLevel(level) {
            const lv = String(level || 'INFO').toUpperCase();
            if (lv === 'WARN') return 'WARNING';
            if (lv === 'ERR') return 'ERROR';
            if (lv === 'INFO' || lv === 'ERROR' || lv === 'WARNING') return lv;
            return 'INFO';
        }

        function levelClass(level) {
            const lv = normalizeLevel(level);
            if (lv === 'ERROR') return 'error';
            if (lv === 'WARNING') return 'warning';
            return 'info';
        }

        function buildLogRawLine(entry) {
            const ts = formatLogTimestampFull(entry.tsMs);
            const lv = `[${normalizeLevel(entry.level)}]`;
            const svc = entry.service ? `[${entry.service}]` : '';
            const st = entry.status ? `[${entry.status}]` : '';
            const path = `[${entry.path || 'mcp.client.unknown:0'}]`;
            let msg = entry.message || '';
            if (entry.params != null) {
                let p = '';
                try { p = JSON.stringify(entry.params); } catch (_) { p = String(entry.params); }
                msg += ` | params=${p}`;
            }
            if (entry.httpStatus != null) msg += ` | http=${entry.httpStatus}`;
            if (entry.response != null) {
                let r = '';
                try { r = JSON.stringify(entry.response); } catch (_) { r = String(entry.response); }
                msg += ` | resp=${r}`;
            }
            if (typeof entry.durationSec === 'number' && Number.isFinite(entry.durationSec)) {
                msg += ` (耗时: ${entry.durationSec.toFixed(3)}s)`;
            }
            return `${ts} ${lv} ${svc}${st} ${path} ${msg}`.trim();
        }

        function shouldAutoScroll() {
            if (!MCPLogState.autoScroll) return false;
            if (!MCPLogDom.body) return false;
            const el = MCPLogDom.body;
            const remain = el.scrollHeight - el.scrollTop - el.clientHeight;
            return remain < 48;
        }

        function scrollLogToBottom() {
            if (!MCPLogDom.body) return;
            MCPLogDom.body.scrollTop = MCPLogDom.body.scrollHeight;
        }

        function updateLogStats() {
            if (!MCPLogDom.stats) return;
            const total = MCPLogState.entries.length;
            const visible = MCPLogState.renderedOrder.length;
            MCPLogDom.stats.innerHTML = `条目: <code>${total}</code> · 可见: <code>${visible}</code> · 丢弃: <code>${MCPLogState.dropped}</code>`;
        }

        function matchesLogFilters(entry) {
            const f = MCPLogState.filters;
            if (f.service && entry.service !== f.service) return false;
            if (f.status && entry.status !== f.status) return false;
            if (typeof f.fromMs === 'number' && entry.tsMs < f.fromMs) return false;
            if (typeof f.toMs === 'number' && entry.tsMs > f.toMs) return false;
            if (f.keyword) {
                const k = f.keyword.toLowerCase();
                const raw = (entry.rawLine || '').toLowerCase();
                const stack = (entry.stack || '').toLowerCase();
                if (!raw.includes(k) && !stack.includes(k)) return false;
            }
            return true;
        }

        function removeRenderedEntry(id) {
            const node = MCPLogState.rendered.get(id);
            if (node && node.parentElement) node.parentElement.removeChild(node);
            MCPLogState.rendered.delete(id);
            const idx = MCPLogState.renderedOrder.indexOf(id);
            if (idx >= 0) MCPLogState.renderedOrder.splice(idx, 1);
        }

        function ensureServiceOption(service) {
            if (!service || MCPLogState.services.has(service)) return;
            MCPLogState.services.add(service);
            if (!MCPLogDom.filterService) return;
            const opt = document.createElement('option');
            opt.value = service;
            opt.textContent = service;
            MCPLogDom.filterService.appendChild(opt);
        }

        function createLogEntryNode(entry) {
            const wrap = document.createElement('div');
            wrap.className = 'mcp-log-entry';
            wrap.setAttribute('data-log-id', entry.id);

            const line = document.createElement('div');
            line.className = 'mcp-log-line';

            const code = document.createElement('code');
            
            // 时间戳部分
            const tsFull = formatLogTimestamp(entry.tsMs);
            const tsParts = tsFull.split('.');
            const tsSpan = document.createElement('span');
            tsSpan.className = 'log-ts';
            tsSpan.textContent = tsParts[0] || tsFull;
            const tsMsSpan = document.createElement('span');
            tsMsSpan.className = 'log-ts-ms';
            tsMsSpan.textContent = tsParts[1] ? `.${tsParts[1]}` : '';

            // 日志级别
            const lvSpan = document.createElement('span');
            lvSpan.className = `log-lv ${levelClass(entry.level)}`;
            lvSpan.textContent = `[${normalizeLevel(entry.level)}]`;

            const svcSpan = document.createElement('span');
            svcSpan.className = 'log-svc';
            svcSpan.textContent = entry.service ? String(entry.service) : '';

            const stSpan = document.createElement('span');
            stSpan.className = 'log-status';
            stSpan.textContent = entry.status ? String(entry.status) : '';

            // 路径链接
            const pathSpan = document.createElement('span');
            pathSpan.className = 'log-path';
            pathSpan.textContent = entry.path || 'mcp.client.unknown:0';
            pathSpan.title = '点击复制路径';
            pathSpan.style.cursor = 'pointer';
            pathSpan.onclick = (e) => { e?.stopPropagation?.(); copyToClipboard(entry.path || ''); };

            // 消息内容
            const msgSpan = document.createElement('span');
            msgSpan.className = 'log-msg';
            let msgText = entry.message || '';
            if (typeof entry.durationSec === 'number' && Number.isFinite(entry.durationSec)) {
                msgText += ` (耗时: ${entry.durationSec.toFixed(3)}s)`;
            }
            
            // 处理params，添加语法高亮
            let paramsHtml = '';
            if (entry.params != null) {
                let p = '';
                try { p = JSON.stringify(entry.params, null, 2); } catch (_) { p = String(entry.params); }
                paramsHtml = highlightJson(p);
            }

            // HTTP 状态码
            let httpSpan = null;
            if (entry.httpStatus != null) {
                httpSpan = document.createElement('span');
                const statusClass = getHttpStatusClass(entry.httpStatus);
                httpSpan.className = `log-http ${statusClass}`;
                httpSpan.textContent = entry.httpStatus;
                httpSpan.title = `HTTP 状态码: ${entry.httpStatus}`;
            }

            // 组装日志行
            code.appendChild(tsSpan);
            code.appendChild(tsMsSpan);
            code.appendChild(document.createTextNode(' '));
            code.appendChild(lvSpan);
            code.appendChild(document.createTextNode(' '));
            if (svcSpan.textContent) {
                code.appendChild(svcSpan);
                code.appendChild(document.createTextNode(' '));
            }
            if (stSpan.textContent) {
                code.appendChild(stSpan);
                code.appendChild(document.createTextNode(' '));
            }
            code.appendChild(pathSpan);
            code.appendChild(document.createTextNode(' '));
            
            // 消息文本（带URL高亮）
            const msgContainer = document.createElement('span');
            msgContainer.className = 'log-msg';
            msgContainer.innerHTML = highlightUrls(escapeHtml(msgText));
            code.appendChild(msgContainer);
            
            if (httpSpan) {
                code.appendChild(document.createTextNode(' '));
                code.appendChild(httpSpan);
            }

            line.appendChild(code);
            wrap.appendChild(line);
            wrap.setAttribute('role', 'button');
            wrap.setAttribute('aria-expanded', 'false');
            line.style.cursor = 'pointer';

            // 堆栈/参数详情区
            const stackWrap = document.createElement('div');
            stackWrap.className = 'mcp-log-stack';
            const pre = document.createElement('pre');
            
            // 如果有params，添加语法高亮
            if (paramsHtml) {
                const paramsLabel = document.createElement('div');
                paramsLabel.style.cssText = 'font-size: 10px; color: #607D8B; margin-bottom: 4px; font-weight: 700;';
                paramsLabel.textContent = 'PARAMS:';
                stackWrap.appendChild(paramsLabel);
                
                const paramsCode = document.createElement('pre');
                paramsCode.innerHTML = paramsHtml;
                paramsCode.style.marginBottom = '8px';
                stackWrap.appendChild(paramsCode);
            }

            const hints = buildFailureHints(entry);
            if (hints) {
                const errLabel = document.createElement('div');
                errLabel.style.cssText = 'font-size: 10px; color: #F44336; margin-bottom: 4px; font-weight: 800;';
                errLabel.textContent = 'ERROR:';
                stackWrap.appendChild(errLabel);
                const errPre = document.createElement('pre');
                errPre.textContent = hints.error;
                errPre.style.marginBottom = '8px';
                stackWrap.appendChild(errPre);

                const causeLabel = document.createElement('div');
                causeLabel.style.cssText = 'font-size: 10px; color: #607D8B; margin-bottom: 4px; font-weight: 700;';
                causeLabel.textContent = 'POSSIBLE_CAUSES:';
                stackWrap.appendChild(causeLabel);
                const causePre = document.createElement('pre');
                causePre.textContent = (hints.causes || []).map(x => `- ${x}`).join('\n');
                causePre.style.marginBottom = '8px';
                stackWrap.appendChild(causePre);

                const solLabel = document.createElement('div');
                solLabel.style.cssText = 'font-size: 10px; color: #607D8B; margin-bottom: 4px; font-weight: 700;';
                solLabel.textContent = 'SOLUTIONS:';
                stackWrap.appendChild(solLabel);
                const solPre = document.createElement('pre');
                solPre.textContent = (hints.solutions || []).map(x => `- ${x}`).join('\n');
                solPre.style.marginBottom = '8px';
                stackWrap.appendChild(solPre);
            }

            if (entry.response != null) {
                const responseLabel = document.createElement('div');
                responseLabel.style.cssText = 'font-size: 10px; color: #607D8B; margin-bottom: 4px; font-weight: 700;';
                responseLabel.textContent = 'RESPONSE:';
                stackWrap.appendChild(responseLabel);

                let r = '';
                try { r = JSON.stringify(entry.response, null, 2); } catch (_) { r = String(entry.response); }
                const responseCode = document.createElement('pre');
                responseCode.innerHTML = highlightCode(r);
                responseCode.style.marginBottom = '8px';
                stackWrap.appendChild(responseCode);
            }

            const cmdFromResp = entry?.response?.result?.command || entry?.response?.command;
            if (cmdFromResp) {
                const cmdLabel = document.createElement('div');
                cmdLabel.style.cssText = 'font-size: 10px; color: #607D8B; margin-bottom: 4px; font-weight: 700;';
                cmdLabel.textContent = 'COMMAND:';
                stackWrap.appendChild(cmdLabel);
                const cmdPre = document.createElement('pre');
                cmdPre.innerHTML = highlightCode(String(cmdFromResp));
                cmdPre.style.marginBottom = '8px';
                stackWrap.appendChild(cmdPre);
            }
            
            if (entry.stack) {
                const stackLabel = document.createElement('div');
                stackLabel.style.cssText = 'font-size: 10px; color: #607D8B; margin-bottom: 4px; font-weight: 700;';
                stackLabel.textContent = 'STACK:';
                stackWrap.appendChild(stackLabel);
                
                pre.innerHTML = highlightCode(entry.stack);
                stackWrap.appendChild(pre);
            }
            
            wrap.appendChild(stackWrap);

            const hasDetails = () => {
                return !!(entry.stack || entry.params != null || entry.response != null);
            };
            wrap.addEventListener('click', () => {
                if (!hasDetails()) return;
                const next = !wrap.classList.contains('expanded');
                wrap.classList.toggle('expanded', next);
                wrap.setAttribute('aria-expanded', next ? 'true' : 'false');
            });

            return wrap;
        }

        function scheduleLogFlush() {
            if (MCPLogState.flushScheduled) return;
            MCPLogState.flushScheduled = true;
            requestAnimationFrame(() => {
                MCPLogState.flushScheduled = false;
                flushPendingLogs();
            });
        }

        function flushPendingLogs() {
            if (!MCPLogDom.list) return;
            if (MCPLogState.pending.length === 0) return;
            if (!MCPLogState.autoScroll) return;

            const frag = document.createDocumentFragment();
            const toAppend = MCPLogState.pending.splice(0, MCPLogState.pending.length);
            const autoScrollNow = shouldAutoScroll();

            for (const entry of toAppend) {
                if (!matchesLogFilters(entry)) continue;
                const node = createLogEntryNode(entry);
                MCPLogState.rendered.set(entry.id, node);
                MCPLogState.renderedOrder.push(entry.id);
                frag.appendChild(node);
            }

            if (frag.childNodes.length > 0) {
                MCPLogDom.list.appendChild(frag);
                if (autoScrollNow) scrollLogToBottom();
            }

            updateLogStats();
        }

        function rerenderLogs() {
            if (!MCPLogDom.list) return;
            MCPLogDom.list.innerHTML = '';
            MCPLogState.rendered.clear();
            MCPLogState.renderedOrder = [];

            const frag = document.createDocumentFragment();
            for (const entry of MCPLogState.entries) {
                if (!matchesLogFilters(entry)) continue;
                const node = createLogEntryNode(entry);
                MCPLogState.rendered.set(entry.id, node);
                MCPLogState.renderedOrder.push(entry.id);
                frag.appendChild(node);
            }
            MCPLogDom.list.appendChild(frag);
            if (MCPLogState.autoScroll) scrollLogToBottom();
            updateLogStats();
        }

        async function copyToClipboard(text) {
            const t = String(text || '');
            if (!t) return false;
            try {
                await navigator.clipboard.writeText(t);
                return true;
            } catch (_) {
                try {
                    const ta = document.createElement('textarea');
                    ta.value = t;
                    ta.style.position = 'fixed';
                    ta.style.left = '-9999px';
                    document.body.appendChild(ta);
                    ta.focus();
                    ta.select();
                    const ok = document.execCommand('copy');
                    document.body.removeChild(ta);
                    return ok;
                } catch (_) {
                    return false;
                }
            }
        }

        function getEntryById(id) {
            return MCPLogState.entries.find(e => e.id === id) || null;
        }

        async function copyLogEntry(id) {
            const entry = getEntryById(id);
            if (!entry) return;
            const raw = entry.rawLine || buildLogRawLine(entry);
            const text = entry.stack ? `${raw}\n${entry.stack}` : raw;
            await copyToClipboard(text);
        }

        function getFilteredEntriesSnapshot() {
            return MCPLogState.entries.filter(e => matchesLogFilters(e));
        }

        async function copyFilteredLogs() {
            const list = getFilteredEntriesSnapshot();
            const text = list.map(e => (e.stack ? `${e.rawLine}\n${e.stack}` : e.rawLine)).join('\n');
            await copyToClipboard(text);
        }

        async function copyAllLogs() {
            const list = MCPLogState.entries;
            const text = list.map(e => (e.stack ? `${e.rawLine}\n${e.stack}` : e.rawLine)).join('\n');
            await copyToClipboard(text);
        }

        function downloadText(filename, text) {
            const blob = new Blob([String(text || '')], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            setTimeout(() => URL.revokeObjectURL(url), 500);
        }

        function exportFilteredLogs() {
            const list = getFilteredEntriesSnapshot();
            const text = list.map(e => (e.stack ? `${e.rawLine}\n${e.stack}` : e.rawLine)).join('\n');
            const ts = new Date();
            const name = `mcp_logs_${ts.getFullYear()}${pad2(ts.getMonth() + 1)}${pad2(ts.getDate())}_${pad2(ts.getHours())}${pad2(ts.getMinutes())}${pad2(ts.getSeconds())}.log`;
            downloadText(name, text);
        }

        function clearLogs() {
            MCPLogState.entries = [];
            MCPLogState.pending = [];
            MCPLogState.rendered.clear();
            MCPLogState.renderedOrder = [];
            MCPLogState.dropped = 0;
            MCPLogState.services.clear();
            if (MCPLogDom.list) MCPLogDom.list.innerHTML = '';
            if (MCPLogDom.filterService) MCPLogDom.filterService.innerHTML = '<option value="">全部</option>';
            updateLogStats();
        }

        function addLog(entry) {
            const tsMs = typeof entry.tsMs === 'number' ? entry.tsMs : Date.now();
            const level = normalizeLevel(entry.level);
            const status = entry.status ? String(entry.status).toUpperCase() : (level === 'ERROR' ? 'ERROR' : (level === 'WARNING' ? 'WARNING' : 'INFO'));
            const service = entry.service ? String(entry.service) : '';

            MCPLogState.nextId += 1;
            const id = `log_${MCPLogState.nextId}`;

            const normalized = {
                id,
                tsMs,
                level,
                status,
                service,
                path: entry.path ? String(entry.path) : 'mcp.client.unknown:0',
                message: entry.message ? String(entry.message) : '',
                durationSec: typeof entry.durationSec === 'number' ? entry.durationSec : undefined,
                stack: entry.stack ? String(entry.stack) : '',
                params: entry.params,
                httpStatus: entry.httpStatus,
                response: entry.response
            };
            normalized.rawLine = buildLogRawLine(normalized);

            MCPLogState.entries.push(normalized);
            ensureServiceOption(service);

            while (MCPLogState.entries.length > MCPLogState.maxEntries) {
                const removed = MCPLogState.entries.shift();
                MCPLogState.dropped += 1;
                if (removed) removeRenderedEntry(removed.id);
            }

            MCPLogState.pending.push(normalized);
            if (MCPLogState.autoScroll) {
                scheduleLogFlush();
            } else {
                updateLogStats();
            }
        }

        function setLogFiltersFromUI() {
            if (!MCPLogDom.filterService || !MCPLogDom.filterStatus || !MCPLogDom.filterFrom || !MCPLogDom.filterTo) return;
            MCPLogState.filters.service = MCPLogDom.filterService.value || '';
            MCPLogState.filters.status = MCPLogDom.filterStatus.value || '';
            MCPLogState.filters.keyword = (MCPLogDom.filterSearch?.value || '').trim();
            const fromVal = MCPLogDom.filterFrom.value;
            const toVal = MCPLogDom.filterTo.value;
            MCPLogState.filters.fromMs = fromVal ? new Date(fromVal).getTime() : null;
            MCPLogState.filters.toMs = toVal ? new Date(toVal).getTime() : null;
        }

        function initLogPanel() {
            MCPLogDom.list = document.getElementById('mcpLogList');
            MCPLogDom.body = document.getElementById('mcpLogBody');
            MCPLogDom.stats = document.getElementById('mcpLogStats');
            MCPLogDom.autoScroll = document.getElementById('logAutoScroll');
            MCPLogDom.clearBtn = document.getElementById('logClearBtn');
            MCPLogDom.copyFilteredBtn = document.getElementById('logCopyFilteredBtn');
            MCPLogDom.copyAllBtn = document.getElementById('logCopyAllBtn');
            MCPLogDom.exportFilteredBtn = document.getElementById('logExportFilteredBtn');
            MCPLogDom.filterService = document.getElementById('logFilterService');
            MCPLogDom.filterStatus = document.getElementById('logFilterStatus');
            MCPLogDom.filterSearch = document.getElementById('logFilterSearch');
            MCPLogDom.filterFrom = document.getElementById('logFilterFrom');
            MCPLogDom.filterTo = document.getElementById('logFilterTo');

            if (MCPLogDom.autoScroll) {
                MCPLogDom.autoScroll.addEventListener('change', () => {
                    MCPLogState.autoScroll = !!MCPLogDom.autoScroll.checked;
                    if (MCPLogState.autoScroll) {
                        MCPLogState.pending = [];
                        rerenderLogs();
                        scrollLogToBottom();
                    }
                });
                MCPLogState.autoScroll = !!MCPLogDom.autoScroll.checked;
            }
            if (MCPLogDom.clearBtn) MCPLogDom.clearBtn.addEventListener('click', () => clearLogs());
            if (MCPLogDom.copyFilteredBtn) MCPLogDom.copyFilteredBtn.addEventListener('click', () => copyFilteredLogs());
            if (MCPLogDom.copyAllBtn) MCPLogDom.copyAllBtn.addEventListener('click', () => copyAllLogs());
            if (MCPLogDom.exportFilteredBtn) MCPLogDom.exportFilteredBtn.addEventListener('click', () => exportFilteredLogs());

            const onFilterChange = () => {
                setLogFiltersFromUI();
                rerenderLogs();
            };
            if (MCPLogDom.filterService) MCPLogDom.filterService.addEventListener('change', onFilterChange);
            if (MCPLogDom.filterStatus) MCPLogDom.filterStatus.addEventListener('change', onFilterChange);
            if (MCPLogDom.filterSearch) MCPLogDom.filterSearch.addEventListener('input', () => {
                setLogFiltersFromUI();
                rerenderLogs();
            });
            if (MCPLogDom.filterFrom) MCPLogDom.filterFrom.addEventListener('change', onFilterChange);
            if (MCPLogDom.filterTo) MCPLogDom.filterTo.addEventListener('change', onFilterChange);

            updateLogStats();
        }

        window.MCPLogPanel = {
            add: (entry) => addLog(entry || {}),
            clear: () => clearLogs(),
            copyFiltered: () => copyFilteredLogs(),
            copyAll: () => copyAllLogs()
        };

        async function mcpRequestJson(path, options = {}) {
            const url = MCP_ENDPOINTS.baseUrl + path;
            const quiet = options.quiet === true;
            const method = (options.method || 'GET').toUpperCase();
            const params = options.body ? (() => { try { return JSON.parse(options.body); } catch (_) { return options.body; } })() : undefined;

            const startedAt = performance.now();
            if (!quiet) {
                addLog({
                    level: 'INFO',
                    status: 'RUNNING',
                    service: path,
                    path: `web.fetch.${method.toLowerCase()}:0`,
                    message: '请求开始',
                    params
                });
            }

            const timeoutMs = typeof options.timeoutMs === 'number' ? options.timeoutMs : 15000;
            const controller = new AbortController();
            const timer = setTimeout(() => controller.abort(), timeoutMs);

            let resp;
            try {
                const { timeoutMs: _timeoutMs, quiet: _quiet, ...fetchOptions } = options || {};
                resp = await fetch(url, { ...fetchOptions, signal: controller.signal });
                const durationSec = (performance.now() - startedAt) / 1000;
                const text = await resp.text();
                let data = null;
                try { data = JSON.parse(text); } catch (_) { data = { raw: text }; }

                let responseForLog = data;
                try {
                    const asText = JSON.stringify(data);
                    if (asText && asText.length > 12000) {
                        responseForLog = {
                            truncated: true,
                            length: asText.length,
                            preview: asText.slice(0, 12000)
                        };
                    }
                } catch (_) {}

                if (!quiet) {
                    addLog({
                        level: resp.ok ? 'INFO' : 'ERROR',
                        status: resp.ok ? 'SUCCESS' : 'ERROR',
                        service: path,
                        path: `web.fetch.${method.toLowerCase()}:0`,
                        message: '请求完成',
                        params,
                        httpStatus: resp.status,
                        durationSec,
                        response: responseForLog,
                        stack: resp.ok ? '' : (data?.error ? String(data.error) : text)
                    });
                }

                if (!resp.ok) {
                    const err = new Error(data?.error || `HTTP ${resp.status}`);
                    err.data = data;
                    throw err;
                }

                return data;
            } catch (e) {
                const durationSec = (performance.now() - startedAt) / 1000;
                if (!quiet && !resp) {
                    addLog({
                        level: 'ERROR',
                        status: 'ERROR',
                        service: path,
                        path: `web.fetch.${method.toLowerCase()}:0`,
                        message: `请求失败: ${e?.message || 'unknown error'}`,
                        params,
                        durationSec,
                        stack: e && e.stack ? String(e.stack) : ''
                    });
                }
                throw e;
            } finally {
                clearTimeout(timer);
            }
        }

        function normalizeToolCategory(cat) {
            const c = String(cat || '').trim();
            if (!c) return 'other';
            if (c.toLowerCase() === 'cloud') return 'other';
            return c;
        }

        function displayToolCategory(cat) {
            const c = String(cat || '').trim();
            if (!c) return '';
            if (c.toLowerCase() === 'cloud') return '';
            return c;
        }

        function renderAllToolsGrid(query = '') {
            const grid = document.getElementById('allToolsGrid');
            const meta = document.getElementById('allToolsMeta');
            const section = document.getElementById('mcpGroupAllTools');
            if (!grid || !meta) return;

            const q = String(query || '').trim().toLowerCase();
            const list = MCPToolState.tools.filter(t => {
                if (!q) return true;
                const hay = `${t.name} ${t.description || ''} ${t.category || ''}`.toLowerCase();
                return hay.includes(q);
            });

            meta.textContent = `已加载 ${MCPToolState.tools.length} · 展示 ${list.length}`;
            grid.innerHTML = '';

            // 控制全部工具区域的显示/隐藏
            if (section) {
                if (list.length > 0) {
                    section.classList.add('has-tools');
                } else {
                    section.classList.remove('has-tools');
                }
            }

            const frag = document.createDocumentFragment();
            list.slice(0, 40).forEach(t => {
                const btn = document.createElement('button');
                btn.className = 'action-btn';
                btn.type = 'button';
                btn.setAttribute('data-mcp-tool', t.name);
                btn.setAttribute('data-mcp-category', normalizeToolCategory(t.category));
                btn.setAttribute('data-mcp-label', t.name);
                btn.innerHTML = `
                    <span class="action-icon"><svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg></span>
                    <span class="action-text"><span class="action-title">${t.name}</span><span class="action-desc">${displayToolCategory(t.category)}</span></span>
                `;
                frag.appendChild(btn);
            });
            grid.appendChild(frag);

            document.querySelectorAll('#allToolsGrid .action-btn[data-mcp-tool]').forEach(btn => {
                const toolName = btn.getAttribute('data-mcp-tool');
                if (!toolName) return;
                const selected = MCPUIState.selectedTools.has(toolName);
                btn.classList.toggle('selected', selected);
                btn.setAttribute('aria-pressed', selected ? 'true' : 'false');
                btn.addEventListener('click', () => toggleToolSelection(toolName));
            });
        }

        async function loadTools() {
            const totalChip = document.getElementById('mcpToolsTotalChip');
            const refreshBtn = document.getElementById('refreshToolsBtn');
            if (refreshBtn) refreshBtn.disabled = true;

            try {
                const data = await mcpRequestJson(MCP_ENDPOINTS.tools, { method: 'GET' });
                const tools = Array.isArray(data?.tools) ? data.tools : [];
                MCPToolState.tools = tools;
                MCPToolState.toolsByName = new Map(tools.map(t => [t.name, t]));
                MCPToolState.loaded = true;

                if (totalChip) totalChip.textContent = `TOOLS ${tools.length}`;
                renderAllToolsGrid(document.getElementById('mcpToolSearch')?.value || '');
            } catch (_) {
                if (totalChip) totalChip.textContent = 'TOOLS ERR';
            } finally {
                if (refreshBtn) refreshBtn.disabled = false;
            }
        }

        function startEventStream() {
            const url = MCP_ENDPOINTS.baseUrl + MCP_ENDPOINTS.events;
            let es;
            try {
                es = new EventSource(url);
            } catch (err) {
                console.error('EventSource 创建失败:', err);
                addLog({
                    level: 'ERROR',
                    status: 'ERROR',
                    service: 'mcp.events',
                    path: 'sse.connect:0',
                    message: 'SSE 连接创建失败: ' + (err?.message || 'unknown')
                });
                return;
            }

            es.onopen = () => {
                console.log('EventSource 已连接:', url);
                addLog({
                    level: 'INFO',
                    status: 'SUCCESS',
                    service: 'mcp.events',
                    path: 'sse.connect:0',
                    message: 'SSE 实时日志连接已建立'
                });
            };

            es.onerror = (err) => {
                console.error('EventSource 错误:', err);
                addLog({
                    level: 'WARNING',
                    status: 'WARNING',
                    service: 'mcp.events',
                    path: 'sse.error:0',
                    message: 'SSE 连接中断或错误，尝试重连...'
                });
            };

            es.onmessage = (evt) => {
                console.log('EventSource 收到消息:', evt.data);
                try {
                    const e = JSON.parse(evt.data);
                    addLog({
                        level: e.level || 'INFO',
                        status: e.status || 'INFO',
                        service: e.service || '',
                        path: e.tool ? `${e.tool}:0` : (e.service ? `${e.service}:0` : 'mcp.event:0'),
                        message: e.error ? String(e.error) : (e.message || (e.tool ? `tool=${e.tool}` : 'event')),
                        params: e.params,
                        durationSec: typeof e.duration === 'number' ? e.duration : undefined,
                        stack: e.error ? String(e.error) : (e.stack ? String(e.stack) : '')
                    });
                } catch (parseErr) {
                    console.warn('EventSource 解析失败:', parseErr, evt.data);
                }
            };
        }

        function nowTimeText() {
            try {
                return new Intl.DateTimeFormat('zh-CN', { hour: '2-digit', minute: '2-digit' }).format(new Date());
            } catch (_) {
                const d = new Date();
                const hh = String(d.getHours()).padStart(2, '0');
                const mm = String(d.getMinutes()).padStart(2, '0');
                return `${hh}:${mm}`;
            }
        }

        function syncMessageTimes() {
            document.querySelectorAll('[data-time]').forEach(el => {
                if (!el.textContent) el.textContent = nowTimeText();
            });
        }

        function scrollChatToBottom() {
            const box = document.getElementById('chatMessages');
            if (!box) return;
            box.scrollTop = box.scrollHeight;
        }

        function addChatMessage(text, role = 'assistant') {
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) return null;

            MCPUIState.lastMessageId += 1;
            const msgId = `msg_${MCPUIState.lastMessageId}`;

            const msg = document.createElement('div');
            msg.className = `chat-message ${role}`;
            msg.setAttribute('data-role', role);
            msg.setAttribute('data-message-id', msgId);

            const bubble = document.createElement('div');
            bubble.className = 'chat-bubble';
            bubble.textContent = text;

            const meta = document.createElement('div');
            meta.className = 'chat-meta';
            meta.innerHTML = `${role} · <span data-time>${nowTimeText()}</span>`;

            msg.appendChild(bubble);
            msg.appendChild(meta);
            chatMessages.appendChild(msg);

            scrollChatToBottom();
            return msgId;
        }

        function addChatHtmlMessage(html, role = 'assistant') {
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) return null;

            MCPUIState.lastMessageId += 1;
            const msgId = `msg_${MCPUIState.lastMessageId}`;

            const msg = document.createElement('div');
            msg.className = `chat-message ${role}`;
            msg.setAttribute('data-role', role);
            msg.setAttribute('data-message-id', msgId);

            const bubble = document.createElement('div');
            bubble.className = 'chat-bubble';
            bubble.innerHTML = html;

            const meta = document.createElement('div');
            meta.className = 'chat-meta';
            meta.innerHTML = `${role} · <span data-time>${nowTimeText()}</span>`;

            msg.appendChild(bubble);
            msg.appendChild(meta);
            chatMessages.appendChild(msg);

            scrollChatToBottom();
            return msgId;
        }

        function addThinkingMessage() {
            const id = addChatMessage('正在处理，请稍候…', 'assistant');
            const msg = document.querySelector(`[data-message-id="${id}"] .chat-bubble`);
            if (msg) msg.setAttribute('data-thinking', '1');
            return id;
        }

        function replaceMessageText(messageId, newText) {
            const msg = document.querySelector(`[data-message-id="${messageId}"] .chat-bubble`);
            if (msg) msg.textContent = newText;
        }

        function replaceMessageHtml(messageId, html) {
            const msg = document.querySelector(`[data-message-id="${messageId}"] .chat-bubble`);
            if (msg) msg.innerHTML = html;
        }

        function registerAction(handler) {
            MCPActionState.nextId += 1;
            const id = `act_${MCPActionState.nextId}`;
            MCPActionState.handlers.set(id, handler);
            return id;
        }

        function buildActionButtons(buttons) {
            const html = buttons.map(b => {
                const id = registerAction(b.onClick);
                const cls = `chat-action-btn${b.variant ? ` ${b.variant}` : ''}`;
                return `<button type="button" class="${cls}" data-action-id="${id}">${escapeHtml(b.label)}</button>`;
            }).join('');
            return `<div class="chat-actions">${html}</div>`;
        }

        function autoResizeTextarea(textarea) {
            if (!textarea) return;
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 160) + 'px';
        }

        function setSelectedToolsCount() {
            const chip = document.getElementById('selectedToolsCountChip');
            if (!chip) return;
            chip.textContent = `TOOLS ${MCPUIState.selectedTools.size}`;
        }

        function renderSelectedTools() {
            const container = document.getElementById('selectedTools');
            if (!container) return;

            const tools = Array.from(MCPUIState.selectedTools);
            container.innerHTML = '';

            if (tools.length === 0) {
                const hint = document.createElement('span');
                hint.style.fontSize = '11px';
                hint.style.color = 'var(--text-tertiary)';
                hint.textContent = '未选择工具：可直接对话，或先选择下方 MCP 工具';
                container.appendChild(hint);
                setSelectedToolsCount();
                return;
            }

            tools.forEach(toolName => {
                const tag = document.createElement('span');
                tag.className = 'tool-tag';
                tag.setAttribute('data-tool', toolName);
                tag.innerHTML = `${toolName}<span class="remove" title="移除" aria-label="移除">×</span>`;

                tag.querySelector('.remove').addEventListener('click', () => {
                    toggleToolSelection(toolName, false);
                });

                container.appendChild(tag);
            });

            setSelectedToolsCount();
        }

        function toggleToolSelection(toolName, shouldSelect) {
            const exists = MCPUIState.selectedTools.has(toolName);
            const next = typeof shouldSelect === 'boolean' ? shouldSelect : !exists;

            if (next) MCPUIState.selectedTools.add(toolName);
            else MCPUIState.selectedTools.delete(toolName);

            // 更新分类工具按钮状态
            document.querySelectorAll(`.action-btn[data-mcp-tool="${CSS.escape(toolName)}"]`).forEach(btn => {
                btn.classList.toggle('selected', next);
                btn.setAttribute('aria-pressed', next ? 'true' : 'false');
            });
            
            // 同步更新快捷工具按钮状态
            document.querySelectorAll(`.quick-tool-btn[data-mcp-tool="${CSS.escape(toolName)}"]`).forEach(btn => {
                btn.classList.toggle('selected', next);
            });

            renderSelectedTools();
        }

        async function checkMcpServerStatus() {
            const dot = document.getElementById('mcpStatusDot');
            const text = document.getElementById('mcpStatusText');
            if (!('serverOnline' in MCPUIState)) MCPUIState.serverOnline = null;

            try {
                await mcpRequestJson(MCP_ENDPOINTS.health, { method: 'GET', mode: 'cors', quiet: true });
                if (dot) dot.classList.remove('offline');
                if (text) text.textContent = 'MCP 服务器：在线';
                if (MCPUIState.serverOnline !== true) {
                    MCPUIState.serverOnline = true;
                    addLog({
                        level: 'INFO',
                        status: 'SUCCESS',
                        service: 'mcp.health',
                        path: 'mcp.client.health_check:0',
                        message: 'MCP 服务器状态切换为在线'
                    });
                }
                return true;
            } catch (_) {
                if (dot) dot.classList.add('offline');
                if (text) text.textContent = 'MCP 服务器：离线';
                if (MCPUIState.serverOnline !== false) {
                    MCPUIState.serverOnline = false;
                    addLog({
                        level: 'WARNING',
                        status: 'WARNING',
                        service: 'mcp.health',
                        path: 'mcp.client.health_check:0',
                        message: 'MCP 服务器状态切换为离线'
                    });
                }
                return false;
            }
        }

        async function initUiStatusLogFile() {
            try {
                const data = await mcpRequestJson('/logs/init', { method: 'GET', quiet: true });
                const ok = Number(data?.ok ?? 0);
                const missing = Number(data?.missing ?? 0);
                const total = Number(data?.total_tools ?? 0);
                const level = missing > 0 ? 'WARNING' : 'INFO';
                const status = missing > 0 ? 'WARNING' : 'SUCCESS';
                addLog({
                    level,
                    status,
                    service: 'ui.logfile',
                    path: 'web.ui.logfile.init:0',
                    message: `${missing > 0 ? '❌' : '✅'} 工具链接状态检测完成：${ok}/${total} OK${missing > 0 ? `，缺失依赖 ${missing}` : ''}`,
                    params: { file: data?.file, created: data?.created }
                });
            } catch (e) {
                addLog({
                    level: 'WARNING',
                    status: 'WARNING',
                    service: 'ui.logfile',
                    path: 'web.ui.logfile.init:0',
                    message: `日志文件初始化失败：${e?.message || 'unknown error'}`
                });
            }
        }

        function normalizeDomainLike(value) {
            const v = String(value || '').trim().replace(/[，。；；、]/g, '');
            return v;
        }

        function isValidDomain(value) {
            const v = normalizeDomainLike(value);
            const domainPattern = /^[a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?(\.[a-zA-Z]{2,})+$/;
            return domainPattern.test(v);
        }

        function isValidIp(value) {
            const v = String(value || '').trim();
            const ipPattern = /^(\d{1,3}\.){3}\d{1,3}$/;
            if (!ipPattern.test(v)) return false;
            return v.split('.').every(x => {
                const n = Number(x);
                return Number.isInteger(n) && n >= 0 && n <= 255;
            });
        }

        function extractTargetFromText(text) {
            const s = String(text || '').trim();
            const urlMatch = s.match(/https?:\/\/[^\s"'<>]+/i);
            if (urlMatch) return urlMatch[0];
            const ipMatch = s.match(/\b(\d{1,3}\.){3}\d{1,3}\b/);
            if (ipMatch) return ipMatch[0];
            const domainMatch = s.match(/\b([a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?\.)+[a-zA-Z]{2,}\b/);
            if (domainMatch) return domainMatch[0];
            const tail = s.split(/\s+/).slice(-1)[0] || '';
            return normalizeDomainLike(tail);
        }

        function parsePortScanIntent(text) {
            const s = String(text || '').trim();
            const lowered = s.toLowerCase();

            const looksPort = /端口|开了哪些口|哪些口|port|ports/.test(s);
            const looksScan = /扫|扫描|scan|check|检测/.test(lowered);

            const explicitQuick = /快速/.test(s) || /-f\b/i.test(s) || /nmap\s+-f/i.test(lowered);
            const confirmedFull = /^深度端口扫描[:：]/.test(s) || /^全面端口扫描[:：]/.test(s) || /继续深度扫描/.test(s);
            const explicitFull = confirmedFull || /全端口|1-65535|65535|全面|深度/.test(s) || /-p\s*[-,0-9]+/.test(lowered);
            const customPortsMatch = s.match(/(?:自定义端口|指定端口|端口范围|ports?)[:：]?\s*([0-9,\-]{1,50})/i);

            const explicit = /端口扫描|端口扫描：|扫描端口|快速端口扫描|快速端口扫描：|快速扫描端口目标|快速扫描端口|检查.*开了哪些口/.test(s);
            if (!(explicit || (looksScan && looksPort))) return null;

            const target = extractTargetFromText(s);
            const mode = customPortsMatch ? 'custom' : (explicitFull ? 'full' : (explicitQuick ? 'quick' : 'quick'));
            const ports = customPortsMatch ? String(customPortsMatch[1] || '').trim() : undefined;
            return { intent: 'port_scan', target, mode, confirmed: !!confirmedFull, ports };
        }

        function parseVulnIntent(text) {
            const s = String(text || '').trim();
            if (!s) return null;
            const lowered = s.toLowerCase();
            const target = extractTargetFromText(s);

            const isSql = /sqlmap|sql\s*注入|注入/.test(lowered) || /SQL注入/.test(s);
            if (isSql) return { intent: 'sqlmap', target };

            const isWebVuln = /漏洞|vuln|nuclei|nikto|web\s*漏洞|扫描漏洞/.test(lowered) || /漏洞/.test(s);
            if (isWebVuln) return { intent: 'web_vuln', target };

            const isAmbiguousScan = /扫一下|扫一遍|扫描一下|检查一下/.test(s) && /网站|站点|域名|url|http/.test(lowered);
            if (isAmbiguousScan) return { intent: 'ambiguous_scan', target };

            return null;
        }

        function extractPortsFromAny(value) {
            const ports = new Set();
            const pushPort = (p) => {
                const n = Number(p);
                if (Number.isInteger(n) && n > 0 && n <= 65535) ports.add(n);
            };
            const walk = (v) => {
                if (!v) return;
                if (Array.isArray(v)) {
                    v.forEach(walk);
                    return;
                }
                if (typeof v === 'object') {
                    for (const [k, val] of Object.entries(v)) {
                        if (k.toLowerCase().includes('port')) {
                            if (Array.isArray(val)) val.forEach(pushPort);
                            else pushPort(val);
                        }
                        walk(val);
                    }
                    return;
                }
                if (typeof v === 'string') {
                    const re = /\b(\d{1,5})\/(tcp|udp)\b|\bport\s+(\d{1,5})\b/gi;
                    let m2;
                    while ((m2 = re.exec(v))) {
                        if (m2[1]) pushPort(m2[1]);
                        if (m2[3]) pushPort(m2[3]);
                    }
                }
            };
            walk(value);
            return Array.from(ports).sort((a, b) => a - b);
        }

        function recommendNextStepsByPorts(ports) {
            const p = new Set(ports || []);
            const steps = [];
            if (p.has(80) || p.has(443) || p.has(8080)) steps.push('建议：选择 nuclei_scan / nikto_scan 对 Web 服务做漏洞扫描');
            if (p.has(22)) steps.push('建议：选择 ssh_audit 进行 SSH 配置审计');
            if (p.has(445) || p.has(139)) steps.push('建议：选择 enum4linux 进行 SMB 枚举');
            if (p.has(3306) || p.has(5432)) steps.push('建议：对数据库端口做访问控制与弱口令检查（仅授权范围内）');
            if (steps.length === 0) steps.push('建议：基于开放端口选择对应模块继续侦察/漏洞扫描');
            return steps;
        }

        function normalizeServiceName(port, proto, name) {
            const p = Number(port);
            const svc = String(name || '').toLowerCase();
            if (p === 80) return 'HTTP 服务';
            if (p === 443) return 'HTTPS 服务';
            if (p === 22) return 'SSH 服务';
            if (p === 3389) return 'RDP 服务';
            if (p === 445) return 'SMB 服务';
            if (p === 3306) return 'MySQL 服务';
            if (p === 5432) return 'PostgreSQL 服务';
            if (svc) return `${svc.toUpperCase()} 服务`;
            return `${proto || 'tcp'}/${p} 服务`;
        }

        function extractOpenPortServices(result) {
            const items = [];
            const hosts = result?.hosts;
            if (!Array.isArray(hosts)) return items;
            for (const h of hosts) {
                const ports = h?.ports;
                if (!Array.isArray(ports)) continue;
                for (const p of ports) {
                    if (p?.state !== 'open') continue;
                    const port = p?.port;
                    const proto = p?.protocol || 'tcp';
                    const svcName = p?.service?.name || '';
                    items.push({
                        port,
                        protocol: proto,
                        service: svcName,
                        friendly: normalizeServiceName(port, proto, svcName)
                    });
                }
            }
            items.sort((a, b) => (a.port || 0) - (b.port || 0));
            return items;
        }

        function formatPortScanAssistantMessage(target, toolResult, durationSec) {
            const open = extractOpenPortServices(toolResult);
            const ports = open.map(x => x.port).filter(Boolean);
            const steps = recommendNextStepsByPorts(ports);
            const findings = (ports || []).map(p => ({
                type: 'open_port',
                port: p,
                risk: (p === 22 || p === 3389 || p === 445) ? 'medium' : 'info',
                detail: `发现开放端口 ${p}`
            }));
            const summary = {
                target,
                open_ports: ports,
                services: open.map(x => ({ port: x.port, protocol: x.protocol, service: x.service, friendly: x.friendly })),
                findings,
                duration_sec: typeof durationSec === 'number' ? Number(durationSec.toFixed(3)) : undefined,
                next_steps: steps
            };
            return JSON.stringify(summary, null, 2);
        }

        async function sendChat() {
            const input = document.getElementById('chatInput');
            const msg = (input?.value || '').trim();
            if (!msg) return;

            let tools = Array.from(MCPUIState.selectedTools);

            if (input) {
                input.value = '';
                autoResizeTextarea(input);
            }

            addChatMessage(msg, 'user');

            const thinkingId = addThinkingMessage();

            const portIntent = tools.length === 0 ? parsePortScanIntent(msg) : null;
            const vulnIntent = tools.length === 0 ? parseVulnIntent(msg) : null;

            if (vulnIntent && vulnIntent.intent === 'ambiguous_scan') {
                const target = vulnIntent.target;
                const safeTarget = escapeHtml(target || '');
                const html = `你想“扫一下 ${safeTarget}”具体指什么？\n` +
                    `\n` +
                    `${buildActionButtons([
                        { label: '快速端口扫描', variant: 'primary', onClick: () => { const input = document.getElementById('chatInput'); if (input) { input.value = `快速端口扫描：${target}`; autoResizeTextarea(input); input.focus(); } sendChat(); } },
                        { label: 'Web 漏洞扫描', variant: 'primary', onClick: () => { const input = document.getElementById('chatInput'); if (input) { input.value = `Web 漏洞扫描：${target}`; autoResizeTextarea(input); input.focus(); } sendChat(); } },
                        { label: '取消', variant: 'danger', onClick: () => replaceMessageText(thinkingId, '已取消') }
                    ])}`;
                replaceMessageHtml(thinkingId, html.replace(/\n/g, '<br/>'));
                return;
            }

            if (portIntent && portIntent.intent === 'port_scan') {
                const target = portIntent.target;
                const targetOk = !!target && (isValidDomain(target) || isValidIp(target) || target.startsWith('http://') || target.startsWith('https://'));
                if (!targetOk) {
                    addLog({
                        level: 'ERROR',
                        status: 'ERROR',
                        service: 'chat.parse',
                        path: 'web.chat.parse:0',
                        message: `端口扫描目标格式错误: ${target || '-'}`,
                        params: { input: msg }
                    });
                    replaceMessageText(thinkingId, `目标格式错误：${target || '(空)'}\n示例：快速端口扫描：example.com`);
                    return;
                }

                const mode = portIntent.mode || 'quick';
                if (mode === 'custom') {
                    const ports = String(portIntent.ports || '').trim();
                    if (!/^[0-9,\-]{1,50}$/.test(ports)) {
                        replaceMessageText(thinkingId, `自定义端口格式错误：${ports || '(空)'}\n示例：自定义端口扫描：${target} 端口:22,80,443 或 1-1000`);
                        return;
                    }

                    tools = ['nmap_scan'];
                    MCPUIState.selectedTools = new Set(tools);
                    renderSelectedTools();

                    const started = performance.now();
                    let lastHeartbeat = 0;
                    const estimateSec = 15;
                    const update = () => {
                        const sec = (performance.now() - started) / 1000;
                        const pct = Math.min(99, Math.max(1, Math.floor((sec / estimateSec) * 100)));
                        const hb = Math.floor(sec / 30);
                        if (hb > lastHeartbeat) lastHeartbeat = hb;
                        const hbLine = hb > 0 ? `\n心跳：已完成约 ${pct}% 的端口检查` : '';
                        replaceMessageText(thinkingId, `正在扫描 ${target} 的端口 ${ports}…\n进度：${pct}% · ${sec.toFixed(1)}s${hbLine}`);
                    };
                    update();
                    const timer = setInterval(update, 1000);

                    try {
                        const data = await mcpRequestJson(MCP_ENDPOINTS.execute, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ tool: 'nmap_scan', params: { target, ports, scan_type: 'sS', timing: 'T4' }, session_id: MCPUIState.sessionId }),
                            timeoutMs: 180000
                        });
                        clearInterval(timer);
                        const toolRes = data?.result;
                        if (data?.success && toolRes && toolRes.success !== false) {
                            addLog({
                                level: 'INFO',
                                status: 'SUCCESS',
                                service: 'task.exec',
                                path: 'web.task.summary:0',
                                message: `✅ 执行完成：1/1 成功 · 总耗时 ${(Number(data?.duration) || 0).toFixed(2)}s · 任务 nmap_scan`,
                                params: { tool: 'nmap_scan', target, ports }
                            });
                            replaceMessageText(thinkingId, formatPortScanAssistantMessage(target, toolRes, data.duration));
                        } else {
                            addLog({
                                level: 'ERROR',
                                status: 'ERROR',
                                service: 'task.exec',
                                path: 'web.task.summary:0',
                                message: `❌ 执行完成：0/1 成功 · 总耗时 ${(Number(data?.duration) || 0).toFixed(2)}s · 任务 nmap_scan`,
                                params: { tool: 'nmap_scan', target, ports },
                                response: toolRes || data
                            });
                            replaceMessageText(thinkingId, `扫描失败：${toolRes?.error || data?.error || 'unknown error'}\n可能原因：目标不可达 / 权限不足 / 后端缺少依赖。`);
                        }
                    } catch (e) {
                        clearInterval(timer);
                        const msg2 = String(e?.message || '');
                        const friendly = /aborted|timeout/i.test(msg2) ? '扫描超时（可能目标网络不通或扫描耗时过长）' : `扫描请求失败：${msg2 || 'unknown error'}`;
                        replaceMessageText(thinkingId, `${friendly}\n建议：检查网络连通性与 MCP 服务状态。`);
                    }
                    return;
                }
                if (mode === 'full') {
                    if (!portIntent.confirmed) {
                    const html = `检测到可能是“全面/深度端口扫描”，该操作更敏感且耗时更长。\n是否继续对 ${escapeHtml(target)} 进行深度扫描？\n` +
                        `${buildActionButtons([
                            { label: '继续深度扫描', variant: 'primary', onClick: () => { const input = document.getElementById('chatInput'); if (input) { input.value = `深度端口扫描：${target}`; autoResizeTextarea(input); input.focus(); } sendChat(); } },
                            { label: '改为快速扫描(-F)', variant: 'primary', onClick: () => { const input = document.getElementById('chatInput'); if (input) { input.value = `快速端口扫描：${target}`; autoResizeTextarea(input); input.focus(); } sendChat(); } },
                            { label: '取消', variant: 'danger', onClick: () => replaceMessageText(thinkingId, '已取消') }
                        ])}`;
                    replaceMessageHtml(thinkingId, html.replace(/\n/g, '<br/>'));
                    return;
                    }

                    tools = ['nmap_scan'];
                    MCPUIState.selectedTools = new Set(tools);
                    renderSelectedTools();

                    addLog({
                        level: 'WARNING',
                        status: 'RUNNING',
                        service: 'chat.parse',
                        path: 'web.chat.parse:0',
                        message: '执行深度端口扫描（用户确认）',
                        params: { target, tool: 'nmap_scan', ports: '1-65535' }
                    });

                    const started = performance.now();
                    let lastHeartbeat = 0;
                    const estimateSec = 60;
                    const update = () => {
                        const sec = (performance.now() - started) / 1000;
                        const pct = Math.min(99, Math.max(1, Math.floor((sec / estimateSec) * 100)));
                        const hb = Math.floor(sec / 30);
                        if (hb > lastHeartbeat) lastHeartbeat = hb;
                        const hbLine = hb > 0 ? `\n心跳：已完成约 ${pct}% 的端口检查` : '';
                        replaceMessageText(thinkingId, `正在深度扫描 ${target} 的端口范围 1-65535…\n进度：${pct}% · ${sec.toFixed(1)}s${hbLine}`);
                    };
                    update();
                    const timer = setInterval(update, 1000);

                    try {
                        const data = await mcpRequestJson(MCP_ENDPOINTS.execute, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ tool: 'nmap_scan', params: { target, ports: '1-65535', scan_type: 'sS', timing: 'T4' }, session_id: MCPUIState.sessionId }),
                            timeoutMs: 600000
                        });
                        clearInterval(timer);
                        const toolRes = data?.result;
                        if (data?.success && toolRes && toolRes.success !== false) {
                            addLog({
                                level: 'INFO',
                                status: 'SUCCESS',
                                service: 'task.exec',
                                path: 'web.task.summary:0',
                                message: `✅ 执行完成：1/1 成功 · 总耗时 ${(Number(data?.duration) || 0).toFixed(2)}s · 任务 nmap_scan`,
                                params: { tool: 'nmap_scan', target, ports: '1-65535' }
                            });
                            replaceMessageText(thinkingId, formatPortScanAssistantMessage(target, toolRes, data.duration));
                        } else {
                            addLog({
                                level: 'ERROR',
                                status: 'ERROR',
                                service: 'task.exec',
                                path: 'web.task.summary:0',
                                message: `❌ 执行完成：0/1 成功 · 总耗时 ${(Number(data?.duration) || 0).toFixed(2)}s · 任务 nmap_scan`,
                                params: { tool: 'nmap_scan', target, ports: '1-65535' },
                                response: toolRes || data
                            });
                            replaceMessageText(thinkingId, `扫描失败：${toolRes?.error || data?.error || 'unknown error'}\n可能原因：目标不可达 / 权限不足 / 后端缺少依赖。`);
                        }
                    } catch (e) {
                        clearInterval(timer);
                        const msg2 = String(e?.message || '');
                        const friendly = /aborted|timeout/i.test(msg2) ? '扫描超时（可能目标网络不通或扫描耗时过长）' : `扫描请求失败：${msg2 || 'unknown error'}`;
                        replaceMessageText(thinkingId, `${friendly}\n建议：检查网络连通性与 MCP 服务状态。`);
                    }
                    return;
                }

                tools = ['nmap_quick'];
                MCPUIState.selectedTools = new Set(tools);
                renderSelectedTools();

                addLog({
                    level: 'INFO',
                    status: 'SUCCESS',
                    service: 'chat.parse',
                    path: 'web.chat.parse:0',
                    message: '已识别端口扫描指令（自动使用 Nmap -F 快速模式）',
                    params: { target, tool: 'nmap_quick' }
                });

                const started = performance.now();
                let lastHeartbeat = 0;
                const estimateSec = 10;
                const update = () => {
                    const sec = (performance.now() - started) / 1000;
                    const pct = Math.min(99, Math.max(1, Math.floor((sec / estimateSec) * 100)));
                    const hb = Math.floor(sec / 30);
                    if (hb > lastHeartbeat) lastHeartbeat = hb;
                    const hbLine = hb > 0 ? `\n心跳：已完成约 ${pct}% 的端口检查` : '';
                    replaceMessageText(thinkingId, `正在扫描 ${target} 的常用端口…\n进度：${pct}% · ${sec.toFixed(1)}s${hbLine}`);
                };
                update();
                const timer = setInterval(update, 1000);

                try {
                    const data = await mcpRequestJson(MCP_ENDPOINTS.execute, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ tool: 'nmap_quick', params: { target }, session_id: MCPUIState.sessionId }),
                        timeoutMs: 120000
                    });
                    clearInterval(timer);

                    if (data && typeof data.session_id === 'string') {
                        MCPUIState.sessionId = data.session_id;
                        const sessionChip = document.getElementById('chatSessionChip');
                        if (sessionChip) sessionChip.textContent = `SESSION ${data.session_id}`;
                    }

                    if (data?.success) {
                        const toolRes = data?.result;
                        if (!toolRes || toolRes.success === false) {
                            addLog({
                                level: 'ERROR',
                                status: 'ERROR',
                                service: 'task.exec',
                                path: 'web.task.summary:0',
                                message: `❌ 执行完成：0/1 成功 · 总耗时 ${(Number(data?.duration) || 0).toFixed(2)}s · 任务 nmap_quick`,
                                params: { tool: 'nmap_quick', target },
                                response: toolRes
                            });
                            replaceMessageText(thinkingId, `扫描失败：${toolRes?.error || 'unknown error'}\n可能原因：目标不可达 / 需要管理员权限运行 nmap / 后端未安装 nmap。`);
                            return;
                        }
                        const resultText = formatPortScanAssistantMessage(target, toolRes, data.duration);
                        addLog({
                            level: 'INFO',
                            status: 'SUCCESS',
                            service: 'task.exec',
                            path: 'web.task.summary:0',
                            message: `✅ 执行完成：1/1 成功 · 总耗时 ${(Number(data?.duration) || 0).toFixed(2)}s · 任务 nmap_quick`,
                            params: { tool: 'nmap_quick', target }
                        });
                        const actions = buildActionButtons([
                            { label: '深度扫描', variant: 'primary', onClick: () => { const input = document.getElementById('chatInput'); if (input) { input.value = `深度端口扫描：${target}`; autoResizeTextarea(input); input.focus(); } sendChat(); } },
                            { label: '自定义端口', variant: 'primary', onClick: () => { const input = document.getElementById('chatInput'); if (input) { input.value = `自定义端口扫描：${target} 端口:22,80,443`; autoResizeTextarea(input); input.focus(); } } },
                            { label: 'Web 漏洞扫描', variant: 'primary', onClick: () => { const input = document.getElementById('chatInput'); if (input) { input.value = `Web 漏洞扫描：${target}`; autoResizeTextarea(input); input.focus(); } sendChat(); } }
                        ]);
                        replaceMessageHtml(thinkingId, `<pre style="margin:0; white-space:pre-wrap;">${escapeHtml(resultText)}</pre>${actions}`);
                    } else {
                        replaceMessageText(thinkingId, `扫描失败：${data?.error || 'unknown error'}\n可能原因：目标不可达 / 需要管理员权限运行 nmap / 后端未安装 nmap。`);
                    }
                } catch (e) {
                    clearInterval(timer);
                    const msg2 = String(e?.message || '');
                    const friendly = /aborted|timeout/i.test(msg2) ? '扫描超时（可能目标网络不通或扫描耗时过长）' : `扫描请求失败：${msg2 || 'unknown error'}`;
                    replaceMessageText(thinkingId, `${friendly}\n建议：检查网络连通性与 MCP 服务状态。`);
                }
                return;
            }

            const cmdMatch = msg.match(/^\/([a-zA-Z0-9_-]+)\s*(.*)$/);
            if (cmdMatch) {
                const cmd = (cmdMatch[1] || '').toLowerCase();
                const rest = (cmdMatch[2] || '').trim();

                try {
                    if (cmd === 'tools') {
                        const data = await mcpRequestJson(MCP_ENDPOINTS.tools, { method: 'GET' });
                        replaceMessageText(thinkingId, JSON.stringify({
                            total: data?.total,
                            tools: (data?.tools || []).slice(0, 30).map(t => ({ name: t.name, category: t.category, description: t.description }))
                        }, null, 2));
                        return;
                    }

                    if (cmd === 'tool' || cmd === 'execute') {
                        const parts = rest.split(/\s+/);
                        const toolName = parts[0];
                        const jsonPart = rest.slice(toolName.length).trim();
                        let params = {};
                        if (jsonPart) {
                            try { params = JSON.parse(jsonPart); } catch (_) { params = {}; }
                        }
                        const data = await mcpRequestJson(MCP_ENDPOINTS.execute, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ tool: toolName, params, session_id: MCPUIState.sessionId })
                        });
                        replaceMessageText(thinkingId, JSON.stringify(data, null, 2));
                        return;
                    }

                    if (cmd === 'analyze') {
                        const target = rest || msg;
                        const data = await mcpRequestJson(MCP_ENDPOINTS.aiAnalyze, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ target, context: { session_id: MCPUIState.sessionId } })
                        });
                        replaceMessageText(thinkingId, JSON.stringify(data, null, 2));
                        return;
                    }

                    if (cmd === 'plan') {
                        const target = rest || '';
                        const data = await mcpRequestJson(MCP_ENDPOINTS.aiPlan, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ target, recon_data: {} })
                        });
                        replaceMessageText(thinkingId, JSON.stringify(data, null, 2));
                        return;
                    }

                    if (cmd === 'workflow') {
                        const parts = rest.split(/\s+/);
                        const target = parts[0] || '';
                        const jsonPart = rest.slice(target.length).trim();
                        let options = {};
                        if (jsonPart) {
                            try { options = JSON.parse(jsonPart); } catch (_) { options = {}; }
                        }
                        const data = await mcpRequestJson(MCP_ENDPOINTS.workflowAuto, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ target, options })
                        });
                        if (data?.session_id) MCPUIState.sessionId = data.session_id;
                        replaceMessageText(thinkingId, JSON.stringify(data, null, 2));
                        return;
                    }

                    if (cmd === 'report') {
                        const parts = rest.split(/\s+/);
                        const sessionId = parts[0] || MCPUIState.sessionId || '';
                        const format = parts[1] || 'html';
                        const data = await mcpRequestJson(MCP_ENDPOINTS.reportGenerate, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ session_id: sessionId, format })
                        });
                        replaceMessageText(thinkingId, JSON.stringify(data, null, 2));
                        return;
                    }

                    replaceMessageText(thinkingId, `未知命令: /${cmd}`);
                    return;
                } catch (e) {
                    replaceMessageText(thinkingId, `命令执行失败: ${e?.message || 'unknown error'}`);
                    return;
                }
            }

            if (vulnIntent && vulnIntent.intent === 'web_vuln') {
                const target = vulnIntent.target;
                if (!target) {
                    replaceMessageText(thinkingId, '未识别到扫描目标，请补充域名或 URL。');
                    return;
                }
                tools = ['nuclei_scan'];
                MCPUIState.selectedTools = new Set(tools);
                renderSelectedTools();
                replaceMessageText(thinkingId, `已识别 Web 漏洞扫描请求，默认使用 nuclei_scan。\n目标：${target}\n执行中…`);
            }

            if (vulnIntent && vulnIntent.intent === 'sqlmap' && tools.length === 0) {
                const target = vulnIntent.target;
                const html = `检测到 SQL 注入测试意图（sqlmap）。该操作具有侵入性，仅能在已获授权范围内执行。\n目标：${escapeHtml(target || '-')}\n` +
                    `${buildActionButtons([
                        { label: '继续执行 sqlmap', variant: 'danger', onClick: () => { const input = document.getElementById('chatInput'); if (input) { input.value = `sqlmap 注入测试：${target}`; autoResizeTextarea(input); input.focus(); } MCPUIState.selectedTools = new Set(['sqlmap']); renderSelectedTools(); sendChat(); } },
                        { label: '取消', variant: 'primary', onClick: () => replaceMessageText(thinkingId, '已取消') }
                    ])}`;
                replaceMessageHtml(thinkingId, html.replace(/\n/g, '<br/>'));
                return;
            }

            const consented = /已获授权|授权|允许|我确认|确认执行|已确认/.test(msg);
            if (tools.includes('sqlmap') && !consented) {
                const target = extractTargetFromText(msg);
                const html = `你已选择 sqlmap，这属于敏感操作。请确认已获得授权后继续。\n目标：${escapeHtml(target || '-')}\n` +
                    `${buildActionButtons([
                        { label: '我已获授权，继续', variant: 'danger', onClick: () => { const input = document.getElementById('chatInput'); if (input) { input.value = `${msg}（已获授权）`; autoResizeTextarea(input); input.focus(); } sendChat(); } },
                        { label: '取消', variant: 'primary', onClick: () => replaceMessageText(thinkingId, '已取消') }
                    ])}`;
                replaceMessageHtml(thinkingId, html.replace(/\n/g, '<br/>'));
                return;
            }

            let serverMessage = msg;
            if (tools.includes('sqlmap')) {
                const target = extractTargetFromText(msg);
                if (!target || (!target.startsWith('http://') && !target.startsWith('https://'))) {
                    replaceMessageText(thinkingId, 'sqlmap 需要一个 URL 作为目标，例如：https://example.com/page?id=1');
                    return;
                }
                try {
                    serverMessage += `\n${JSON.stringify({ tool_params: { sqlmap: { target } } })}`;
                } catch (_) {}
            }

            const execStarted = performance.now();
            let heartbeatCount = 0;
            const execEstimate = Math.max(8, Math.min(60, tools.length * 12));
            const tick = () => {
                const sec = (performance.now() - execStarted) / 1000;
                const pct = Math.min(99, Math.max(1, Math.floor((sec / execEstimate) * 100)));
                const hb = Math.floor(sec / 30);
                if (hb > heartbeatCount) heartbeatCount = hb;
                const hbLine = hb > 0 ? `\n心跳：已完成约 ${pct}%` : '';
                const toolLine = tools.length ? `模块：${tools.join(', ')}` : '未选择模块：使用 AI 分析';
                replaceMessageText(thinkingId, `已接收任务，正在执行…\n${toolLine}\n进度：${pct}% · ${sec.toFixed(1)}s${hbLine}`);
            };
            const tickTimer = setInterval(tick, 1000);
            tick();

            const payload = {
                message: serverMessage,
                tools,
                context: {
                    page: 'aibug/ai-chat.html',
                    session_id: MCPUIState.sessionId,
                    ts: Date.now()
                }
            };

            try {
                const data = await mcpRequestJson(MCP_ENDPOINTS.chat, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                clearInterval(tickTimer);

                if (data && typeof data.session_id === 'string') {
                    MCPUIState.sessionId = data.session_id;
                    const sessionChip = document.getElementById('chatSessionChip');
                    if (sessionChip) sessionChip.textContent = `SESSION ${data.session_id}`;
                }

                if (Array.isArray(data?.results) && data.results.length > 0) {
                    const total = data.results.length;
                    const ok = data.results.filter(r => r.success).length;
                    
                    // 使用可视化格式化函数构建结果
                    let detailHtml = `
                        <div class="step-guide">
                            <div class="step-item done">
                                <div class="step-circle">✓</div>
                                <div class="step-label">选择工具</div>
                            </div>
                            <div class="step-item done">
                                <div class="step-circle">✓</div>
                                <div class="step-label">输入目标</div>
                            </div>
                            <div class="step-item done">
                                <div class="step-circle">✓</div>
                                <div class="step-label">执行扫描</div>
                            </div>
                            <div class="step-item ${ok === total ? 'done' : 'active'}">
                                <div class="step-circle">${ok === total ? '✓' : '4'}</div>
                                <div class="step-label">查看结果</div>
                            </div>
                        </div>
                    `;
                    
                    // 对每个工具结果进行可视化格式化
                    data.results.forEach(r => {
                        if (r.success && r.result) {
                            // 使用可视化格式化
                            detailHtml += formatScanResultViz(r.tool, r.result, r.result);
                        } else if (r.error) {
                            // 错误结果展示
                            detailHtml += `
                                <div class="scan-result-card" style="border-color:rgba(239,68,68,0.3);">
                                    <div class="scan-target-header">
                                        <div class="scan-target-icon" style="background:linear-gradient(135deg,rgba(239,68,68,0.15),rgba(245,158,11,0.15));">❌</div>
                                        <div class="scan-target-info">
                                            <div class="scan-target-name">执行失败：${escapeHtml(r.tool)}</div>
                                            <div class="scan-target-type">耗时 ${typeof r.duration === 'number' ? r.duration.toFixed(2) + 's' : '-'}</div>
                                        </div>
                                        <div class="security-badge risk-high">❌ 失败</div>
                                    </div>
                                    <div class="scan-summary" style="background:rgba(239,68,68,0.08);">
                                        <strong>错误信息：</strong>${escapeHtml(String(r.error))}
                                    </div>
                                    <div class="suggestion-section">
                                        <div class="suggestion-title">💡 可能的解决方案</div>
                                        <div class="suggestion-list">
                                            <div class="suggestion-item"><span class="suggestion-num">1</span><span>检查目标地址是否正确、可达</span></div>
                                            <div class="suggestion-item"><span class="suggestion-num">2</span><span>确认后端工具已正确安装</span></div>
                                            <div class="suggestion-item"><span class="suggestion-num">3</span><span>查看右侧日志获取更多详情</span></div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                    });
                    
                    // 添加执行摘要
                    detailHtml += `
                        <div style="margin-top:16px;padding:14px;background:rgba(241,245,249,0.6);border-radius:10px;font-size:12px;color:#475569;">
                            ${ok === total ? '✅' : '⚠️'} <strong>执行完成</strong>：${ok}/${total} 成功 · 总耗时 ${typeof data.duration === 'number' ? data.duration.toFixed(2) + 's' : '-'}
                        </div>
                    `;

                    addLog({
                        level: ok === total ? 'INFO' : 'ERROR',
                        status: ok === total ? 'SUCCESS' : 'ERROR',
                        service: 'task.exec',
                        path: 'web.task.summary:0',
                        message: `${ok === total ? '✅' : '❌'} 执行完成：${ok}/${total} 成功 · 总耗时 ${typeof data.duration === 'number' ? data.duration.toFixed(2) + 's' : '-'} · 任务 ${tools.join(', ') || '-'}`,
                        params: { tools, session_id: data.session_id },
                        response: data.results
                    });

                    replaceMessageHtml(thinkingId, detailHtml);
                } else {
                    replaceMessageText(thinkingId, typeof data?.response === 'string' ? data.response : JSON.stringify(data?.response || data, null, 2));
                }
            } catch (e) {
                clearInterval(tickTimer);
                replaceMessageText(thinkingId, `未连接到 MCP 服务：${e?.message || 'unknown error'}。你可以继续编辑页面对接接口。`);
            }
        }

        function bindUIEvents() {
            const input = document.getElementById('chatInput');
            const sendBtn = document.getElementById('chatSendBtn');
            const chatMessages = document.getElementById('chatMessages');

            if (input) {
                input.addEventListener('input', () => autoResizeTextarea(input));
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendChat();
                    }
                });
            }

            if (sendBtn) {
                sendBtn.addEventListener('click', () => sendChat());
            }

            if (chatMessages) {
                chatMessages.addEventListener('click', (e) => {
                    const btn = e.target?.closest?.('button[data-action-id]');
                    if (!btn) return;
                    const id = btn.getAttribute('data-action-id');
                    if (!id) return;
                    const handler = MCPActionState.handlers.get(id);
                    if (typeof handler === 'function') {
                        try { handler(); } finally { MCPActionState.handlers.delete(id); }
                    }
                });
            }

            document.querySelectorAll('.action-btn[data-mcp-tool]').forEach(btn => {
                const toolName = btn.getAttribute('data-mcp-tool');
                if (!toolName) return;
                btn.setAttribute('aria-pressed', 'false');
                btn.addEventListener('click', () => toggleToolSelection(toolName));
            });

            document.querySelectorAll('.quick-hint[data-quick]').forEach(el => {
                el.addEventListener('click', () => {
                    const text = el.getAttribute('data-quick') || '';
                    if (!input) return;
                    input.value = text;
                    autoResizeTextarea(input);
                    input.focus();
                });
            });
            
            // 快捷工具按钮事件
            document.querySelectorAll('.quick-tool-btn[data-mcp-tool]').forEach(btn => {
                const toolName = btn.getAttribute('data-mcp-tool');
                if (!toolName) return;
                btn.addEventListener('click', () => {
                    toggleToolSelection(toolName);
                    // 同步更新快捷按钮状态
                    updateQuickToolButtons();
                });
            });
        }
        
        // 切换分类折叠状态
        function toggleActionGroup(btn) {
            const group = btn.closest('.action-group');
            if (group) {
                group.classList.toggle('collapsed');
            }
        }
        
        // 更新快捷工具按钮状态
        function updateQuickToolButtons() {
            document.querySelectorAll('.quick-tool-btn[data-mcp-tool]').forEach(btn => {
                const toolName = btn.getAttribute('data-mcp-tool');
                if (MCPUIState.selectedTools.has(toolName)) {
                    btn.classList.add('selected');
                } else {
                    btn.classList.remove('selected');
                }
            });
        }
        
        // 扩展 toggleToolSelection 以同步快捷按钮状态
        const _originalToggleToolSelection = typeof toggleToolSelection === 'function' ? toggleToolSelection : null;

        document.addEventListener('DOMContentLoaded', async () => {
            await XHLayout.initLayout({
                navbar: { basePath: '../' },
                floatingNav: false
            });

            syncMessageTimes();
            initLogPanel();
            renderSelectedTools();
            bindUIEvents();
            initUiStatusLogFile();
            checkMcpServerStatus();
            startEventStream();
            loadTools();

            const search = document.getElementById('mcpToolSearch');
            if (search) {
                search.addEventListener('input', () => renderAllToolsGrid(search.value || ''));
            }
            const refreshBtn = document.getElementById('refreshToolsBtn');
            if (refreshBtn) refreshBtn.addEventListener('click', () => loadTools());

            setInterval(checkMcpServerStatus, 12000);
        });

        window.MCPChatUI = {
            getSelectedTools: () => Array.from(MCPUIState.selectedTools),
            setSelectedTools: (tools) => {
                MCPUIState.selectedTools = new Set(Array.isArray(tools) ? tools : []);
                renderSelectedTools();
            },
            send: sendChat
        };
    </script>
</body>
</html>
