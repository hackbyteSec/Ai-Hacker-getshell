# ============================================
# MCP AI Red Team - Nginx配置文件
# 路径: /www/server/panel/vhost/nginx/mcp-redteam.conf
# ============================================

server {
    listen 80;
    listen [::]:80;
    
    # 修改为你的域名或IP
    server_name mcp.yourdomain.com;
    
    # 根目录 - 静态文件
    root /www/wwwroot/mcp-redteam;
    index test-tools.html index.html;
    
    # 字符编码
    charset utf-8;
    
    # 客户端请求体大小限制
    client_max_body_size 100M;
    
    # 访问日志
    access_log /www/wwwlogs/mcp-redteam.access.log;
    error_log /www/wwwlogs/mcp-redteam.error.log;
    
    # ============================================
    # 静态文件处理
    # ============================================
    location / {
        try_files $uri $uri/ =404;
        
        # 缓存静态资源
        location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 7d;
            add_header Cache-Control "public, immutable";
        }
        
        # HTML文件不缓存
        location ~* \.html$ {
            expires -1;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
        }
    }
    
    # ============================================
    # MCP API 代理 (核心接口)
    # ============================================
    
    # 健康检查
    location = /health {
        proxy_pass http://127.0.0.1:5000/health;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
    
    # 工具列表
    location /tools {
        proxy_pass http://127.0.0.1:5000/tools;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # 工具执行 (POST)
    location = /execute {
        proxy_pass http://127.0.0.1:5000/execute;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Content-Type $content_type;
        
        # 超时设置 (安全工具执行可能需要较长时间)
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;
        proxy_read_timeout 600s;
        
        # 禁用缓冲
        proxy_buffering off;
    }
    
    # 聊天接口
    location = /chat {
        proxy_pass http://127.0.0.1:5000/chat;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Content-Type $content_type;
        
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;
        proxy_read_timeout 600s;
        proxy_buffering off;
    }
    
    # SSE 事件流 (Server-Sent Events)
    location = /events {
        proxy_pass http://127.0.0.1:5000/events;
        proxy_http_version 1.1;
        
        # SSE 必需配置
        proxy_set_header Connection "";
        proxy_set_header Cache-Control "no-cache";
        proxy_set_header X-Accel-Buffering "no";
        
        # 禁用所有缓冲
        proxy_buffering off;
        proxy_cache off;
        chunked_transfer_encoding off;
        
        # 长连接超时
        proxy_read_timeout 86400s;
        keepalive_timeout 86400s;
    }
    
    # 日志接口
    location /logs {
        proxy_pass http://127.0.0.1:5000/logs;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
    
    # 会话管理
    location /session {
        proxy_pass http://127.0.0.1:5000/session;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    # 攻击链
    location /chain {
        proxy_pass http://127.0.0.1:5000/chain;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_connect_timeout 60s;
        proxy_read_timeout 600s;
    }
    
    # 工作流
    location /workflow {
        proxy_pass http://127.0.0.1:5000/workflow;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_connect_timeout 60s;
        proxy_read_timeout 600s;
    }
    
    # AI接口
    location /ai {
        proxy_pass http://127.0.0.1:5000/ai;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_connect_timeout 60s;
        proxy_read_timeout 120s;
    }
    
    # 报告生成
    location /report {
        proxy_pass http://127.0.0.1:5000/report;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
    
    # ============================================
    # 安全配置
    # ============================================
    
    # 禁止访问隐藏文件
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # 禁止访问Python文件
    location ~* \.py$ {
        deny all;
    }
    
    # 禁止访问配置文件
    location ~* \.(yaml|yml|ini|conf|cfg)$ {
        deny all;
    }
    
    # 禁止访问日志目录
    location /logs/ {
        deny all;
    }
    
    # 禁止访问__pycache__
    location ~* __pycache__ {
        deny all;
    }
}

# ============================================
# HTTPS配置 (可选 - 使用宝塔申请SSL证书后启用)
# ============================================
# server {
#     listen 443 ssl http2;
#     listen [::]:443 ssl http2;
#     
#     server_name mcp.yourdomain.com;
#     
#     ssl_certificate /www/server/panel/vhost/cert/mcp.yourdomain.com/fullchain.pem;
#     ssl_certificate_key /www/server/panel/vhost/cert/mcp.yourdomain.com/privkey.pem;
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
#     ssl_prefer_server_ciphers off;
#     
#     # ... 其他配置同上 ...
# }
# 
# # HTTP 重定向到 HTTPS
# server {
#     listen 80;
#     server_name mcp.yourdomain.com;
#     return 301 https://$server_name$request_uri;
# }
